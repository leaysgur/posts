{
  "title": "いわゆるSPAでGoogleAnalyticsを使う",
  "html": "<p>日本語の記事引っかからなさすぎてちょっとひいた！<br />\nみんな知ってて当たり前ってだけ？</p><p>いわゆる最近のanalytics.jsってやつの話です。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>気になってたポイント</h3>\n    \n<ul>\n<li>何がどうなったらトラックされたことになってるか</li>\n<li># のルートをどうトラックするか</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h3>仕組み</h3>\n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synComment\">// お決まりのトラッキングコードを仕込んでから</span>\nga(<span class=\"synConstant\">'send'</span>, <span class=\"synConstant\">'pageview'</span>);\n</pre><p>ってするとビーコンのリクエストが発生する。<br />\nで、<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Cookie\">Cookie</a>にいろいろつけた情報と一緒にサーバーに飛んで行く。</p><p>どうやら1pxの<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/gif\">gif</a>を投げてるので、DeveloperTools -> Network -> Imagesで見れたりする。<br />\nまぁ、以下の拡張いれたほうがわかりやすいし早いのでオススメです。</p>\n\n    <blockquote>\n        <p><a href=\"https://chrome.google.com/webstore/detail/google-analytics-debugger/jnkmfdileelhofjcijamephohjechhna\">Google Analytics Debugger - Chrome Web Store</a></p>\n\n    </blockquote>\n\n</div>\n<div class=\"section\">\n    <h3>#!/</h3>\n    <p>なんしかよしなにやってくれるんかと思いきや、そんな甘い話はどこにもなく・・。</p><p>hashchangeで上述の通りサーバーにデータ投げないとダメです。<br />\nいわゆるpageviewとしてカウントしたいタイミングで、それのリクエストを投げるってのが鉄則。</p><p>注意点はもうひとつあって、デフォルトでサーバーに送られるのは、</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synIdentifier\">var</span> <span class=\"synStatement\">location</span> = <span class=\"synStatement\">window</span>.<span class=\"synStatement\">location</span>.protocol +\n    <span class=\"synConstant\">'//'</span> + <span class=\"synStatement\">window</span>.<span class=\"synStatement\">location</span>.hostname +\n    <span class=\"synStatement\">window</span>.<span class=\"synStatement\">location</span>.pathname +\n    <span class=\"synStatement\">window</span>.<span class=\"synStatement\">location</span>.search;\n</pre><p>という値になるので、hash以下がつきません。<br />\nなので、</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synComment\">// ページのロードで1回</span>\nga(<span class=\"synConstant\">'send'</span>, <span class=\"synConstant\">'pageview'</span>, (<span class=\"synStatement\">location</span>.pathname + <span class=\"synStatement\">location</span>.search  + <span class=\"synStatement\">location</span>.hash));\n\n<span class=\"synComment\">// その後、ページ内で遷移したら飛ばす</span>\n<span class=\"synStatement\">window</span>.addEventListener(<span class=\"synConstant\">'hashchange'</span>, <span class=\"synIdentifier\">function</span>() <span class=\"synIdentifier\">{</span>\n  ga(<span class=\"synConstant\">'send'</span>, <span class=\"synConstant\">'pageview'</span>, (<span class=\"synStatement\">location</span>.pathname + <span class=\"synStatement\">location</span>.search  + <span class=\"synStatement\">location</span>.hash));\n<span class=\"synIdentifier\">}</span>);\n\n<span class=\"synComment\">// もちろん最初に</span>\n<span class=\"synComment\">// ga('set', 'page', (location.pathname + location.search  + location.hash)); しておいて</span>\n<span class=\"synComment\">// ga('send', 'pageview'); でもおｋなはず</span>\n</pre><p>ってな具合にデフォルトを上書きして送信しなきゃダメ。</p>\n\n</div>\n<div class=\"section\">\n    <h3>そのほか</h3>\n    <p>データの更新頻度はなんと、</p>\n\n<ul>\n<li>プレミアムは4時間ごと</li>\n<li>無料版はなんと24時間以上n時間ごと</li>\n</ul><p>130万/月も払えない平民といたしましては、<br />\n適当にデータとっといて、後から頑張ってフィルタする方が精神衛生上よさそうという結論に達しました。</p>\n\n    <blockquote>\n        <p><a href=\"http://www.google.co.jp/intl/ja_ALL/analytics/premium/features.html\">Google &#x30A2;&#x30CA;&#x30EA;&#x30C6;&#x30A3;&#x30AF;&#x30B9; &#x30D7;&#x30EC;&#x30DF;&#x30A2;&#x30E0;&#x306E;&#x6A5F;&#x80FD;&#x4E00;&#x89A7; &ndash; Google &#x30A2;&#x30CA;&#x30EA;&#x30C6;&#x30A3;&#x30AF;&#x30B9;</a></p>\n\n    </blockquote>\n\n</div>"
}
