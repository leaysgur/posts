{
  "title": "enchant.jsのRPGに、動くだけのNPCを追加する",
  "html": "<p><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/JavaScript\">JavaScript</a>の勉強に大変良いということで、最近触り始めました。<br />\nRPG風のサンプルが、ドラクエやら<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%DD%A5%B1%A5%E2%A5%F3\">ポケモン</a>やらを彷彿とさせてとっても楽しい！ｗ</p><p>サンプルだと主人公は自分だけ。<br />\nキャラ絵は3種類あるみたいなので、登場させちゃおうかと。</p>\n\n<div class=\"seemore\">\n    \n<div class=\"section\">\n    <h3>簡単な手順</h3>\n    \n<ol>\n<li>新しいキャラを作る。</li>\n<li>ランダムで動くように設定する。</li>\n</ol>\n</div>\n<div class=\"section\">\n    <h3>ソース</h3>\n    \n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>// game.onload() = function(){ 以下\n        var npc = new Sprite(32, 32);\n        npc.x = 3 * 16 - 8;\n        npc.y = 3 * 16;\n        var npc_img = new Surface(96, 128);\n        npc_img.draw(game.assets[&#39;chara0.gif&#39;], 192, 0, 96, 128, 0, 0, 96, 128);\n        npc.image = npc_img;\n        npc.isMoving = false;\n        npc.direction = 0;\n        npc.walk = 1;\n\n        npc.addEventListener(&#39;enterframe&#39;, function() {\n        \tthis.frame = this.direction * 3 + this.walk;\n            if (this.isMoving) {\n                this.moveBy(this.vx, this.vy);\n \n                if (!(game.frame % 3)) {\n                    this.walk++;\n                    this.walk %= 3;\n                }\n                if ((this.vx &amp;&amp; (this.x-8) % 16 == 0) || (this.vy &amp;&amp; this.y % 16 == 0)) {\n                    this.isMoving = false;\n                    this.walk = 1;\n                }\n            } else {\n\t\tvar dir = Math.floor(Math.random()*4+1);\n\t\tvar move = Math.floor(Math.random()*10); \n                this.vx = this.vy = 0;\n                if (dir == 4 &amp;&amp; !move) {\n                    this.direction = 1;\n                    this.vx = -4;\n                } else if (dir == 2 &amp;&amp; !move) {\n                    this.direction = 2;\n                    this.vx = 4;\n                } else if (dir == 1 &amp;&amp; !move) {\n                    this.direction = 3;\n                    this.vy = -4;\n                } else if (dir == 3 &amp;&amp; !move) {\n                    this.direction = 0;\n                    this.vy = 4;\n                }\n                if (this.vx || this.vy) {\n                    var x = this.x + (this.vx ? this.vx / Math.abs(this.vx) * 16 : 0) + 16;\n                    var y = this.y + (this.vy ? this.vy / Math.abs(this.vy) * 16 : 0) + 16;\n                    if (0 &lt;= x &amp;&amp; x &lt; map.width &amp;&amp; 0 &lt;= y &amp;&amp; y &lt; map.height &amp;&amp; !map.hitTest(x, y)) {\n                        this.isMoving = true;\n                        arguments.callee.call(this);\n                    }\n                }\n            }\n\n        });\n        stage.addChild(npc);</pre>\n<p>当然ですが、難しいことはしてません。<br />\nでも、できた！←重要</p>\n\n<div class=\"section\">\n    <h4>キャラ絵を変える</h4>\n    \n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>npc_img.draw(game.assets[&#39;chara0.gif&#39;], 192, 0, 96, 128, 0, 0, 96, 128);\n// 最初の値を、0か96か192で切り替え</pre>\n<p>0なら男の子、96ならショートの女の子、192だとリボンの女の子です。</p>\n\n</div>\n<div class=\"section\">\n    <h4>動かす</h4>\n    \n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>var dir = Math.floor(Math.random()*4+1);\n// サンプルコードは矢印キーか、アナログパッドの入力。\n// ランダムで動く方向(上下左右の4方向)を、乱数で決めます。\n\nvar move = Math.floor(Math.random()*10); \nif (dir == 4 &amp;&amp; !move) {\n} else if( //　・・・\n// enterframeイベントにくっつけて動かします。\n// このイベントはほぼ起きっぱなしなので、10回に1回動くようにしてます。\n// それでもNPCにしては動きすぎなイメージｗ</pre>\n<p>hitTest関数も既存のままなので、障害物は乗り越えません。</p>\n\n</div>\n<div class=\"section\">\n    <h4>プレイヤーと重ならないように</h4>\n    <p>しようと思ったのですが、ここがイマイチわかりません・・。<br />\nできた方はぜひ教えてください。</p>\n\n    <blockquote>\n        <p>正確には、ほぼできたけど、完璧にはできなかったです。<br />\nプレイヤーが移動する時に、移動先にNPCがいればキャンセルするようにしました。<br />\nただ、NPCの移動のタイミングと被ると、重なる場合やらすり抜ける場合があったりやら。<br />\nintersect()もwithin()も使ってません。</p>\n\n    </blockquote>\n\n</div>\n</div>\n</div>"
}
