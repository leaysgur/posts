{
  "title": "Nginxで特定のURLだけNodeにプロキシするには",
  "html": "<p>久しぶりすぎてNginxの設定の書き方がまったく思い出せない・・。</p><p>題名通りです。<br />\n全部Nodeでやってもいいんですけど、それはそれで何かと面倒なのでこうするのに落ち着いてます。</p><p>静的ファイルは今まで通り<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Apache\">Apache</a>やらNginxで、動的なものをプロキシして・・っていうのがやっぱセオリー感あります。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>設定</h3>\n    <pre class=\"code lang-nginx\" data-lang=\"nginx\" data-unlink><span class=\"synComment\">#####################################</span>\n<span class=\"synComment\"># hoge.example.com conf.</span>\n<span class=\"synComment\">#####################################</span>\n<span class=\"synComment\"># Nodeが動いてるサーバーとポート</span>\n<span class=\"synStatement\">upstream</span> hogeNodeServer {\n    <span class=\"synType\">server</span> 127.0.0.1:3000;\n}\n\n<span class=\"synComment\"># http://hoge.example.com/api/ 以降はNodeに流すが、</span>\n<span class=\"synComment\"># それ以外はNginxで返す！</span>\n<span class=\"synType\">server</span> {\n    <span class=\"synType\">listen</span>  80;\n    <span class=\"synType\">server_name</span> hoge.example.com;\n    <span class=\"synIdentifier\">access_log</span>  /var/www/hoge/logs/access.log;\n    <span class=\"synIdentifier\">error_log</span>   /var/www/hoge/logs/error.log;\n\n<span class=\"synComment\">    # 末尾に / をつけ忘れると、/api しか判定されないので注意！！</span>\n    <span class=\"synStatement\">location</span> /api/ {\n        <span class=\"synType\">proxy_pass</span> http://hogeNodeServer/;\n    }\n\n<span class=\"synComment\">    # あとはいつも通り</span>\n    <span class=\"synStatement\">location</span> / {\n        <span class=\"synType\">root</span> /var/www/hoge/public;\n        <span class=\"synIdentifier\">index</span> index.html;\n        <span class=\"synStatement\">break</span>;\n    }\n}\n</pre><p>`upstream`で流すところが重要。<br />\n`proxy_pass`でそのまま流そうとすると、`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/curl\">curl</a>`とかでサーバー内で確認する分には動いてるように見えるけど実際にブラウザから叩くとうまくいかなかった。</p><p>あとはNodeのアプリで適当にこんなん用意すればいいはず。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synComment\">// ...</span>\n<span class=\"synComment\">// http://hoge.example.com/api/ のとき</span>\napp.get(<span class=\"synConstant\">'/'</span>, index);\n<span class=\"synComment\">// http://hoge.example.com/api/entry のとき</span>\napp.get(<span class=\"synConstant\">'/entry'</span>, entry);\n\n<span class=\"synComment\">// ...</span>\n</pre><p>以上！</p>\n\n</div>"
}
