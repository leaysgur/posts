---
title: "å‹•çš„ã«`Access-Control-Allow-Origin`ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã™ã‚‹å ´åˆã¯ã€`Vary: Origin`ã‚‚å¿˜ã‚Œãšã«"
---

ã‚¿ã‚¤ãƒˆãƒ«é€šã‚Šã§ã¯ã‚ã‚‹ã‘ã©ã€çµæ§‹ã€Œï¼Ÿã€ãŒã„ã£ã±ã„ã«ãªã£ãŸå‡ºæ¥äº‹ã ã£ãŸã®ã§ã€‚

## ã“ã¨ã®ã‚ã‚‰ã¾ã—

- ã¨ã‚ã‚‹é™çš„ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã™ã‚‹APIãŒã‚ã£ãŸ
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®`Origin`ã‚’è¦‹ã¦ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ã¦ã„ãŸ
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã™ã‚‹å ´åˆã¯ã€`Access-Control-Allow-Origin`ã«`Origin`å€¤ã‚’æŒ‡å®š

ã¨ã„ã†æ§‹æˆã€‚

ç°¡å˜ãªã‚³ãƒ¼ãƒ‰ã§æ›¸ãã¨ã“ã®ã‚ˆã†ãªã€‚


```js
const originHeader = req.headers.get("origin");

if (!canAccess(originHeader))
  return new Response("Not Found", { status: 404 });

return new Response(getAssets(), {
  status: 200,
  headers: {
    "Access-Control-Allow-Origin": originHeader,
  },
})
```

ã“ã‚Œã ã‘è¦‹ã‚‹ã¨ã€`*`ã§è‰¯ãã‚‚è¦‹ãˆã‚‹ãŒã€ã¾ã‚ã€‚

## å•é¡Œã«ãªã‚‹ã¨ã

- Chromeã§ã‚¢ã‚¯ã‚»ã‚¹
- è¤‡æ•°ã®ã‚µã‚¤ãƒˆã‹ã‚‰ã€åŒã˜ãƒªã‚½ãƒ¼ã‚¹ã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

ã—ãŸã¨ãã«ã€å¾Œã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ–¹ãŒCORSã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

ç‰¹å®šã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ã€`localhost:8080`ã¨`localhost:8081`ã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸã¨ãã«ã€ã“ã†ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

```
Access to CSS stylesheet at '(XXX)' from origin 'http://localhost:8080' has been blocked by CORS policy:
 The 'Access-Control-Allow-Origin' header has a value 'http://localhost:8081' that is not equal to the supplied origin.
```

`(XXX)`ã®ã¨ã“ã‚ãŒå¯¾è±¡ã®ãƒªã‚½ãƒ¼ã‚¹ã€‚

ç«¯çš„ã«å—ã‘å–ã‚‹ã¨ã€æœ¬æ¥`localhost:8080`å‘ã‘ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã€ãªãœã‹`localhost:8081`ã§è¿”ã£ã¦ã‚‹ãƒ»ãƒ»ãƒ»ï¼Ÿã£ã¦ãªã‚‹ã€‚

ãã—ã¦ã“ã‚ŒãŒã€Chromeã§ã ã‘ç™ºç”Ÿã—ã€Firefoxã‚„Safariã§ã¯ã€å°‘ãªãã¨ã‚‚æ‰‹å…ƒã§ã¯å†ç¾ã—ãªã‹ã£ãŸã€‚ï¼ˆãªã‚“ãªã‚‰Chromeã§ã‚‚å†ç¾ã—ãŸã‚Šã—ãªã‹ã£ãŸã‚Šã ã£ãŸï¼‰

DevToolsã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã¨å†ç¾ã—ãªã‹ã£ãŸã‚Šã¨ã€ã¾ã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥é–¢é€£ã®ãã†ã„ã†è©±ãªã‚“ã‚„ã‚ã†ã€‚

## CORS-preflight cache

ãªã‚“ã‚„ã‹ã‚“ã‚„èª¿ã¹ã¦ãŸã©ã‚Šç€ã„ãŸã®ãŒã“ã‚Œã€‚

> CORS Preflight Cache Does not Consider Origin [41025985] - Chromium
> https://issues.chromium.org/issues/41025985

ã§ã€ã“ã‚Œã¯ãƒã‚°ã§ã¯ãªãä»•æ§˜ã¨ã„ã†ã“ã¨ã‚‰ã—ãã€

> The Fetch Standard recently added more explanation about preflight result caching.
> Basically you need to either:
> - always include "Access-Control-Allow-Origin: *" for a resource that can be accessed using CORS
> - add the Vary header not to get responses cached and reused for requests from other origins.

ã¨ã„ã†ã‚ã‘ã§ã€å‹•çš„ã«ã‚„ã‚‹ãªã‚‰`Vary`ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ã‘ãªã•ã„ã£ã¦ã“ã¨ã‚‰ã—ã„ã€‚

> Fetch Standard
> https://fetch.spec.whatwg.org/#cors-protocol-and-http-caches

## ãã†ã„ã†ã‚ã‘ã§

```js
const originHeader = req.headers.get("origin");

if (!canAccess(originHeader))
  return new Response("Not Found", { status: 404 });

return new Response(getAssets(), {
  status: 200,
  headers: {
    "Access-Control-Allow-Origin": originHeader,
    "Vary": "Origin", // ğŸ‘ˆğŸ»
  },
})
```

ã¨ã™ã‚Œã°å®‰å¿ƒã€‚ã‚‚ã—ãã¯ã€`"Access-Control-Allow-Origin": "*"`ã ã‘ã«ã™ã‚‹ã‹ã€‚

ã¾ã‚ä»Šæ”¹ã‚ã¦è¦‹ã‚‹ã¨ã€ã¡ã‚ƒã‚“ã¨`Vary`ä»˜ã‘ãªã„ã¨ã‚ã‹ã‚“ã‚„ã¤ã‚„ã‚“ã£ã¦æ€ã†ã‘ã©ãƒ»ãƒ»ã€‚
