{
  "title": "Cloudflare WorkersのCron Triggerで、サブリクエスト数制限と戦う",
  "html": "<p>プランによっても変わるけど、Workersには制限がいろいろある。</p>\n\n<ul>\n<li>デプロイできるコードのサイズ</li>\n<li>実行CPU時間</li>\n<li>etc...</li>\n</ul>\n    <blockquote>\n        <p><a href=\"https://developers.cloudflare.com/workers/platform/limits\">https://developers.cloudflare.com/workers/platform/limits</a></p>\n\n    </blockquote>\n<p>先日の発表で、そのあたりの一部が緩和されるという話があって、またひとつ使いやすいFaaSになったはず。</p>\n\n    <blockquote>\n        <p><a href=\"https://blog.cloudflare.com/workers-now-even-more-unbound/\">Workers, Now Even More Unbound: 15 Minutes, 100 Scripts, and No Egress Fees</a></p>\n\n    </blockquote>\n<p>ただそんな流れの中でも、相変わらず鎮座してる制限がありまして・・。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>サブリクエスト数の制限</h3>\n    <p>サブリクエストとは、Workerの処理中に発行された外部リソースへのリクエストのこと。端的にいえば`fetch()`できる回数に制限がある。</p>\n\n    <blockquote>\n        <p><a href=\"https://developers.cloudflare.com/workers/platform/limits#subrequests\">https://developers.cloudflare.com/workers/platform/limits#subrequests</a></p>\n\n    </blockquote>\n<p>現状、最大で50回までのサブリクエストが可能で、リダイレクトもカウントされるとのこと。</p>\n\n</div>\n<div class=\"section\">\n    <h3>もともとやりたかったこと</h3>\n    \n<ul>\n<li>バッチ処理として定時で実行されるスクリプト</li>\n<li>たとえば100件の取引先に対して、それぞれAPIを叩いていく</li>\n</ul><p>というような、バッチ処理あるあるな内容。</p><p>これをCloudflare Workersでやる場合、このサブリクエスト数の制限が問題になる。</p><p>1度の呼び出しで「100件それぞれに対してAPIを叩く」っていうのが、そもそも実現できない。50件に収められるならいいけど、まあ基本的には無理。</p><p>ならばどうする？っていう話。</p>\n\n</div>\n<div class=\"section\">\n    <h3>Cron Triggerの定義を変える</h3>\n    <p>Workerを1回呼び出すごとに、50回までという制限がある。<br />\nならば、Workerを2回呼び出せば、あわせて100回までいけるのでは？というのがこの記事の趣旨です。（解決策と言えるのかはさておき）</p><p>なのでたとえば、</p>\n<pre class=\"code\" data-lang=\"\" data-unlink># UTC 1時 = JST 10時 の、00分と30分\n0,30 1 * * *\n\n# UTC 1時 = JST 10時 の、5分置き\n*/5 1 * * *</pre><p>みたく、1度きりではなく複数回実行されるようにする。</p><p>そして、コード側でサブリクエスト数に気をつけて処理を分担するようにすれば、なんとかやりたいことができる・・・！</p>\n\n<ul>\n<li>サーキットブレーカー的なコードが必要になる</li>\n<li>余裕をもって実行すると、空打ちになることもある</li>\n</ul><p>けど、それでもやりたいことは実現できた。</p>\n\n</div>\n<div class=\"section\">\n    <h3>そこまでしてでやらんでも</h3>\n    <p>っていうのもごもっともで、サブリクエスト数に制限のないAWSとかGCPとか、別のところでやれば良いという話ではある・・。</p><p>が、CFWは実行時間で課金されないというアドバンテージがあるので、バッチ処理でもうまく使っていきたいなーというわけで。</p><p>ただこの作戦のネックはもう1つあって、実は1Workerに設定できるCron Triggerは3つまでなのである・・。</p>\n\n<ul>\n<li>繰り返し前処理のCron</li>\n<li>繰り返すCron</li>\n<li>繰り返し後処理のCron</li>\n</ul><p>みたくすると、これで3枠を全部使い切ったことになり、それ以上は追加できなくなる。</p><p>Cloudflareさんへ、ここもなんとかしてくれませんかね〜。</p>\n\n</div>\n<div class=\"section\">\n    <h3>2021/12/23 追記</h3>\n    \n    <blockquote>\n        <p><a href=\"https://github.com/cloudflare/miniflare/issues/132\">Feature Request: Customize the subrequests limit &middot; Issue #132 &middot; cloudflare/miniflare &middot; GitHub</a></p>\n\n    </blockquote>\n<p>中の人に言えば拡張してもらえるらしいと聞いて震えてる・・・。</p>\n\n</div>"
}
