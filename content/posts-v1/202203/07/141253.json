{
  "title": "Cloudflare Workersとレスポンスの圧縮",
  "html": "<p>経緯としては、</p>\n\n<ul>\n<li>CFWで作ったとあるAPIのレスポンスヘッダを眺めてた</li>\n<li>`content-encoding: br`になってたのを見つけた</li>\n<li>コードの中では特に何もしてない</li>\n<li>WorkerのDocsにも特にそれらしい記載はなかった</li>\n<li>そういえばこれってどこで圧縮してんの？</li>\n</ul><p>って思ったのがきっかけ。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>Cloudflareが自動で圧縮する</h3>\n    \n    <blockquote>\n        <p><a href=\"https://support.cloudflare.com/hc/en-us/articles/200168396-What-will-Cloudflare-compress\">https://support.cloudflare.com/hc/en-us/articles/200168396-What-will-Cloudflare-compress</a></p>\n\n    </blockquote>\n<p>Workerから返すレスポンスの`content-type`ヘッダが、このページにリストされてるものだった場合、それは自動的に`gzip`と`brotli`して返してくれるとのこと。</p><p>そしてこれはどうやらWorkerより外側のレイヤーで行われるらしく、Workerのコードとしては適切な`content-type`を設定するほかやることはない。<br />\nちなみに、あまりに小さいレスポンスは無圧縮になってた。</p><p>もちろん、リクエストする側として`accept-encoding`に`gzip`か`br`があることが前提。`deflate`だけとか未指定とかだとそのまま落ちてくる。（モダンなブラウザならそんな心配はないけど）</p><p>というわけで、レスポンスの圧縮はWorkerではなくその外側でやってくれる。なので、Workerからあえて`content-encoding`を指定して返す理由はない、と。</p><p>そもそも、Workerのコードで`headers.get(\"accept-encoding\")`しても、`gzip`しか返ってこない・・。</p>\n\n    <blockquote>\n        <p><a href=\"https://community.cloudflare.com/t/cloudflare-workers-lies-about-request-accept-encoding/125956\">Cloudflare Workers lies about request Accept-Encoding - Workers - Cloudflare Community</a></p>\n\n    </blockquote>\n\n</div>\n<div class=\"section\">\n    <h3>ただし、20xの場合のみ</h3>\n    <p>どうやら40xとか50xをWorkerから返したときは、`content-type`の設定だけでは圧縮してくれない風だった。</p>\n\n    <blockquote>\n        <p><a href=\"https://community.cloudflare.com/t/cloudflare-503-status-maintenance-page-worker-compressed-html-response/154874\">Cloudflare 503 Status Maintenance Page worker compressed HTML response? - Workers - Cloudflare Community</a></p>\n\n    </blockquote>\n<p>このフォーラムによると、`content-type`に加えて`cotnent-encoding`を自分で指定すれば、20xじゃないレスポンスでも圧縮してくれるらしい。</p><p>ただ手元でやってみたところ、</p>\n\n<ul>\n<li>Workerのレスポンスで`content-encoding: gzip`を設定すると\n<ul>\n<li>`accept-encoding: gzip`なリクエストに対しては、`gzip`で圧縮したものが返る</li>\n<li>`accept-encoding: gzip, br`なリクエストに対しては、圧縮してないものが返る</li>\n</ul></li>\n<li>Workerのレスポンスで`content-encoding: br`を設定しても\n<ul>\n<li>どうリクエストしても圧縮してないものが返る</li>\n</ul></li>\n</ul><p>というよくわからない挙動だった。つまりブラウザ向けには、20xじゃないレスポンスの場合、自動で圧縮したレスポンスは返せないということ・・？指定しなくていいんじゃなかったの・・？</p>\n\n</div>\n<div class=\"section\">\n    <h3>自分で圧縮してた場合はどうする</h3>\n    <p>自動で圧縮してくれるがゆえに、たとえばKVなんかから自分たちで既に圧縮してあるものを返したい場合、二重で圧縮されてしまうという問題があるらしい。</p><p>さっきの`content-type`のリストのページによると、</p>\n\n    <blockquote>\n        <p>If you do not want a particular response from your origin to be encoded, you can disable this by setting cache-control: no-transform at your origin web server. </p>\n\n    </blockquote>\n<p>とのことで、`cache-control: no-transform`をWorkerから返すことで、自動で圧縮されないようにできた。ただこのままだと`content-encoding`がレスポンスヘッダーに入らない。</p><p>じゃあどうすれば・・？ってのをひとしきり調べてみたけど、これだ！っていう答えを見つけられなかった。</p><p>中の人が回答してる最もそれらしいやつによると、`encodeBody`っていうCFW特有のプロパティを使う、と。</p>\n\n    <blockquote>\n        <p><a href=\"https://developers.cloudflare.com/workers/runtime-apis/response/#properties\">https://developers.cloudflare.com/workers/runtime-apis/response/#properties</a></p>\n\n    </blockquote>\n<p>デフォルトの`auto`から`manual`にしつつ、`content-encoding`も指定するといいらしい。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synStatement\">const</span> resp = <span class=\"synStatement\">new</span> Response(<span class=\"synComment\">/* ... */</span>, <span class=\"synIdentifier\">{</span>\n  headers: <span class=\"synIdentifier\">{</span>\n    <span class=\"synConstant\">&quot;content-encoding&quot;</span>: <span class=\"synConstant\">&quot;gzip&quot;</span>\n  <span class=\"synIdentifier\">}</span>,\n  encodeBody: <span class=\"synConstant\">&quot;manual&quot;</span>, <span class=\"synComment\">// コレ</span>\n<span class=\"synIdentifier\">}</span>);\n</pre><p>ただこれができるのは、独自`gzip`の場合のみで、独自`brotli`はできないとのこと。</p>\n\n    <blockquote>\n        <p><a href=\"https://community.cloudflare.com/t/storing-compressed-data-for-cloudflare-workers-sites/222173\">Storing Compressed Data for Cloudflare Workers Sites - Workers - Cloudflare Community</a><br />\n<a href=\"https://community.cloudflare.com/t/how-to-serve-directly-my-brotli-and-gzip-pre-compressed-css-and-js-instead-of-the-cloudflare-compressed-ones/247288\">How to serve directly my Brotli and Gzip pre-compressed css and js instead of the Cloudflare compressed ones? - Workers - Cloudflare Community</a></p>\n\n    </blockquote>\n\n</div>\n<div class=\"section\">\n    <h3>わからない</h3>\n    <p>Cloudflare Workersだからといって、ブラウザと直でやり取りしてるわけではないってことはわかった。</p><p>ただそのレイヤー境界で起きてることはよくわからなかった。誰か正解を教えてください・・。</p>\n\n</div>"
}
