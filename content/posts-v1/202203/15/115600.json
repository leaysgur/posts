{
  "title": "Cloudflare WorkersでWebフォントの配信を最適化する",
  "html": "<p>ということをやってる公式のサンプルを見つけたので、なるほど？って思いながら見てた。</p>\n\n    <blockquote>\n        <p><a href=\"https://github.com/cloudflare/worker-examples/tree/master/examples/fast-google-fonts\">https://github.com/cloudflare/worker-examples/tree/master/examples/fast-google-fonts</a></p>\n\n    </blockquote>\n<p>あと、そのままは流用できなかったけど、似たようなことを手元のGoogle Fontsを使ってるプロジェクトで試してもみた。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>やってること</h3>\n    <p>このサンプルでやってたのは、</p>\n\n<ul>\n<li>オリジンありでWorkerを使う</li>\n<li>HTML/CSSへのリクエストを仲介して、Google FontsのCSSをインライン化してしまう\n<ul>\n<li>`link rel=\"stylesheet\" href=\"<a href=\"https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap\">https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap</a>\"`みたいなやつ</li>\n<li>処理は`TransformStream`でストリーミングしながら返す</li>\n<li>サブセットのURLは、自身のWorkerへ書き換え</li>\n<li>CSS自体はキャッシュ</li>\n</ul></li>\n<li>サブセットへのリクエストを仲介して、Workerからリクエストして返す\n<ul>\n<li>フォントのキャッシュはしてなかった</li>\n</ul></li>\n</ul><p>ということ。</p><p>これによって、</p>\n\n<ul>\n<li>インライン化によって、CSSのロードとパースのステップが減る</li>\n<li>同じドメインから返すことで、Googleのドメインとのコネクションまわりの無駄が減る</li>\n</ul><p>つまりWebフォントが速くなるぜ！ってことだった。</p>\n\n</div>\n<div class=\"section\">\n    <h3>やってみた</h3>\n    <p>オリジンありでWorkerを利用してるプロジェクトがなかったので、代わりにCloudflare Pagesで静的にビルドしてるやつで試した。</p>\n\n<ul>\n<li>Google FontsのCSSは、ビルド時にインライン化してしまう\n<ul>\n<li>サブセットのURLは、自身のWorkerへ書き換える</li>\n</ul></li>\n<li>サブセットへのリクエストは、同じドメインのWorkerからリクエストして返す</li>\n</ul><p>というように、結果的なアウトプットは同じになるようにした。</p><p>前提条件も数値も載せてないので信憑性がないかもしれないけど、手元のLighthouseで適当に見てみた感じ、</p>\n\n<ul>\n<li>ちょっとだけ速くなった\n<ul>\n<li>最大で0.5sとかそういうレベル</li>\n</ul></li>\n<li>インライン化は効いてそう\n<ul>\n<li>ブロッキングなCSSのロードをスキップした分</li>\n</ul></li>\n<li>サブセットをWorker経由にするのはそこまで効いてなさそう\n<ul>\n<li>もともとのネットワークが速い（家Wi-Fi）と、直接GoogleのCDNから取っても誤差っぽい</li>\n<li>ネットワークが遅い場合は、それなりに効果がありそう</li>\n<li>サブセット自体もセルフホストして、同じドメインで（もちろんCDNで）返すとかすると、もう少しだけ攻めれそうではある</li>\n</ul></li>\n</ul><p>Edge Workerでネットワーキングまわりをなんとかする系の作戦、狭くて回線の良い日本だとあんま効果出ませんな・・。</p>\n\n</div>\n<div class=\"section\">\n    <h3>そもそも</h3>\n    <p>CSSをインライン化するだけなら、別にWorkerなくてもできる。ビルド時に動的にやらんでも、普通にブラウザで開いてコピペすればいい。</p><p>ただしCSSをインライン化するにしても、埋め込まれる容量の問題は変わらない。日本語フォントの場合、1つのファミリーの1つのウェイトってだけでも、gzipされてて約30KBの文字列っていう。</p><p>結局のところ、Webフォント（日本語）の問題点である、</p>\n\n<ul>\n<li>ファイルサイズのデカさ\n<ul>\n<li>マニフェストは元より、必要になるサブセットの数も</li>\n<li>`rel=\"preload\"`したくても対象が読めない</li>\n</ul></li>\n<li>レイアウトシフトが不可避\n<ul>\n<li>`font-display: swap`しても画面中の文字がチラつく</li>\n</ul></li>\n</ul><p>っていうのを解決できない限り、一見さん向けのファーストビューはチューニングしようがないんよね。</p><p>というわけで、引き続き†覚悟†のある人だけが日本語Webフォントを使ってくださいってとこは変わらないかなー。</p><p>いや、気持ちはわかりますよ、気持ちは。</p>\n\n</div>"
}
