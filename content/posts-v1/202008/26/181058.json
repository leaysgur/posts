{
  "title": "beforeunloadイベントと確認ダイアログ",
  "html": "\n    <blockquote>\n        <p>Changes you made may not be saved.</p>\n\n    </blockquote>\n<p>フォームの入力中とかにページを離脱しようと出るアレのこと。</p><p>昔から微妙に使われてるくせに、いまいち挙動が<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%C9%D4%C4%EA\">不定</a>でブラウザ差異もあって釈然としない。</p><p>最近はどうなってるのか知る必要が出たので、改めて調べた。</p>\n\n<ul>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\">Chrome</a>: 85.0</li>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Firefox\">Firefox</a>: 80.0</li>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a>: 13.1.2</li>\n</ul>\n<div class=\"section\">\n    <h3>基本のかたち</h3>\n    <p>コードとしてはこう書けばよい。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synStatement\">window</span>.addEventListener(<span class=\"synConstant\">&quot;beforeunload&quot;</span>, (ev) =&gt; <span class=\"synIdentifier\">{</span>\n  <span class=\"synComment\">// unloadをキャンセル = 本当に離れるのかを確認する</span>\n  ev.preventDefault();\n<span class=\"synIdentifier\">}</span>);\n</pre><p><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%D9%A5%F3%A5%C8%A5%CF%A5%F3%A5%C9%A5%E9\">イベントハンドラ</a>内で、`preventDefault()`すれば、非同期でダイアログが出せる。<br />\nと、Specにも書いてある。</p><p>ただし、ブラウザによってはそれだけではダメなやつがある。</p>\n\n</div>\n<div class=\"section\">\n    <h3><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\">Chrome</a></h3>\n    <p>それがまさかの<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\">Chrome</a>！</p><p><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\">Chrome</a>の場合はこう。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synStatement\">window</span>.addEventListener(<span class=\"synConstant\">&quot;beforeunload&quot;</span>, (ev) =&gt; <span class=\"synIdentifier\">{</span>\n  <span class=\"synComment\">// なくてもいい</span>\n  <span class=\"synComment\">// ev.preventDefault();</span>\n  ev.returnValue = <span class=\"synConstant\">&quot;&quot;</span>;\n<span class=\"synIdentifier\">}</span>);\n</pre><p>という具合に、イベントオブジェクトの`returnValue`に文字列を代入する必要がある。<br />\n空文字列でもいいし、何かしらの文字列でもいいけど、指定したとしても、確認ダイアログにそれが出るわけではない。</p>\n\n</div>\n<div class=\"section\">\n    <h3><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Firefox\">Firefox</a> / <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a></h3>\n    <p>冒頭の基本のやつで問題なし。</p>\n\n</div>\n<div class=\"section\">\n    <h3>まとめ</h3>\n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synStatement\">window</span>.addEventListener(<span class=\"synConstant\">&quot;beforeunload&quot;</span>, (ev) =&gt; <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">if</span> (shouldUnload) <span class=\"synStatement\">return</span>;\n\n  ev.preventDefault();\n  ev.returnValue = <span class=\"synConstant\">&quot;&quot;</span>;\n<span class=\"synIdentifier\">}</span>);\n</pre><p>特定の条件でだけ引き止めたい時は、こんな風に変数を見るようにして、`shouldUnload`を`false`にすればよい。</p><p>あと、独自のUIでの引き止めは、現状どうやってもできない。<br />\n確認ダイアログの文言はいじれないし、ダイアログ出さずに遷移をキャンセルする方法もなさそう。</p><p>あとは、単にリロードしただけのような場合（ユーザーアクションがなにもない場合）は、確認ダイアログが表示されないようになってる。（ブラウザの粋な計らいっぽい）</p><p>あとあと、遠い記憶でモバイルでは`beforeunload`が発火しないとかあった気がする。</p>\n\n</div>"
}
