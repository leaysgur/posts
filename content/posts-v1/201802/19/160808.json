{
  "title": "getUserMedia()以外でMediaStreamを用意するには",
  "html": "<p>`navigator.mediaDevices.getUserMedia()`することで手に入る`MediaStream`を、それ以外の手段でどうやって自作するかという話です。</p><p>どんな形であれ思いついたのをメモっておきます。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>captureStream()</h3>\n    \n    <blockquote>\n        <p><a href=\"https://w3c.github.io/mediacapture-fromelement/\">Media Capture from DOM Elements</a></p>\n\n    </blockquote>\n<p>`HTMLMediaElement`つまり`audio`と`video`要素から取れる。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synComment\">// videoでも同じ</span>\n<span class=\"synStatement\">const</span> $audio = <span class=\"synStatement\">document</span>.createElement(<span class=\"synConstant\">'audio'</span>);\n<span class=\"synStatement\">const</span> stream = $audio.captureStream();\n</pre><p>あと同じ名前のメソッドが、`HTMLCanvasElement`つまり`canvas`要素からも取れる。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synComment\">// videoでも同じ</span>\n<span class=\"synStatement\">const</span> $canvas = <span class=\"synStatement\">document</span>.createElement(<span class=\"synConstant\">'canvas'</span>);\n<span class=\"synStatement\">const</span> stream = $canvas.captureStream(10); <span class=\"synComment\">// 10FPS</span>\n</pre><p>こっちのはFPSがOptionalで渡せる。</p>\n\n</div>\n<div class=\"section\">\n    <h3>createMediaStreamDestination()</h3>\n    <p>WebAudioを使ってもいける。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synStatement\">const</span> ctx = <span class=\"synStatement\">new</span> AudioContext();\n<span class=\"synStatement\">const</span> <span class=\"synIdentifier\">{</span> stream <span class=\"synIdentifier\">}</span> = ctx.createMediaStreamDestination();\n\n<span class=\"synComment\">// 1行で</span>\n<span class=\"synStatement\">new</span> AudioContext().createMediaStreamDestination().stream;\n</pre><p>Oscillatorとかで適当に音を作ってつないでおけば、jsだけでそういうストリームを自作することもできる。</p><p>VideoとAudio、どっちもFakeでいいので作る時のスニペット。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synIdentifier\">function</span> getFakeStream(ctx) <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">const</span> $canvas = <span class=\"synStatement\">document</span>.createElement(<span class=\"synConstant\">'canvas'</span>);\n  $canvas.width = $canvas.height = 1;\n  <span class=\"synComment\">// NOTE: これがないとFirefoxが通らない</span>\n  $canvas.getContext(<span class=\"synConstant\">'2d'</span>);\n  <span class=\"synStatement\">const</span> vStream = $canvas.captureStream();\n  <span class=\"synStatement\">const</span> aStream = ctx.createMediaStreamDestination().stream;\n\n  <span class=\"synStatement\">const</span> <span class=\"synIdentifier\">[</span>vTrack<span class=\"synIdentifier\">]</span> = vStream.getVideoTracks();\n  <span class=\"synStatement\">const</span> <span class=\"synIdentifier\">[</span>aTrack<span class=\"synIdentifier\">]</span> = aStream.getAudioTracks();\n\n  <span class=\"synStatement\">return</span> <span class=\"synStatement\">new</span> MediaStream(<span class=\"synIdentifier\">[</span>vTrack, aTrack<span class=\"synIdentifier\">]</span>);\n<span class=\"synIdentifier\">}</span>\n\ngetFakeStream(<span class=\"synStatement\">new</span> AudioContext());\n</pre>\n</div>\n<div class=\"section\">\n    <h3>new MediaStream()</h3>\n    <p>まあこれも一応・・ｗ<br />\nただこの場合、中の`MediaStreamTrack`が入ってない。</p>\n\n</div>\n<div class=\"section\">\n    <h3>getDisplayMedia()</h3>\n    \n    <blockquote>\n        <p><a href=\"https://w3c.github.io/mediacapture-screen-share/\">Screen Capture</a></p>\n\n    </blockquote>\n<p>いつになるやら！</p>\n\n</div>"
}
