{
  "title": "SkyWay UG Tokyo #2 - Supported by ピクシブ に行ってきたメモ #WebRTCSkyWay",
  "html": "<p><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D4%A5%AF%A5%B7%A5%D6\">ピクシブ</a>社にはじめて入った回。<br />\nふっつーに仕事のミーティングしてる横で、マンガもいっぱいあって無限に時間つぶせそうな空間でした・・！<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>SkyWayを導入した時の話(仮) by walf443</h3>\n    <p>SkyWayを使っていたこともあったよ（今は使ってないよ）という話。</p>\n\n<div class=\"section\">\n    <h4>pixiv Sketch Live</h4>\n    \n<ul>\n<li>お絵かきを配信</li>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/RTMP\">RTMP</a>ではなくWebRTC</li>\n<li>最終的には時雨堂の<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/SFU\">SFU</a>になった</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/SFU\">SFU</a></h4>\n    \n<ul>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/P2P\">P2P</a>だとスケールに限界がある</li>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/SFU\">SFU</a>だとそれを回避できる\n<ul>\n<li>SkyWayなら500GB（転送量）まで無料</li>\n</ul></li>\n<li>SoraがSRTP -> RTPして<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GPU\">GPU</a>サーバーに転送して、そこでHLSにする\n<ul>\n<li>こういうことしたい！ってなると、SkyWayではなくなるよな・・</li>\n</ul></li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>SkyWayの頃</h4>\n    \n<ul>\n<li>ルーム機能を使ってた</li>\n<li>チャット機能もSkyWayの機能でまかなえた</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>困ったこと</h4>\n    \n<ul>\n<li>接続情報（PeerID）と、アプリ側のユーザーIDをどう紐付けるか\n<ul>\n<li>ユーザーIDごとにランダムなPeerIDを払い出してた</li>\n<li>別タブを見分けたりしたかった</li>\n</ul></li>\n<li>ルーム内のユーザー一覧\n<ul>\n<li>自前で紐付けてDBに入れるしかなかった</li>\n</ul></li>\n<li>配信終了の処理\n<ul>\n<li>ルームの管理者という概念がない</li>\n<li>ユーザーがいなくなったら部屋が消える</li>\n<li>この配信をやめさせたい・・みたいなのを検知できない</li>\n<li>それ用のイベントを用意して解決</li>\n</ul></li>\n<li>ハートビート\n<ul>\n<li>↑の理由から、配信主がリロードしたら部屋が解散してしまう</li>\n<li>退出ボタンは押されない場合も多い</li>\n<li>5分間<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ping\">Ping</a>されてない部屋は解散にした</li>\n</ul></li>\n<li>WebRTC関係ないところが最も大変だった\n<ul>\n<li>Viewのモード切り替えとか</li>\n</ul></li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>pixiv SketchのDrawモード</h4>\n    \n<ul>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/canvas\">canvas</a>から`captureStream()`</li>\n<li>音は別途ストリーム作って、自前でTrackを合成する</li>\n<li>こういうことをするので、常にMediaStreamTrackで管理するようにした</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>その他</h4>\n    \n<ul>\n<li>高画質で配信したいなら\n<ul>\n<li>`getUserMedia()`のconstraintsで`ideal`を</li>\n<li>画面共有の時は`max`を</li>\n</ul></li>\n<li>画面共有\n<ul>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\">Chrome</a>は拡張のインラインインストールおすすめ</li>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Firefox\">Firefox</a>は`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/https\">https</a>`必須（<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/localhost\">localhost</a>でも）</li>\n</ul></li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>同時配信の<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%C7%A5%D0%A5%C3%A5%B0\">デバッグ</a></h4>\n    \n<ul>\n<li>良いPCほしい</li>\n<li>広いモニタほしい</li>\n<li>シークレットウィンドウ最高</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>まとめ</h4>\n    \n<ul>\n<li>SkyWayがWebRTCな範囲はがんばってくれた</li>\n<li>無料枠もあるので、プロトから本採用も移行しやすいのでは</li>\n</ul><p>結局、WebRTC的なとこよりも高度な<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/GUI\">GUI</a>アプリを<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/JavaScript\">JavaScript</a>でどうやって作るかが問題よね・・。</p>\n\n</div>\n</div>\n<div class=\"section\">\n    <h3>WebRTCの動画ストリームをトランスコードする by harukasan</h3>\n    \n    <blockquote>\n        <p><a href=\"https://speakerdeck.com/harukasan/transcoding-video-streams-from-webrtc\">WebRTC&#x52D5;&#x753B;&#x3092;&#x30C8;&#x30E9;&#x30F3;&#x30B9;&#x30B3;&#x30FC;&#x30C9;&#x3059;&#x308B; / Transcoding video streams from WebRTC // Speaker Deck</a></p>\n\n    </blockquote>\n<p>噂のImageFluxの話！<br />\nWebRTCのストリームをHLSにして配信するためにはどうすればいいか。</p>\n\n<div class=\"section\">\n    <h4>WebRTCは何をしてるか</h4>\n    \n<ul>\n<li>セッション管理（SDP）</li>\n<li>ストリーミング（SRTP）</li>\n<li>NAT越え</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>SDP</h4>\n    \n<ul>\n<li>最初にコレみて動画のフォーマットを知る</li>\n<li>読みづらいで有名な<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D7%A5%ED%A5%C8%A5%B3%A5%EB\">プロトコル</a></li>\n<li>`a=<attr>:<val>`行を実際は見ていけばいい</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>RTPをデコードする</h4>\n    \n<ul>\n<li>UDPにヘッダがついてるだけ</li>\n<li>ペイロードのタイプ（7bit）によって処理\n<ul>\n<li>そんな種類少ないわけないので、今はそれ用のがある</li>\n</ul></li>\n<li>RTPは順序が保証されないので自前で並び替え</li>\n<li>RTPのペイロードからNAL Unitなる単位を取り出す</li>\n<li>それをAnnex Bという方式でデコーダーに投げればゴール</li>\n<li>UDPは一般的には1500byteなので、結合したり分割したりする\n<ul>\n<li>結合パケットと分割パケットで対応</li>\n<li>これも動画フォーマットによって決まってる</li>\n</ul></li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>質問</h4>\n    \n<ul>\n<li>なんでWebRTCやめてHLSにしたの？\n<ul>\n<li>サービス特性によって選択</li>\n<li>HLSの遅延の限界は1.75秒くらいなので</li>\n<li>CMAFでもうちょい短縮できそうなのでやっていきたい</li>\n</ul></li>\n<li>WebRTCでHLS配信したいんだけど、がっつりサーバー書けなくて・・って場合は？\n<ul>\n<li>ImageFlux使ってくれれば楽だよ</li>\n</ul></li>\n<li>Wowza使えば楽にならない？\n<ul>\n<li>よく知らないけど、動かないとかよく聞く</li>\n<li>H.264がそもそもパケロスを考慮してないので、そこをどうカバーするかがキモ</li>\n<li>だから今までRTMP時代だったし</li>\n</ul></li>\n<li>WebRTC時代がくると、何が大変になる？\n<ul>\n<li>安定して配信すること・・</li>\n<li>ブラウザのAPIより先に手を出せないところ</li>\n</ul></li>\n<li>RTMPの厳しさは？\n<ul>\n<li>WebRTCより標準化されてないところ</li>\n<li>配信ソフト（OBS）とかとの相性とかもまちまち</li>\n</ul></li>\n</ul><p>おもしろかったけど、SkyWayというより某社のSFU製品色の強いセッションやったよねｗ(˘ω˘ )</p>\n\n</div>\n</div>\n<div class=\"section\">\n    <h3>SkyWayベースのウェブアプリをiOS版Safariに対応した時の話 by uturist</h3>\n    <p>世知辛い話ｗ</p>\n\n<div class=\"section\">\n    <h4>iOS Safari x WebRTC！</h4>\n    \n<ul>\n<li>walkwiz.me というサービスを作った\n<ul>\n<li>カメラの前で歩くモーションをすると、ストリートビューがちょっとずつ動く</li>\n</ul></li>\n<li>SkyWay / Firebase / Google Map API\n<ul>\n<li>すべてフリーミアム！</li>\n</ul></li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>デバッグから</h4>\n    \n<ul>\n<li>SkyWayのサポートページに載ってる内容だけでは終わらなかった</li>\n<li>iOS 10未満の非対応です対応\n<ul>\n<li>`alert()`で非対応って出すだけ</li>\n</ul></li>\n<li>iOS 11.0 / iOS 11.1\n<ul>\n<li>なんか触ってるとフリーズする</li>\n<li>強制終了もできない</li>\n<li>`alert()`でアップデートしたほうがいいよって出す</li>\n</ul></li>\n<li>WebViewの対応\n<ul>\n<li>iOS 11でもダメ</li>\n<li>FacebookとかLINEとかは、独特のUAで判別</li>\n</ul></li>\n<li>DataChannelのデータがロストする\n<ul>\n<li>デフォルトでは`reliable`なはずだが・・</li>\n<li>`maxRetransmits`をマニュアルで</li>\n</ul></li>\n</ul><p>iOS 11.3に期待！</p>\n\n</div>\n</div>\n<div class=\"section\">\n    <h3>pixiv Sketch Liveリリースの裏側 by _furoshiki</h3>\n    <p>非公開です！</p>\n\n</div>\n<div class=\"section\">\n    <h3>WebRTCとコーデックの関係 by yusuke84</h3>\n    \n    <blockquote>\n        <p><a href=\"https://qiita.com/yusuke84/items/40115b9d5ca89ae9e45f\">WebRTC&#x3068;&#x30B3;&#x30FC;&#x30C7;&#x30C3;&#x30AF;&#x306E;&#x95A2;&#x4FC2; - Qiita</a></p>\n\n    </blockquote>\n<p>初心者に優しいコーデック入門。</p>\n\n<div class=\"section\">\n    <h4>WebRTCで（よく）使われるコーデック</h4>\n    \n<ul>\n<li>Audio codecs\n<ul>\n<li>Opus</li>\n<li>G.711</li>\n</ul></li>\n<li>Video codecs\n<ul>\n<li>VP8</li>\n<li>VP9</li>\n<li>H.264</li>\n<li>AV1</li>\n</ul></li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>映像コーデックたち</h4>\n    \n<ul>\n<li>VP9\n<ul>\n<li>Google</li>\n<li>ロイヤリティフリー！</li>\n</ul></li>\n<li>H.264\n<ul>\n<li>MPEG LAが管理（有料）</li>\n<li>Ciscoが出してるOpenH264を使ってれば無料</li>\n<li>Androidは一部どうだろう・・</li>\n</ul></li>\n<li>AV1\n<ul>\n<li>ロイヤリティフリー！</li>\n</ul></li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>ブラウザ</h4>\n    \n<ul>\n<li>Safariとつなぐなら、H.264一択になる（現状）</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h4>コーデックを選択するには</h4>\n    \n<ul>\n<li>SDPを書き換えるしかない\n<ul>\n<li>大変</li>\n</ul></li>\n<li>SkyWayなら`{ videoCodec: 'H264' }`ってするだけ！\n<ul>\n<li>VP8, VP9, H.264が使えます</li>\n</ul></li>\n</ul>\n</div>\n</div>"
}
