{
  "title": "nginxでPHPのセッション変数が効かない時は",
  "html": "\n<ul>\n<li>Apacheではなくnginxをウェブサーバーに使っている</li>\n<li>セッションに関する設定をした覚えがない</li>\n</ul><p>そんなあなた！</p><p>効かなくて当然です！ちゃんと設定してください！<br />\nそのライブラリが悪いんじゃありません！</p>\n\n    <blockquote>\n        <p>20150131: 2年半ぶりですが、コメントをもらったので書き直しました！</p>\n\n    </blockquote>\n\n<div class=\"section\">\n    <h3>事の発端</h3>\n    <pre class=\"code lang-php\" data-lang=\"php\" data-unlink><span class=\"synSpecial\">&lt;?php</span>\n<span class=\"synIdentifier\">session_start</span><span class=\"synSpecial\">()</span>;\n\n<span class=\"synStatement\">$</span><span class=\"synIdentifier\">_SESSION</span><span class=\"synSpecial\">[</span>&quot;<span class=\"synConstant\">_test</span>&quot;<span class=\"synSpecial\">]</span><span class=\"synStatement\">++</span>;\n\n<span class=\"synPreProc\">echo</span> <span class=\"synStatement\">$</span><span class=\"synIdentifier\">_SESSION</span><span class=\"synSpecial\">[</span>&quot;<span class=\"synConstant\">_test</span>&quot;<span class=\"synSpecial\">]</span>; <span class=\"synComment\">// 何回リロードしても1</span>\n</pre><p>なんでやー！</p>\n\n</div>\n<div class=\"section\">\n    <h3>現状を確認する</h3>\n    <p>まず、そのページを動かしてるPHPのセッションに関する設定を確認します。</p>\n<pre class=\"code lang-php\" data-lang=\"php\" data-unlink>phpinfo();\n</pre><p>安定のこのコマンドで、session.save_pathの指定をチェック。<br />\nパスの指定があれば、その場所を覚えておきます。</p><p>だいたい、/var/lib/php/session になってるのかな？<br />\nNo valueの場合は、/tmp になります。</p>\n\n    <blockquote>\n        <p>コード側で意図して変更してない限り、<br />\nphp --ini ってしてphp.ini見つけて、中身見ても一緒なはず。</p>\n\n    </blockquote>\n\n</div>\n<div class=\"section\">\n    <h3>権限の確認</h3>\n    \n<div class=\"section\">\n    <h4>まずPHP</h4>\n    <p>/tmpの場合は問題ないと思いますが、ファイルのパーミッションを確認します。<br />\n/var/lib/php/session だったとして。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>cd /var/lib/php/\nls -la</pre><p>すると、</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>drwxrwx--- 2 root apache 36864 10月 13 15:00 2012 session</pre><p>この例だと、所有者はroot、グループはapacheです。</p>\n\n</div>\n<div class=\"section\">\n    <h4>Nginxは</h4>\n    <p>/etc/nginx/nginx.conf とか見ると、user って行があるはずで、そこのnginxのユーザーが書いてあるはずです。<br />\nだいたいは nginx そのままかな？</p>\n\n</div>\n<div class=\"section\">\n    <h4>どちらも確認したので</h4>\n    <p>もうおわかりかもですが、セッションのファイルを作ろうと思っても、<br />\nユーザー: nginxは 所有者であるrootではないし、所有グループであるapacheにも属してないので、<br />\n権限がなくてファイル作れない -> セッションが効かないってわけです。</p>\n\n</div>\n</div>\n<div class=\"section\">\n    <h3>権限を追加</h3>\n    <p>なので、この権限問題をなんとかすれば良いことがわかったので・・。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>chown nginx /var/lib/php/session</pre><p>ってして、nginx(のユーザー)に対しても、<br />\nちゃんとセッションいじれるようにしてあげればOKですね。</p><p>もしくは、</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>chgrp nginx /var/lib/php/session</pre><p>所有者ではなくて所有グループを変えてもOK。</p><p>試してないですが、nginxをapacheのグループに属するようにしてもOKな気がします。</p>\n\n<div class=\"section\">\n    <h4>コメントもらったコマンド</h4>\n    <pre class=\"code\" data-lang=\"\" data-unlink>chown -R nginx.nginx /var/lib/php/session/</pre>\n<ul>\n<li>ユーザーだけでなく、所有グループもnginxに変更</li>\n<li>その上、sessionディレクトリ以下の既存のセッションファイルの所有権も全部まとめて変更</li>\n</ul><p>前者に関しては、ユーザーかグループかどちらか変えればいい話なので、<br />\n片方でも良いし、両方変えても良いし、特になんとも。</p><p>後者の例は、無駄なのでは・・と思います。<br />\nこのコマンドを実行するまで、その中にあるファイルにも権限はなかったはずで、<br />\nいまさらそれらにアクセスしようとする理由がない・・。<br />\nなんか理由があるんかしら？おまじない的な？</p>\n\n</div>\n</div>"
}
