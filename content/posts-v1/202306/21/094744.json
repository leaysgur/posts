{
  "title": "ローカルProxyサーバーをBunで書く",
  "html": "<p>Bun、単なるNode.js互換という意味ではそんな興味ないなって思ってたけど、Cloudflare Workersみたいなエッジランタイム（で動くコード）をローカルでシュッと動かせるやつっていう見方をすると、すごくいいのでは・・・！ってなった。</p><p><a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/Proxy%A5%B5%A1%BC%A5%D0\">Proxyサーバ</a>ーもこんな簡単にかけるとは・・・。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3 id=\"最小プロキシー\">最小プ<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/%A5%ED%A5%AD%A5%B7%A1%BC\">ロキシー</a></h3>\n    <p>違うオリジンをGETするだけなら、本当にこれだけ。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>Bun.serve(<span class=\"synIdentifier\">{</span>\n  port: 3000,\n  fetch: (req) =&gt;\n    fetch(\n      req.replace(<span class=\"synConstant\">&quot;http://localhost:3000&quot;</span>, <span class=\"synConstant\">&quot;http://api.example.com&quot;</span>)\n    ),\n<span class=\"synIdentifier\">}</span>)\n</pre><p>みじか。</p><p>Node.jsでやってたときは、`http-proxy`をわざわざインストールして・・みたいなことしてたけど、もういらぬ。</p><p>好きなように`Response`を返せばいいので、CORSのヘッダ差し込みとか、`set-<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/cookie\">cookie</a>`だけ貼り直すとかも、ストレートに書ける。</p>\n\n</div>\n<div class=\"section\">\n    <h3 id=\"ホットリロードもある\">ホットリロードもある</h3>\n    <p>`Bun.serve({ fetch })`ではなく、`export default { fetch }`とすると、ホットリロードできるようになる・・・！</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synStatement\">export</span> <span class=\"synStatement\">default</span> <span class=\"synIdentifier\">{</span>\n  async fetch(req) <span class=\"synIdentifier\">{</span>\n    <span class=\"synComment\">// ...</span>\n  <span class=\"synIdentifier\">}</span>,\n<span class=\"synIdentifier\">}</span>\n</pre><p>こう書き換えた上で、`bun --hot`で実行するだけ。すんばらしい・・・。</p><p>`nodemon`みたいなプロセスごとリスタートじゃないので、<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/%A5%B0%A5%ED%A1%BC%A5%D0%A5%EB%CA%D1%BF%F4\">グローバル変数</a>とかそのまま生き残ってる。</p>\n\n</div>\n<div class=\"section\">\n    <h3 id=\"もっと使っていきたい\">もっと使っていきたい</h3>\n    <p>これまで、ローカルで動かすツール系は、NodeでもBunでも動くようなコードをベースラインに据えてたけど、ここまでUXがいいとBunオンリーにするのも悪くないな・・・って心変わりした。</p><p>その上、TypeScriptも直接実行できるし、ファイルI/Oも速いし、`.env`も自動で読んでくれるし、<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/SQLite\">SQLite</a>まで同梱されてるし、もうこのためにあったんでは！ってくらい感動してる。</p>\n\n</div>"
}
