{
  "title": "現時点のCircleCI 2.0で、GitのタグのpushでCIするには",
  "html": "<p>今日（20170406）時点のCircleCI 2.0（Beta）では、1系のときに存在したこの記述が動かない。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>deployment\n<div class=\"section\">\n    <h3>タグをフックする</h3>\n    <p>`config.yml`にこう書く。</p>\n<pre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink><span class=\"synIdentifier\">version</span><span class=\"synSpecial\">:</span> <span class=\"synConstant\">2</span>\n\n<span class=\"synComment\"># ...</span>\n\n<span class=\"synIdentifier\">deployment</span><span class=\"synSpecial\">:</span>\n  <span class=\"synIdentifier\">fake_deploy_for_cci2</span><span class=\"synSpecial\">:</span><span class=\"synComment\"> # 別に名前はなんでもいい</span>\n    <span class=\"synIdentifier\">tag</span><span class=\"synSpecial\">:</span> /.*/<span class=\"synComment\"> # どんなタグでもフックするようにするのが重要</span>\n    <span class=\"synIdentifier\">command</span><span class=\"synSpecial\">:</span> |\n      echo <span class=\"synConstant\">&quot;現時点でtagのpushによりCIを動かすにはこうして見張るしかない&quot;</span>\n      echo <span class=\"synConstant\">&quot;そして実処理は別途書く必要がある&quot;</span>\n      echo <span class=\"synConstant\">&quot;というかたぶんココ動いてないし、ドコにログ出てるかも不明&quot;</span>\n</pre><p>これでとりあえずタグがpushされた時にCIが動きます。</p>\n\n</div>\n<div class=\"section\">\n    <h3>特定のタグでなんかする</h3>\n    <p>とりあえずタグのpush時にもCIするだけならここまででOK。</p><p>ただしほとんどそんなことないはずで・・、特定のタグでなんかするをやるにはさっきのに加えてこう書く。</p>\n<pre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink><span class=\"synIdentifier\">version</span><span class=\"synSpecial\">:</span> <span class=\"synConstant\">2</span>\n<span class=\"synIdentifier\">jobs</span><span class=\"synSpecial\">:</span>\n  <span class=\"synIdentifier\">build</span><span class=\"synSpecial\">:</span>\n    <span class=\"synIdentifier\">steps</span><span class=\"synSpecial\">:</span>\n      <span class=\"synStatement\">- </span>deploy\n        <span class=\"synIdentifier\">name</span><span class=\"synSpecial\">:</span> Deploy somthing\n        <span class=\"synIdentifier\">command</span><span class=\"synSpecial\">:</span> |\n          if <span class=\"synSpecial\">[[</span> <span class=\"synConstant\">&quot;${CIRCLE_TAG}&quot;</span> =~ release-.* <span class=\"synSpecial\">]]</span>; then\n            ./deploy_master.sh\n          else\n            echo <span class=\"synConstant\">&quot;do nothing :)&quot;</span>\n          fi\n<span class=\"synIdentifier\">deployment</span><span class=\"synSpecial\">:</span>\n</pre><p>てな具合いに、</p>\n\n<ul>\n<li>`deployment`の指定で全部のタグを引っ掛けて</li>\n<li>`deploy`の`steps`で実際の処理をする\n<ul>\n<li>そのときにタグをチェックする</li>\n</ul></li>\n</ul><p>っていう手間をかければできます。</p>\n\n</div>\n<div class=\"section\">\n    <h3>Artifactsを出したい</h3>\n    <p>これまた別で、`store_artifacts`っていう項目があるのでそれを使う。</p>\n<pre class=\"code lang-yaml\" data-lang=\"yaml\" data-unlink><span class=\"synIdentifier\">version</span><span class=\"synSpecial\">:</span> <span class=\"synConstant\">2</span>\n<span class=\"synIdentifier\">jobs</span><span class=\"synSpecial\">:</span>\n  <span class=\"synIdentifier\">build</span><span class=\"synSpecial\">:</span>\n    <span class=\"synIdentifier\">steps</span><span class=\"synSpecial\">:</span>\n      <span class=\"synStatement\">- </span>deploy\n        <span class=\"synIdentifier\">name</span><span class=\"synSpecial\">:</span> Deploy somthing\n        <span class=\"synIdentifier\">command</span><span class=\"synSpecial\">:</span> |\n          if <span class=\"synSpecial\">[[</span> <span class=\"synConstant\">&quot;${CIRCLE_TAG}&quot;</span> =~ release-.* <span class=\"synSpecial\">]]</span>; then\n            ./deploy_master.sh<span class=\"synComment\"> # ./package になんか作る</span>\n          else\n            echo <span class=\"synConstant\">&quot;do nothing :)&quot;</span>\n          fi\n      <span class=\"synStatement\">- </span><span class=\"synIdentifier\">store_artifacts</span><span class=\"synSpecial\">:</span>\n          <span class=\"synIdentifier\">path</span><span class=\"synSpecial\">:</span> ./package<span class=\"synComment\"> # 作っておいたもの（ディレクトリ or ファイル）</span>\n          <span class=\"synIdentifier\">destination</span><span class=\"synSpecial\">:</span> package<span class=\"synComment\"> # 必須らしいが名前はなんでもいい</span>\n<span class=\"synIdentifier\">deployment</span><span class=\"synSpecial\">:</span>\n</pre><p>これでOK。</p><p>普段の関係ないビルドやタグの場合は、Artifactsで指定した<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8\">ディレクト</a>リに何もできないはずなので、何も起こらない。</p><p>公式対応はよーー・・</p>\n\n</div>"
}
