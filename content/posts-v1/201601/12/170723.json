{
  "title": "AWSのLambdaで、zipにしたコードを動かす時にハマったこと",
  "html": "<p>短いコードならインラインで書いてしまってもいいですが、npmのモジュール使ったりするとインラインではダメで、zipで固めてアップロードする必要があります。</p><p>簡単にできると思いきや、スッと動いてくれなかったので・・。<br />\nハマったポイントのメモ。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>Cannot find module ...</h3>\n    <p>たいだいハマるのがこのエラーな気がして、これが出た時にどの部分をあわせればちゃんと動くのかのメモです。</p>\n\n<div class=\"section\">\n    <h4>ハンドラー設定とファイル名と関数名</h4>\n    <p>ハンドラー設定は、初期設定で`index.handler`ってなってるとこ。<br />\nあれと、zipで固めたコードのファイル名とその中でエクスポートしてる関数名が一致してないとダメ。</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>- index.js\n- node_modules</pre><p>こういうzipなら、`index.handler`にしないとダメ。</p><p>そしてもちろんこう。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synComment\">// index.js</span>\nexports.handler = fuction(ev, ctx) <span class=\"synIdentifier\">{</span>\n\t<span class=\"synComment\">// ...</span>\n<span class=\"synIdentifier\">}</span>;\n</pre><p>\"index\".jsでエクスポートしてる\"handler\"関数だから、ハンドラーの設定は\"index.handler\"になる。</p><p>なので、</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synComment\">// hello.js</span>\nexports.world = fuction(ev, ctx) <span class=\"synIdentifier\">{</span>\n\t<span class=\"synComment\">// ...</span>\n<span class=\"synIdentifier\">}</span>;\n</pre><p>なら、ハンドラー設定のところは、`hello.world`にすれば動く。</p>\n\n</div>\n<div class=\"section\">\n    <h4>モジュールの依存関係</h4>\n    <pre class=\"code\" data-lang=\"\" data-unlink>- myFunc.js\n  - github\n    - mime</pre><p>myFunc.jsで `require('github')` したなら、githubモジュールが依存してる`mime`も一緒に固めないとダメ。</p><p>なので、`node_modules/github`で`npm i --production`とかする必要がある。</p>\n\n</div>\n<div class=\"section\">\n    <h4>どうでもいいもの</h4>\n    \n<ul>\n<li>Lambda Function側の関数名</li>\n<li>zipのファイル名(アーカイブ.zipで良い)</li>\n</ul><p>まぎらわしいですね。</p>\n\n</div>\n</div>\n<div class=\"section\">\n    <h3>チェックリスト</h3>\n    \n<ul>\n<li>Handler名とファイル名と関数名が一致している</li>\n<li>node_modules内の全てのモジュールの依存関係が解消されてzipの中に入ってる</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h3>それでも \"Cannot find module '/var/task/index'\"</h3>\n    <p>ある日突然これでエラーが出て、少しハマった。</p><p>最終的には、ハンドラーのファイルに対して、</p>\n<pre class=\"code lang-sh\" data-lang=\"sh\" data-unlink><span class=\"synStatement\">chmod</span> <span class=\"synSpecial\">+x</span> index.js\n</pre><p>してから`.zip`にすると動きました。</p>\n\n</div>"
}
