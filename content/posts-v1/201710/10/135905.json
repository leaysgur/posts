{
  "title": "KAGOYAのVPSの緊急メンテでサーバーを落としたままにしちゃってた対応",
  "html": "<p>コレ。</p>\n\n    <blockquote>\n        <p><a href=\"https://www.kagoya.jp/news/201710108467.html\">&#x3010;&#x30E1;&#x30F3;&#x30C6;&#x30CA;&#x30F3;&#x30B9;&#x60C5;&#x5831;&#x3011;&#x3010;VPS &#x91CD;&#x8981;:15907&#x3011;KAGOYA CLOUD&#xFF0F;2 &#x7DCA;&#x6025;&#x30E1;&#x30F3;&#x30C6;&#x30CA;&#x30F3;&#x30B9;&#x5B9F;&#x65BD;&#x306B;&#x3064;&#x304D;&#x307E;&#x3057;&#x3066; | &#x65B0;&#x7740;&#x60C5;&#x5831;&#xFF5C; &#x30EC;&#x30F3;&#x30BF;&#x30EB;&#x30B5;&#x30FC;&#x30D0;&#x30FC;&#x306E;&#x30AB;&#x30B4;&#x30E4;&#x30FB;&#x30B8;&#x30E3;&#x30D1;&#x30F3;</a></p>\n\n    </blockquote>\n<p>うちの<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9\">インスタンス</a>がまんまと対象で、それに気づかずサーバーが落ちっぱなしになってた・・というのに対応した時のメモ。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>TL;DR</h3>\n    \n<ul>\n<li>メンテナンスで何が起きるか把握してなかった</li>\n<li>何かが起きた時の初動に手間取った</li>\n<li>`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ufw\">ufw</a>`が起きてなくて、<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ssh\">ssh</a>もhttpも<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/https\">https</a>も通らなくなってた</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h3>経緯</h3>\n    \n    <blockquote>\n        <p>メンテナンス時ご利用<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9\">インスタンス</a>収容サーバーが停止します。</p>\n\n    </blockquote>\n<p>サーバーが停止するということは、もちろんNginxやら何やらも止まるというわけで。</p><p>その後<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9\">インスタンス</a>が再起動するのか、手動で起動しないといけないのかは不明だったけども、なんしかそのことが完全に頭から抜け落ちてて、 #スーパーイカメーカー のユーザーさんに<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Twitter\">Twitter</a>でリプをもらって初めて気づくという間抜けさを発揮した。</p>\n\n</div>\n<div class=\"section\">\n    <h3>復旧までの手順</h3>\n    \n<ul>\n<li>Webサーバー落ちてるのを知る</li>\n<li>とりあえず`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ssh\">ssh</a>`でつないで再起動すればええやろ</li>\n<li>つながらない\n<ul>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%BF%A5%A4%A5%E0%A5%A2%A5%A6%A5%C8\">タイムアウト</a>する</li>\n</ul></li>\n<li>なんで・・・？？</li>\n<li>`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ping\">ping</a>`はもちろん通る</li>\n<li>`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ssh\">ssh</a>`のポートは変えてあって、デフォルトポートだと<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%BF%A5%A4%A5%E0%A5%A2%A5%A6%A5%C8\">タイムアウト</a>ではなくrefuseされる\n<ul>\n<li>`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/sshd\">sshd</a>`は起きてると判断</li>\n</ul></li>\n<li>なら<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%D5%A5%A1%A5%A4%A5%A2%A5%A6%A5%A9%A1%BC%A5%EB\">ファイアウォール</a>か！</li>\n<li>`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ufw\">ufw</a>`のステータス確認\n<ul>\n<li>inactiveやんけ！</li>\n</ul></li>\n<li>`sudo <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ufw\">ufw</a> enable`</li>\n</ul><p>これで今まで通り`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ssh\">ssh</a>`できるようになったので、Nginxも起こして復旧。</p><p>なので結果としては2コマンド。</p>\n\n<ul>\n<li>`sudo <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ufw\">ufw</a> enable`</li>\n<li>`sudo service nginx restart`</li>\n</ul><p>Nginxは実際寝てたかどうか確認しなかったので、念のため・・みたいな感じになってしまった。</p>\n\n</div>\n<div class=\"section\">\n    <h3>今後</h3>\n    <p>とりあえず<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%A4%A5%F3%A5%B9%A5%BF%A5%F3%A5%B9\">インスタンス</a>が止まることを想定してなかったので、単純に戸惑った・・という学び。</p><p><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Ubuntu\">Ubuntu</a>で`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ufw\">ufw</a>`を再起動時に有効にする方法を調べてみたけど、どうにもコレ！っていうのが見つからなかった。<br />\n`/etc/<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ufw\">ufw</a>/<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/ufw\">ufw</a>.conf`に`ENABLED=yes`を書くだけでいいわけではないらしい。わからん。</p><p>あとKAGOYAの<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/VPS\">VPS</a>のコンパネ、ターミナルのコマンド実行のUXが最低なので改善してほしいです！</p>\n\n</div>"
}
