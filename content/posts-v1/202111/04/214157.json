{
  "title": "Cloudflare Workersで、Workerから別のWorkerを呼びたい",
  "html": "<p>結論から書いておくと、</p>\n\n<ul>\n<li>できることはできる</li>\n<li>ただし、異なる`account_id`でデプロイされたWorker同士なら\n<ul>\n<li>より正確には、`zone`が違えばいいらしいけど</li>\n</ul></li>\n</ul><p>という。</p>\n\n    <blockquote>\n        <p><a href=\"https://community.cloudflare.com/t/get-error-code-1042-when-fetching-within-worker/288031\">Get error code 1042 when fetching within worker - Workers - Cloudflare Community</a><br />\n<a href=\"https://community.cloudflare.com/t/issue-with-worker-to-worker-https-request/94472\">Issue With Worker-To-Worker HTTPS request - Workers - Cloudflare Community</a></p>\n\n    </blockquote>\n\n<div class=\"section\">\n    <h3>やってみた</h3>\n    \n<ul>\n<li>root</li>\n<li>child</li>\n</ul><p>という2つのWorkerを、実際にデプロイして試した。</p><p>`wrangler.toml`の`account_id`はどっちも同じ。だって普通は同じであろうから・・。</p>\n\n<div class=\"section\">\n    <h4>root</h4>\n    <p>子Workerを叩いて返すだけ。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>addEventListener(<span class=\"synConstant\">&quot;fetch&quot;</span>, <span class=\"synStatement\">event</span> =&gt; <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">event</span>.respondWith(handleEvent(<span class=\"synStatement\">event</span>));\n<span class=\"synIdentifier\">}</span>);\n\nasync <span class=\"synIdentifier\">function</span> handleEvent() <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">const</span> res = await fetch(CHILD_WORKER_URL);\n  <span class=\"synStatement\">return</span> res;\n<span class=\"synIdentifier\">}</span>\n</pre>\n</div>\n<div class=\"section\">\n    <h4>child</h4>\n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>addEventListener(<span class=\"synConstant\">&quot;fetch&quot;</span>, <span class=\"synStatement\">event</span> =&gt; <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">event</span>.respondWith(handleEvent(<span class=\"synStatement\">event</span>));\n<span class=\"synIdentifier\">}</span>);\n\nasync <span class=\"synIdentifier\">function</span> handleEvent() <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">return</span> <span class=\"synStatement\">new</span> Response(<span class=\"synConstant\">&quot;Hello from child!&quot;</span>);\n<span class=\"synIdentifier\">}</span>\n</pre><p>返事するだけ。</p>\n\n</div>\n</div>\n<div class=\"section\">\n    <h3>ダメだった</h3>\n    <pre class=\"code\" data-lang=\"\" data-unlink>error code: 1042</pre><p>という感じでダメ。</p><p>罠なのが、Workersの管理画面にくっついてるエディタからだとこれが普通に通るってところ。<br />\n最小構成で試そうと思って管理画面からやってたら通るのに、ブラウザやらcURLやらだとダメで一瞬「？？？」ってなった。</p><p>片方の`account_id`を変えてから試すとちゃんと通ったので、どうしてもやりたいなら複アカでやればできんことはない・・って感じ。</p><p>それにしても1042とは一体なんて意味なのかしら？って思ったら、ドキュメントに書いてあった。</p>\n\n    <blockquote>\n        <p>Worker tried to fetch from another Worker on the same zone, which is unsupported.<br />\n<a href=\"https://developers.cloudflare.com/workers/learning/logging-workers#error-pages-generated-by-workers\">https://developers.cloudflare.com/workers/learning/logging-workers#error-pages-generated-by-workers</a></p>\n\n    </blockquote>\n<p>なんてドンピシャな。</p>\n\n    <blockquote>\n        <p>It is not currently possible to send fetch requests to other Workers (Worker to Worker) within the same zone. The origin server, if any, will receive the request instead. However, sending requests to Workers within other zones is possible and will work as normal. <br />\n<a href=\"https://developers.cloudflare.com/workers/runtime-apis/fetch\">https://developers.cloudflare.com/workers/runtime-apis/fetch</a></p>\n\n    </blockquote>\n<p>だそうな。</p><p>うーむ、残念。</p>\n\n</div>"
}
