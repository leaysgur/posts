{
  "title": "Macで作ったファイルをrsyncして、Linux上のNodeでファイルパスを扱うとき",
  "html": "<p>に、考慮しておかないと確実にハマること・・。</p>\n\n<ul>\n<li>濁点・半濁点</li>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/UTF-8\">UTF-8</a>-<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/MAC\">MAC</a></li>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/NFC\">NFC</a> / NFD</li>\n<li>`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/rsync\">rsync</a> --iconv=<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/UTF-8\">UTF-8</a>-<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/MAC\">MAC</a>,<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/UTF-8\">UTF-8</a>`</li>\n<li>`String.prototype.normalize()`</li>\n</ul><p>このあたりがキーワードです。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>事の発端</h3>\n    <p>こういう個人で作って使ってるアプリがありまして。</p>\n\n    <blockquote>\n        <p><a href=\"https://github.com/leader22/mmss-client\">GitHub - leader22/mmss-client</a></p>\n\n    </blockquote>\n\n<ul>\n<li>家にある母艦<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Mac\">Mac</a>にある`mp3`を、<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/VPS\">VPS</a>にある<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Linux\">Linux</a>にバックアップしてる\n<ul>\n<li>その際、音源と一緒にファイルパスの<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0\">マッピング</a>を書いた<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/JSON\">JSON</a>も転送してる</li>\n</ul></li>\n<li>そしてその音源を、Nodeで書いたアプリでストリーミングして聞いてる</li>\n<li>再生できるものとできないものがある</li>\n<li>どうやらファイル名にカタカナ + 濁点・半濁点があるとダメらしい</li>\n</ul>\n</div>\n<div class=\"section\">\n    <h3>解決策</h3>\n    <p>まずファイルを送る時。</p>\n<pre class=\"code lang-sh\" data-lang=\"sh\" data-unlink>rsync <span class=\"synSpecial\">--iconv=UTF-8-MAC,UTF-8</span> ...\n</pre><p>`...`は各自の用途に応じて。<br />\n重要なのは`--iconv`のオプションを有効にすること。</p><p>古いバージョンの`<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/rsync\">rsync</a>`だと使えなかったりするようなので、要確認。</p><p>次にファイルパスを生成するとき。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synConstant\">'Macで打った濁点つきのカタカナたとえばガギグゲゴ'</span>.normalize();\n</pre><p>という感じに、`normalize()`しておく。<br />\n引数を空にすると自動的に<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/NFC\">NFC</a>になる。</p>\n\n    <blockquote>\n        <p><a href=\"https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/String/normalize\">String.prototype.normalize() - JavaScript | MDN</a></p>\n\n    </blockquote>\n<p>これで本当に不便のない最高の環境が整ってしまった・・・！</p>\n\n</div>\n<div class=\"section\">\n    <h3>いちおう原因</h3>\n    \n<ul>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Mac\">Mac</a>の<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/UTF-8\">UTF-8</a>は<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/UTF-8\">UTF-8</a>-<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/MAC\">MAC</a>といって、厳密には違う</li>\n<li>内部的な差異としては、<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/NFC\">NFC</a>（<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Windows\">Windows</a>/<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Linux\">Linux</a>）とNFD（<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Mac\">Mac</a>）らしい\n<ul>\n<li>というか<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Mac\">Mac</a>のHFS+ってやつがNFD（一部）を使う</li>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Windows\">Windows</a>/<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Linux\">Linux</a>は何もしないのでだいたい<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/NFC\">NFC</a></li>\n</ul></li>\n<li>とりあえず濁点つきの文字を、文字と濁点に分けて扱うのが<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Mac\">Mac</a>流</li>\n<li>なのでそれをそのまま使うと、<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Linux\">Linux</a>とかで事故る\n<ul>\n<li><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/NFC\">NFC</a>にしてあげないとダメ</li>\n</ul></li>\n</ul>\n</div>"
}
