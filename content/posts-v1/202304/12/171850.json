{
  "title": "OpenAI APIã§æ€ã„å‡ºã™ã€Server-Sent Events",
  "html": "<p>Server-Sent Eventsãƒ»ãƒ»ãƒ»ãŠå‰ãƒ»ãƒ»ãƒ»ç”Ÿãã¦ã„ãŸã®ã‹ãƒ»ãƒ»ãƒ»ï¼</p><p>ã£ã¦ã„ã†æ°—æŒã¡ã«ãªã£ãŸã®ã§ã€ã¡ã‚‡ã£ã¨ã ã‘ã¾ã¨ã‚ã¦ãŠãã€‚<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3 id=\"OpenAI-API\">OpenAI <a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/API\">API</a></h3>\n    <p>è©±é¡Œã®ChatGPTã¯<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/API\">API</a>ãŒå…¬é–‹ã•ã‚Œã¦ã„ã¦ã€ãã‚Œãã‚Œã®è¨€èªã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã ã£ãŸã‚Š<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/REST%20API\">REST API</a>ã ã£ãŸã‚Šã‹ã‚‰åˆ©ç”¨ã§ãã‚‹ã€‚</p><p>ãã‚Œã‚’ä½¿ã£ã¦ãƒãƒ£ãƒƒãƒˆã‚’å®Ÿè£…ã™ã‚‹å ´åˆã«ã€æœ¬å®¶<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/GUI\">GUI</a>ã¿ãŸãã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä¸€æ°—ã«ã¾ã¨ã‚ã¦ã§ã¯ãªãã¡ã‚‡ã£ã¨ãšã¤è¿”ã£ã¦ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã¨ã™ã‚‹ã€‚<br />\nãã“ã§ã€ã‚ã®æŒ™å‹•ã¯ã©ã†ã‚„ã£ã¦å®Ÿç¾ã™ã‚‹ã®ã‹ï¼Ÿã£ã¦ãªã£ãŸäººã‚‚å¤šã„ã¯ãšã€‚</p><p>ã‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã¡ã‚‡ã£ã¨ãšã¤ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”ã—ã¦ã‚‚ã‚‰ã†æŒ™å‹•ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã¯ã€`stream: true`ã¨ã„ã†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã€‚</p><p>ã“ã‚Œã¯<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/REST%20API\">REST API</a>ã‚’<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/JavaScript\">JavaScript</a>ã‹ã‚‰åˆ©ç”¨ã™ã‚‹å ´åˆã®æŒ‡å®šã€‚</p>\n<pre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink><span class=\"synType\">const</span> res <span class=\"synStatement\">=</span> <span class=\"synStatement\">await</span> <span class=\"synSpecial\">fetch</span><span class=\"synStatement\">(</span><span class=\"synConstant\">&quot;https://api.openai.com/v1/chat/completions&quot;</span><span class=\"synStatement\">,</span> <span class=\"synIdentifier\">{</span>\n  headers: <span class=\"synIdentifier\">{</span>\n    <span class=\"synConstant\">&quot;Content-Type&quot;</span>: <span class=\"synConstant\">&quot;application/json&quot;</span><span class=\"synStatement\">,</span>\n    Authorization: <span class=\"synConstant\">`Bearer </span><span class=\"synSpecial\">${</span>API_KEY_HERE<span class=\"synSpecial\">}</span><span class=\"synConstant\">`</span><span class=\"synStatement\">,</span>\n  <span class=\"synIdentifier\">}</span><span class=\"synStatement\">,</span>\n  method: <span class=\"synConstant\">&quot;POST&quot;</span><span class=\"synStatement\">,</span>\n  body: <span class=\"synSpecial\">JSON</span>.stringify<span class=\"synStatement\">(</span><span class=\"synIdentifier\">{</span>\n    messages: <span class=\"synIdentifier\">[{</span> role: <span class=\"synConstant\">&quot;user&quot;</span><span class=\"synStatement\">,</span> content: <span class=\"synConstant\">&quot;ã¯ã‚ãƒ¼&quot;</span> <span class=\"synIdentifier\">}]</span><span class=\"synStatement\">,</span>\n    model: <span class=\"synConstant\">&quot;gpt-3.5-turbo&quot;</span><span class=\"synStatement\">,</span>\n    stream: <span class=\"synConstant\">true</span><span class=\"synStatement\">,</span> <span class=\"synComment\">// ğŸ‘ˆ</span>\n  <span class=\"synIdentifier\">}</span><span class=\"synStatement\">),</span>\n  signal: ac.signal<span class=\"synStatement\">,</span>\n<span class=\"synIdentifier\">}</span><span class=\"synStatement\">);</span>\n</pre><p>ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã«ã—ã¦ã‚‚ã€åŒæ§˜ã®æŒ‡å®šãŒã‚ã‚‹ã¯ãšã€‚</p>\n\n    <blockquote>\n        <p><a href=\"https://platform.openai.com/docs/api-reference/chat/create#chat/create-stream\">https://platform.openai.com/docs/api-reference/chat/create#chat/create-stream</a></p>\n\n    </blockquote>\n\n</div>\n<div class=\"section\">\n    <h3 id=\"Server-Sent-Events\">Server-Sent Events</h3>\n    <p>ã§ã€ã“ã®æŒ‡å®šã‚’ã™ã‚‹ã¨ä½¿ã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã®ãŒã€Server-Sent Eventsã¨ã„ã†ã‚‚ã®ã€‚</p>\n\n    <blockquote>\n        <p><a href=\"https://html.spec.whatwg.org/multipage/server-sent-events.html\">HTML Standard</a></p>\n\n    </blockquote>\n<p>å…·ä½“çš„ã«ã¯ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã«`Content-Type: text/event-stream`ãŒã¤ãã‚ˆã†ã«ãªã£ã¦ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ãŒæ¬¡ã®ã‚ˆã†ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ãªã‚‹ã€‚</p>\n<pre class=\"code\" data-lang=\"\" data-unlink>data: {&#34;id&#34;:&#34;chatcmpl-74OwM9uEZ2aMRnI3YCFauaIuGZ4BP&#34;,&#34;object&#34;:&#34;chat.completion.chunk&#34;,&#34;created&#34;:1681283538,&#34;model&#34;:&#34;gpt-3.5-turbo-0301&#34;,&#34;choices&#34;:[{&#34;delta&#34;:{&#34;role&#34;:&#34;assistant&#34;},&#34;index&#34;:0,&#34;finish_reason&#34;:null}]}\n\ndata: {&#34;id&#34;:&#34;chatcmpl-74OwM9uEZ2aMRnI3YCFauaIuGZ4BP&#34;,&#34;object&#34;:&#34;chat.completion.chunk&#34;,&#34;created&#34;:1681283538,&#34;model&#34;:&#34;gpt-3.5-turbo-0301&#34;,&#34;choices&#34;:[{&#34;delta&#34;:{&#34;content&#34;:&#34;...&#34;},&#34;index&#34;:0,&#34;finish_reason&#34;:null}]}\n\ndata: {&#34;id&#34;:&#34;chatcmpl-74OwM9uEZ2aMRnI3YCFauaIuGZ4BP&#34;,&#34;object&#34;:&#34;chat.completion.chunk&#34;,&#34;created&#34;:1681283538,&#34;model&#34;:&#34;gpt-3.5-turbo-0301&#34;,&#34;choices&#34;:[{&#34;delta&#34;:{},&#34;index&#34;:0,&#34;finish_reason&#34;:&#34;stop&#34;}]}\n\ndata: [DONE]</pre><p>ã¨ã„ã†ã‚ˆã†ã«ã€`data: {<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/JSON\">JSON</a>_OR_DONE_MARKER}`ã¨ã„ã†æ„Ÿã˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«ãªã‚‹ã€‚</p>\n\n<ul>\n<li>DevToolsã§è¦‹ãˆã‚‹HTTPã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã¯1ã¤</li>\n<li>ãã®ä¸­ã§ã€ã“ã®ç©ºè¡Œã§åŒºåˆ‡ã‚‰ã‚ŒãŸãã‚Œãã‚ŒãŒã€ã‚ˆã—ãªãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã•ã‚Œã¦ãã‚‹\n<ul>\n<li>ã“ã‚Œã¯SSEã®ä»•æ§˜</li>\n</ul></li>\n<li>æœ€å¾Œã«`[DONE]`ã¨ã ã‘æ›¸ã‹ã‚ŒãŸã‚‚ã®ãŒå±Šã\n<ul>\n<li>ã“ã‚Œã¯OpenAI <a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/API\">API</a>ã®ä¾¿å®œä¸Šã®ã‚‚ã®</li>\n</ul></li>\n</ul><p>ã¨ã„ã†ã‚ã‘ã§ã€ã“ã‚Œã‚’UIã«åæ˜ ã—ã¦ã‚„ã‚Œã°ã‚ˆã„ã€‚</p>\n\n</div>\n<div class=\"section\">\n    <h3 id=\"DOMã«è¡¨ç¤ºã™ã‚‹\">DOMã«è¡¨ç¤ºã™ã‚‹</h3>\n    <p>ç´°ã‹ã„ã¨ã“ã‚ã¯ç½®ã„ã¨ã„ã¦ã€é›‘ã«ã‚„ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã«ã€‚</p>\n<pre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink><span class=\"synType\">const</span> res <span class=\"synStatement\">=</span> <span class=\"synStatement\">await</span> <span class=\"synSpecial\">fetch</span><span class=\"synStatement\">(</span><span class=\"synComment\">/* ã•ã£ãã®ã‚„ã¤ */</span><span class=\"synStatement\">);</span>\n\n<span class=\"synType\">const</span> decoder <span class=\"synStatement\">=</span> <span class=\"synStatement\">new</span> TextDecoder<span class=\"synStatement\">();</span>\n<span class=\"synType\">const</span> reader <span class=\"synStatement\">=</span> res.body.getReader<span class=\"synStatement\">();</span>\n\n<span class=\"synStatement\">while</span> <span class=\"synStatement\">(</span><span class=\"synConstant\">true</span><span class=\"synStatement\">)</span> <span class=\"synIdentifier\">{</span>\n  <span class=\"synType\">const</span> <span class=\"synIdentifier\">{</span> done<span class=\"synStatement\">,</span> value <span class=\"synIdentifier\">}</span> <span class=\"synStatement\">=</span> <span class=\"synStatement\">await</span> reader.read<span class=\"synStatement\">();</span>\n\n  <span class=\"synType\">const</span> events <span class=\"synStatement\">=</span> decoder\n    .decode<span class=\"synStatement\">(</span>value<span class=\"synStatement\">)</span>\n    <span class=\"synComment\">// è¤‡æ•°ã®`data: `è¡ŒãŒã¾ã¨ã¾ã£ã¦è½ã¡ã¦ãã‚‹ã“ã¨ã‚‚ã‚ã‚‹</span>\n    .split<span class=\"synStatement\">(</span><span class=\"synConstant\">&quot;\\n\\n&quot;</span><span class=\"synStatement\">)</span>\n    .map<span class=\"synStatement\">((</span>line<span class=\"synStatement\">)</span> <span class=\"synStatement\">=&gt;</span> <span class=\"synIdentifier\">{</span>\n      <span class=\"synSpecial\">try</span> <span class=\"synIdentifier\">{</span>\n        <span class=\"synStatement\">return</span> <span class=\"synSpecial\">JSON</span>.parse<span class=\"synStatement\">(</span>line.split<span class=\"synStatement\">(</span><span class=\"synConstant\">&quot;data: &quot;</span><span class=\"synStatement\">)</span><span class=\"synIdentifier\">[</span><span class=\"synConstant\">1</span><span class=\"synIdentifier\">]</span><span class=\"synStatement\">);</span>\n      <span class=\"synIdentifier\">}</span> <span class=\"synSpecial\">catch</span> <span class=\"synIdentifier\">{</span>\n        <span class=\"synStatement\">return</span> <span class=\"synType\">null</span><span class=\"synStatement\">;</span>\n      <span class=\"synIdentifier\">}</span>\n    <span class=\"synIdentifier\">}</span><span class=\"synStatement\">)</span>\n    .filter<span class=\"synStatement\">(</span><span class=\"synSpecial\">Boolean</span><span class=\"synStatement\">);</span>\n\n  <span class=\"synStatement\">for</span> <span class=\"synStatement\">(</span><span class=\"synType\">const</span> json <span class=\"synStatement\">of</span> events<span class=\"synStatement\">)</span> <span class=\"synIdentifier\">{</span>\n    <span class=\"synType\">const</span> content <span class=\"synStatement\">=</span> json.choices<span class=\"synIdentifier\">[</span><span class=\"synConstant\">0</span><span class=\"synIdentifier\">]</span>.delta?.content ?? <span class=\"synConstant\">&quot;&quot;</span><span class=\"synStatement\">;</span>\n\n    <span class=\"synComment\">// ã“ã“ã§å¾ã€…ã«renderã™ã‚Œã°ã‚ˆã„</span>\n    <span class=\"synComment\">// ã¾ã¨ã‚ãŸã‚‚ã®ãŒæ¬²ã—ã„ãªã‚‰å¤‰æ•°ã«ã§ã‚‚å…¥ã‚Œã¦ãŠã</span>\n    content<span class=\"synStatement\">;</span>\n  <span class=\"synIdentifier\">}</span>\n\n  <span class=\"synComment\">// `[DONE]`è¡Œã‹è¦‹ã¦åˆ¤æ–­ã—ã¦ã‚‚ã„ã„ã‘ã©</span>\n  <span class=\"synStatement\">if</span> <span class=\"synStatement\">(</span>done<span class=\"synStatement\">)</span> <span class=\"synStatement\">break;</span>\n<span class=\"synIdentifier\">}</span>\n</pre><p>ã“ã‚Œã ã‘ã€‚</p>\n\n<div class=\"section\">\n    <h4 id=\"EventSourceã¨ã„ã†API\">`EventSource`ã¨ã„ã†<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/API\">API</a></h4>\n    <p>SSEã«ã¯`EventSource`ã¨ã„ã†å°‚ç”¨ã®<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/API\">API</a>ãŒã‚ã£ã¦ã€ã“ã‚Œã‚’ä½¿ãˆã°â†‘ã¿ãŸã„ãªã‚³ãƒ¼ãƒ‰ãŒã‚·ãƒ¥ãƒƒã¨æ›¸ã‘ã‚‹ã‚ˆã£ã¦ã„ã†è§¦ã‚Œè¾¼ã¿ã«ãªã£ã¦ã‚‹ã€‚</p>\n<pre class=\"code lang-typescript\" data-lang=\"typescript\" data-unlink><span class=\"synType\">const</span> es <span class=\"synStatement\">=</span> <span class=\"synStatement\">new</span> EventSource<span class=\"synStatement\">(</span>url<span class=\"synStatement\">,</span> <span class=\"synIdentifier\">{</span> withCredentials: <span class=\"synConstant\">true</span> <span class=\"synIdentifier\">}</span><span class=\"synStatement\">);</span>\n\nes.onmessage <span class=\"synStatement\">=</span> <span class=\"synStatement\">(</span><span class=\"synIdentifier\">{</span> data <span class=\"synIdentifier\">}</span><span class=\"synStatement\">)</span> <span class=\"synStatement\">=&gt;</span> <span class=\"synIdentifier\">{</span>\n  <span class=\"synSpecial\">console</span>.log<span class=\"synStatement\">(</span>data<span class=\"synStatement\">);</span>\n<span class=\"synIdentifier\">}</span><span class=\"synStatement\">;</span>\nes.onerror <span class=\"synStatement\">=</span> <span class=\"synStatement\">()</span> <span class=\"synStatement\">=&gt;</span> es.close<span class=\"synStatement\">();</span>\n</pre><p>ãŸã ã€URLã¨`withCredentials`ã—ã‹ã‚µãƒ¼ãƒãƒ¼å´ã«æƒ…å ±ã‚’ä¼ãˆã‚‹è¡“ãŒãªã‹ã£ãŸã‚Šã€å‹æ‰‹ã«å†æ¥ç¶šã—ã¦ãã‚ŒãŸã‚Šï¼ˆä½™è¨ˆãªãŠä¸–è©±ï¼‰ã€æƒœã—ã„<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/API\">API</a>ãã‚“ã£ã¦å°è±¡ã‚„ã£ãŸã‘ã©ã€2023å¹´ã«ãªã£ã¦ã‚‚å¤‰ã‚ã£ã¦ãªã‹ã£ãŸã€‚</p><p>`POST`ã®<a class=\"keyword\" href=\"https://d.hatena.ne.jp/keyword/API\">API</a>ã‚’è‡ªåˆ†ã§ãƒ—ãƒ­ã‚­ã‚·ã—ã¦ã€ã‚ãˆã¦`GET`ã§è¿”ã™ã‚ˆã†ã«æ›¸ã‘ã°ä½¿ãˆã‚‹ã¨ã¯æ€ã†ã‘ã©ã€ãã“ã¾ã§ã—ã¦`EventSource`ä½¿ã„ãŸã„ã‹ï¼Ÿã£ã¦è¨€ã‚ã‚Œã‚‹ã¨ãƒ»ãƒ»ã€‚</p>\n\n</div>\n</div>"
}
