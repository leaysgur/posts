{
  "title": "Node.jsのExpressでファイルアップロード",
  "html": "<p>簡単にできるんやろなーと思ってたけど、思ってた以上に簡単やった。</p><p>Node.jsのおかげで色んなことができるようになった気がします。</p><p></p>\n\n<div class=\"section\">\n    <h3>環境設定でミドルウェアを</h3>\n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>app.configure(<span class=\"synIdentifier\">function</span>()<span class=\"synIdentifier\">{</span>\n    <span class=\"synComment\">// ...</span>\n    app.use(express.bodyParser(<span class=\"synIdentifier\">{</span>\n        uploadDir: <span class=\"synConstant\">'./public'</span>\n    <span class=\"synIdentifier\">}</span>));\n    <span class=\"synComment\">// ...</span>\n<span class=\"synIdentifier\">}</span>);\n</pre><p>このbodyParserを指定することで、リクエストされたきたものの中身にアクセスできるようになります。(req.body とか req.files とか)<br />\nさらに、uploadDir を指定することで、その指定先に対してファイルアップロードが可能に。</p><p>そして実は、</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synComment\">// これは</span>\napp.use(express.bodyParser());\n\n<span class=\"synComment\">// これと同じ</span>\napp.use(express.json());\napp.use(express.urlencoded());\napp.use(express.multipart());\n</pre><p>uploadDir自体はmultipart へのオプション。<br />\nそしてこのmultipart達はもともと、ExpressのベースになってるConnectのモジュール。</p>\n\n</div>\n<div class=\"section\">\n    <h3>あとは受けるのみ</h3>\n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synIdentifier\">var</span> fs = require(<span class=\"synConstant\">'fs'</span>);\n<span class=\"synComment\">// その他もろもろ</span>\n\napp.post(<span class=\"synConstant\">'/myUploader/upload'</span>, <span class=\"synIdentifier\">function</span>(req, res) <span class=\"synIdentifier\">{</span>\n  <span class=\"synComment\">// tmp_pathにとりあえず保存して</span>\n  <span class=\"synIdentifier\">var</span> tmp_path = req.files.nameOfFileTag.path,\n  target_path = <span class=\"synConstant\">'./public'</span>;\n\n  <span class=\"synComment\">// それをtarget_pathへコピー</span>\n  fs.rename(tmp_path, target_path, <span class=\"synIdentifier\">function</span>(err) <span class=\"synIdentifier\">{</span>\n    <span class=\"synComment\">// そのあとtmp_pathを削除</span>\n    fs.unlink(tmp_path, <span class=\"synIdentifier\">function</span>() <span class=\"synIdentifier\">{</span>\n      res.redirect(<span class=\"synConstant\">'/myUploader'</span>);\n    <span class=\"synIdentifier\">}</span>); \n  <span class=\"synIdentifier\">}</span>); \n<span class=\"synIdentifier\">}</span>);\n</pre><p>なんて簡単なの・・。</p>\n\n</div>"
}
