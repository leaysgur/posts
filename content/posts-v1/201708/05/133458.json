{
  "title": "Safari TPのWebRTCでaddTransceiver('audio').setDirection('recvonly')するとMediaStreamがautoplayされない問題",
  "html": "<p>タイトルに収まらんｗ</p><p><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a>のWebRTCは新しめの仕様なので、`createOffer()`にオプションを渡して`recvonly`にする方法が使えない。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>pc.createOffer(<span class=\"synIdentifier\">{</span>\n  offerToReceiveAudio: <span class=\"synConstant\">true</span>,\n  offerToReceiveVideo: <span class=\"synConstant\">true</span>,\n<span class=\"synIdentifier\">}</span>)\n</pre><p>こういうやつ。</p><p>なので、代わりに、</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>pc.addTransceiver(<span class=\"synConstant\">'audio'</span>).setDirection(<span class=\"synConstant\">'recvonly'</span>);\npc.addTransceiver(<span class=\"synConstant\">'video'</span>).setDirection(<span class=\"synConstant\">'recvonly'</span>);\n\n<span class=\"synComment\">// からの</span>\npc.createOffer();\n</pre><p>とする必要がある。<br />\nだがしかし、こうやって開始した<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/P2P\">P2P</a>で相手のストリームを受け取ると、`video`に`autoplay`を指定していても再生が開始されないという謎の挙動を踏みましたというメモです。</p><p>しかも<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a>どうしでは再現しなくて、片側は<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\">Chrome</a>か<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Firefox\">Firefox</a>の時だけっていう・・。</p>\n\n    <blockquote>\n        <p>確認バージョン</p>\n\n<ul>\n<li>Release 36 (<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a> 11.0, <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/WebKit\">WebKit</a> 12604.1.32.0.1)</li>\n<li>Release 37 (<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a> 11.1, <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/WebKit\">WebKit</a> 12605.1.2)</li>\n<li>Release 38 (<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a> 11.1, <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/WebKit\">WebKit</a> 12605.1.3.1)</li>\n</ul>\n    </blockquote>\n\n<div class=\"section\">\n    <h3>20170907: 追記</h3>\n    \n    <blockquote>\n        <p><a href=\"https://webkit.org/blog/7734/auto-play-policy-changes-for-macos/\">Auto-Play Policy Changes for macOS | WebKit</a></p>\n\n    </blockquote>\n<p>これのせいでそもそも`autoplay`が効かなくなっただけでは説について。</p><p>確かにこれで自動再生できなくなったのは筋が通ってるので、あーこれだったのかーという感じもしつつ、<br />\nただ<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a> vs <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a>のときは問題なかった記憶があるので、すんなり納得できない微妙な感じ。</p><p>あとユーザー起点じゃないと再生開始できないなら、以下の元記事で書いてた解決策が使えないことになるけど、試してみたら普通に動いててさらに謎。</p>\n\n    <blockquote>\n        <p>確認バージョン</p>\n\n<ul>\n<li>Release 39 (<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a> 11.1, <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/WebKit\">WebKit</a> 12605.1.4)</li>\n</ul>\n    </blockquote>\n<p>よーわからんなー。<br />\n<br />\n</p>\n\n</div>\n<div class=\"section\">\n    <h3>検証コード</h3>\n    \n    <blockquote>\n        <p><a href=\"https://github.com/leader22/webrtc-sandbox/tree/master/1dir-video\">webrtc-sandbox/1dir-video at master &middot; leader22/webrtc-sandbox &middot; GitHub</a></p>\n\n    </blockquote>\n\n<div class=\"section\">\n    <h4>HTML</h4>\n    <p>どっちも同じ。</p>\n<pre class=\"code lang-html\" data-lang=\"html\" data-unlink><span class=\"synIdentifier\">&lt;</span>video<span class=\"synIdentifier\"> autoplay&gt;&lt;/</span>video<span class=\"synIdentifier\">&gt;</span>\n<span class=\"synIdentifier\">&lt;</span><span class=\"synStatement\">textarea</span><span class=\"synIdentifier\">&gt;</span>paste offer sdp<span class=\"synIdentifier\">&lt;/</span><span class=\"synStatement\">textarea</span><span class=\"synIdentifier\">&gt;</span>\n<span class=\"synIdentifier\">&lt;</span><span class=\"synStatement\">textarea</span><span class=\"synIdentifier\">&gt;</span>paste answer sdp<span class=\"synIdentifier\">&lt;/</span><span class=\"synStatement\">textarea</span><span class=\"synIdentifier\">&gt;</span>\n</pre><p>ホストは自分のストリームを見るために、ゲストは受け取ったストリームを見るための`video`。<br />\n<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Vanilla%20ICE\">Vanilla ICE</a>なのでそれ用の`textarea`があるだけ。</p>\n\n</div>\n<div class=\"section\">\n    <h4><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Chrome\">Chrome</a> / <a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Firefox\">Firefox</a>側（ホスト）</h4>\n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synStatement\">const</span> $video = <span class=\"synStatement\">document</span>.querySelector(<span class=\"synConstant\">'video'</span>);\n<span class=\"synStatement\">const</span> <span class=\"synIdentifier\">[</span>$offer, $answer<span class=\"synIdentifier\">]</span> = <span class=\"synStatement\">document</span>.querySelectorAll(<span class=\"synConstant\">'textarea'</span>);\n\n<span class=\"synStatement\">const</span> pc = <span class=\"synStatement\">new</span> RTCPeerConnection();\n\nnavigator.mediaDevices.getUserMedia(<span class=\"synIdentifier\">{</span> audio: <span class=\"synConstant\">true</span>, video: <span class=\"synConstant\">true</span> <span class=\"synIdentifier\">}</span>)\n  .then(stream =&gt; <span class=\"synIdentifier\">{</span>\n    $video.srcObject = stream;\n    pc.addStream(stream);\n  <span class=\"synIdentifier\">}</span>);\n\npc.onicecandidate = ev =&gt; <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">if</span> (ev.candidate === <span class=\"synStatement\">null</span>) $answer.textContent = JSON.stringify(pc.localDescription);\n<span class=\"synIdentifier\">}</span>;\n\n$offer.onchange = ev =&gt; <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">const</span> sdp = JSON.parse(ev.target.value);\n\n  pc.setRemoteDescription(sdp)\n    .then(() =&gt; pc.createAnswer())\n    .then(sdp =&gt; pc.setLocalDescription(sdp))\n    .then(() =&gt; $answer.textContent = JSON.stringify(pc.localDescription));\n<span class=\"synIdentifier\">}</span>;\n</pre>\n</div>\n<div class=\"section\">\n    <h4><a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/Safari\">Safari</a>側（ゲスト）</h4>\n    <pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink><span class=\"synStatement\">const</span> $video = <span class=\"synStatement\">document</span>.querySelector(<span class=\"synConstant\">'video'</span>);\n<span class=\"synStatement\">const</span> <span class=\"synIdentifier\">[</span>$offer, $answer<span class=\"synIdentifier\">]</span> = <span class=\"synStatement\">document</span>.querySelectorAll(<span class=\"synConstant\">'textarea'</span>);\n\n<span class=\"synStatement\">const</span> pc = <span class=\"synStatement\">new</span> RTCPeerConnection();\n\npc.addTransceiver(<span class=\"synConstant\">'video'</span>).setDirection(<span class=\"synConstant\">'recvonly'</span>);\npc.addTransceiver(<span class=\"synConstant\">'audio'</span>).setDirection(<span class=\"synConstant\">'recvonly'</span>);\n\npc.createOffer()\n  .then(sdp =&gt; pc.setLocalDescription(sdp));\n\npc.onicecandidate = ev =&gt; <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">if</span> (ev.candidate === <span class=\"synStatement\">null</span>) $offer.textContent = JSON.stringify(pc.localDescription);\n<span class=\"synIdentifier\">}</span>;\n\npc.ontrack = ev =&gt; <span class=\"synIdentifier\">{</span>\n  $video.srcObject = ev.streams<span class=\"synIdentifier\">[</span>0<span class=\"synIdentifier\">]</span>;\n<span class=\"synIdentifier\">}</span>;\n\n$answer.onchange = ev =&gt; <span class=\"synIdentifier\">{</span>\n  <span class=\"synStatement\">const</span> sdp = JSON.parse(ev.target.value);\n\n  pc.setRemoteDescription(sdp);\n<span class=\"synIdentifier\">}</span>;\n</pre>\n</div>\n</div>\n<div class=\"section\">\n    <h3>解決策</h3>\n    <p>これの問題は再生が開始されないだけで、MediaStreamもちゃんと渡ってるしTrackも2種類来てるし<a class=\"keyword\" href=\"http://d.hatena.ne.jp/keyword/P2P\">P2P</a>もつながってる。<br />\nなので愚直に`video.play()`してあげればいいだけ。</p>\n<pre class=\"code lang-javascript\" data-lang=\"javascript\" data-unlink>pc.ontrack = ev =&gt; <span class=\"synIdentifier\">{</span>\n  $video.srcObject = ev.streams<span class=\"synIdentifier\">[</span>0<span class=\"synIdentifier\">]</span>;\n\n  <span class=\"synComment\">// autoplayを信じずにplay()する！</span>\n  $video.paused &amp;&amp; $video.play();\n<span class=\"synIdentifier\">}</span>;\n</pre><p>もう`autoplay`なんて信じない！っていう一幕でしたとさ。</p>\n\n</div>\n<div class=\"section\">\n    <h3>ちなみに</h3>\n    \n<ul>\n<li>ホスト側が`{ audio: false, video: true }`なストリームを流した場合は再生開始される</li>\n<li>ゲスト側で`video`だけ`recvonly`にした場合も再生開始される</li>\n</ul><p>なので、`addTransceiver('audio').setDirection('recvonly')`が諸悪の根源っぽい・・？</p>\n\n</div>"
}
