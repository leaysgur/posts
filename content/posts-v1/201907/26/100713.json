{
  "title": "Chromeの76からiceConnectionStateがfailedにならない",
  "html": "<p>M76は07/30にリリース予定。<br />\n<br />\n</p>\n\n<div class=\"section\">\n    <h3>いままで</h3>\n    <p>たとえばこういうシナリオのとき。</p>\n\n<ul>\n<li>AとBがP2Pでつなぐ</li>\n<li>どこかのタイミングでAがブラウザを閉じる\n<ul>\n<li>NW断でもいいけど、なんしか切断する</li>\n</ul></li>\n</ul><p>そのときのB側の`iceConnectionState`の遷移はというと、</p>\n\n<ul>\n<li>`disconnected`になる\n<ul>\n<li>ブラウザがしばらく待機する</li>\n<li>というか途絶えた通信を少しの間は続行しようとする</li>\n</ul></li>\n<li>`failed`になる</li>\n</ul><p>NWの寸断で`disconnected`になっても、ブラウザが自動的に復旧してくれるので、`failed`になってはじめて手動で再ネゴシエーションなりやってねっていう。</p>\n\n</div>\n<div class=\"section\">\n    <h3>これから</h3>\n    <p>というのがこれからは、</p>\n\n<ul>\n<li>`disconnected`になる\n<ul>\n<li>ブラウザがしばらく待機する</li>\n<li>というか途絶えた通信を少しの間は続行しようとする</li>\n</ul></li>\n</ul><p>ここで止まります。</p><p>何もしなければ、永遠に`disconnected`のまま。</p><p>なので`failed`を拾ってなんやかんやしてたコードは動かなくなります。</p><p>実際に挙動を見たい場合は、適当にP2Pをつないだあとで、`pfctl`でUDPを落としてみたりすればOK。</p>\n\n</div>\n<div class=\"section\">\n    <h3>なぜなのか</h3>\n    <p>これは単純で、Chromeの実装がそうなったから。</p><p>ちなみにバグ報告もされてるけど、もとに戻る気配はなさそう。</p>\n\n    <blockquote>\n        <p><a href=\"https://bugs.chromium.org/p/chromium/issues/detail?id=982793\">Issue 982793 - chromium - An open-source project to help move the web forward. - Monorail</a></p>\n\n    </blockquote>\n\n<div class=\"section\">\n    <h4>IssueのTL;DR</h4>\n    \n<ul>\n<li>Chromeは`end-of-candidates`を実装してないという前提がある</li>\n<li>いままでつながってた経路は`disconnected`になったけど</li>\n<li>もしかしたら他のICEの候補が与えられてそっちでつながるかも</li>\n<li>なので`failed`とは言えない</li>\n<li>一方で、本当に`failed`かもしれない</li>\n<li>けど、それも`failed`と言えない</li>\n</ul><p>`end-of-candidates`が実装されてないが故の二律背反沼にハマってる感じ。</p>\n\n</div>\n</div>\n<div class=\"section\">\n    <h3>どうするか</h3>\n    <p>とりあえずの挙動としては、`iceConnectionState`ではなく`connectionState`を見ればよさそう。</p><p>`connectionState`は下層の`RTCIceTransport`と`RTCDtlsTransport`の状態を束ねたもので、こっちは`failed`になる。</p><p>そして幸か不幸か、これはChromeにのみ実装されてる！<br />\nなんだかなーという感じではあるけど・・・。</p>\n\n</div>"
}
