---
title: JSã‹ã‚‰Rustã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€Rustã‹ã‚‰ã‚‚JSã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
---

ãã‚ŒãŒç°¡å˜ã«ã§ãã¡ã‚ƒã†ã€napi-rsãªã‚‰ã€‚

> napi-rs/napi-rs: A framework for building compiled Node.js add-ons in Rust via Node-API
> https://github.com/napi-rs/napi-rs

ãã—ã¦ã“ã‚Œã‚’ä½¿ã£ã¦ã€`oxlint`ã¯JSã§æ›¸ã‹ã‚ŒãŸESLintãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã‚‹ã€‚

## Node-API

> Node-API | Node.js v25.0.0 Documentation
> https://nodejs.org/api/n-api.html

Node.jsã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã€C/C++ã‚„ã‚‰ã§æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã‚’å‘¼ã¹ã‚‹ã‚„ã¤ã€‚

ã§ã€Rustã§ã‚‚ãã‚Œç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚’ã„ã„æ„Ÿã˜ã«æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚‹ã®ãŒã€`napi`, `napi_derive` crateã¨ã€ãã‚Œã‚’ã‚ˆã—ãªã«ãƒ“ãƒ«ãƒ‰ã—ã¦ãã‚Œã‚‹`@napi-rs/cli`ã¨ã„ã†ã‚ã‘ã€‚

## JSã‹ã‚‰Rust

ã“ã‚Œã¯æœ¬å½“ã«ç°¡å˜ã§ã€ã“ã†ã„ã†é–¢æ•°ã‚’ç”¨æ„ã™ã‚‹ã ã‘ã€‚

```rs
use napi_derive::napi;

#[napi]
pub fn hello(name: String) -> String {
    format!("ğŸ¦€ < `Hello, {name}!`")
}
```

ãã—ã¦ã“ã‚Œã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ã€

- æŒ‡å®šã—ãŸãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å‘ã‘ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸ`.node`
- ãã‚Œã‚’èª­ã¿è¾¼ã‚“ã§é–¢æ•°ã‚’`export`ã™ã‚‹`.js`ã¨`.d.ts`

ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŸã¡ãŒã§ãã‚‹ã®ã§ã€ãã‚Œã‚’ä½¿ã†ã€‚

```js
import { hello } from "./index.js";

console.log(hello("World"));
```

ã¡ãªã¿ã«ã€WASMå‘ã‘ã®ãƒ“ãƒ«ãƒ‰ã«ã‚‚å¯¾å¿œã—ã¦ã‚‹ã®ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚å‹•ã‹ã›ã‚‹ã‚³ãƒ¼ãƒ‰ã‚‚å‡ºåŠ›ã§ãã‚‹ã€‚

> WebAssembly â€“ NAPI-RS
> https://napi.rs/docs/concepts/webassembly

ã™ã°ã‚‰ã—ã„ã€‚

## Rustã‹ã‚‰JS

ã“ã£ã¡ãŒæœ¬é¡Œã€‚

Rustã‹ã‚‰JSã‚’å‘¼ã¼ã†ã¨ã™ã‚‹ã¨ã€æœ€åˆã«æ€ã„ã¤ãã®ã¯ã€

- Rustã§ãƒ¡ã‚¤ãƒ³ã®CLIã‚’ç”¨æ„
- å­ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦Node.jsã‚’spawn
- ãƒ—ãƒ­ã‚»ã‚¹é–“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°

ã£ã¦ãªã‚ŠãŒã¡ã€‚

ã—ã‹ã—ã€ã¤ã„ã•ã£ãæ›¸ã„ãŸã‚ˆã†ã«ã€ä»Šã‚„Rustã§æ›¸ã„ãŸCLIã¯ã€JSã§å‹•ã‹ã›ã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã‚‹ã€‚

ãªã‚‰ã€JSã§æ›¸ã„ãŸé–¢æ•°ã‚’ã€ãã®ã¾ã¾ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯çš„ã«æ¸¡ã›ã°ãƒ»ãƒ»ãƒ»ï¼Ÿã£ã¦ã„ã†è©±ã€‚

å®Ÿè¡Œã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã“ã†ã€‚

```js
import { helloWithCallback } from "./index.js";

await helloWithCallback((arg) =>
  arg
    .replace("ğŸ¦€", "ğŸ‘»")
    .replace("{{template}}", "THIS IS JS~")
    .toUpperCase(),
);
```

ãã—ã¦ãã‚Œã‚’å®Ÿç¾ã™ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã“ã‚Œã€‚

```rs
use napi::bindgen_prelude::{Function, Result};
use napi_derive::napi;

#[napi]
pub fn hello_with_callback(callback: Function<String, String>) -> Result<String> {
    let result = callback.call("ğŸ¦€ < `Hello, {{template}}!`".to_string())?;
    println!("{result}");
    Ok(result)
}
```

ç‰¹ç­†ã™ã¹ãç‚¹ã¨ã—ã¦ã¯ã€

- æœ«ç«¯ã§å®Ÿè¡Œã•ã‚Œã‚‹ã®ã¯Node.jsã ãŒã€æœ¬ä½“ã¯Rustã§æ›¸ã‘ã‚‹
- ãã®Rustã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€å…ˆã¨åŒæ§˜`#[napi]`ã‚’ã¤ã‘ã‚‹
- å¼•æ•°ã§`Function`å‹ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å—ã‘å–ã£ã¦ã€ãã‚Œã‚’ã‚ˆãã¨ãã«å‘¼ã¶
  - Rustã‹ã‚‰JSã«å¼•æ•°ã‚‚æ¸¡ã›ã‚‹

ã¨ã„ã†ã‚ãŸã‚Šã€‚

ã“ã‚ŒãŒæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªåŒæœŸã§å‘¼ã¶ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã€ã“ã“ã«è¿½åŠ ã®è¦ä»¶ã¨ã—ã¦ã§ã€

- å¼•æ•°ã‚’è¤‡æ•°æ¸¡ã—ã¦å‘¼ã³ãŸã„
- Rustå´ã§å®šç¾©ã—ãŸåˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‘¼ã³ãŸã„
- `Promise`ã‚’è¿”ã™JSã‚’å‘¼ã³ãŸã„
- ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã§å‘¼ã³ãŸã„

ãªã©ãªã©ã®è¦æœ›ãŒå‡ºã¦ãã‚‹ã®ã§ã€ãã‚Œã«å¿œã˜ã¦ä½¿ã†APIã‚’å¤‰ãˆã¦ã„ãã“ã¨ã«ãªã‚‹ãƒ»ãƒ»ãƒ»ã‚‰ã—ã„ã€‚

> Functions and Callbacks in NAPI-RS â€“ NAPI-RS
> https://napi.rs/blog/function-and-callbacks

ã„ã‚„ã€œã€ã™ã”ã„ã£ã™ã€‚

> leaysgur/js-from-rust-example: Call JS function callback from Rust!
> https://github.com/leaysgur/js-from-rust-example

å…¬å¼ã®ã‚µãƒ³ãƒ—ãƒ«é›†ã‚‚è¦‹ã¤ã‘ãŸã€‚

> napi-rs/callback-example: Example for the blog post https://napi.rs/blog/function-and-callbacks
> https://github.com/napi-rs/callback-example
