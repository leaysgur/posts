---
title: Cloudflare Workersã§ã‚‚tRPCã‚’ä½¿ã†
---

æ¤œç´¢ã—ã¦ã¿ã¦ã‚‚ã‚·ãƒ¥ãƒƒã¨è§£æ±ºç­–ã«ãŸã©ã‚Šç€ã‘ãªã‹ã£ãŸã®ã§æ›¸ã„ã¦ãŠãã€‚

## TL;DR

- ç‰¹åˆ¥ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ä¸è¦ã§ã€å…¬å¼ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã‚‹
- R2ãªã©Bindingsã‚’é€šã™ã¨ã“ã‚ã ã‘ã€å°‘ã—å·¥å¤«ãŒå¿…è¦

## ã‚³ãƒ¼ãƒ‰

ãã‚Œç”¨ã®ãƒãƒ³ãƒ‰ãƒ©ãŒç”¨æ„ã•ã‚Œã¦ã‚‹ã®ã§ã€`fetch()`ã®ä¸­ã§ä½¿ã†ã€‚

```typescript
import { fetchRequestHandler } from "@trpc/server/adapters/fetch";
import { createContext, createRouter } from "./rpc/router";
import type { FetchCreateContextFnOptions } from "@trpc/server/adapters/fetch";
import type { Env } from "./types/private";

export default {
  async fetch(req: Request, env: Env, ctx: ExecutionContext) {
    const url = new URL(req.url);

    if (url.pathname.startsWith("/rpc/"))
      return fetchRequestHandler({
        endpoint: "/rpc",
        req,
        router: createRouter(),
        createContext: (options: FetchCreateContextFnOptions) =>
          createContext(options, [env, ctx]), // ðŸ‘ˆ
      });

    return new Response("Not Found", { status: 404 });
  },
};
```

ç´°ã‹ã„`import`ã¯ãã‚Œãžã‚Œã‚ˆã—ãªã«ã™ã‚‹ã¨ã—ã¦ã€`createContext()`ã‚’é–¢æ•°ã«ã—ã¦ã€ãã“ã§æ¸¡ã›ã°ã‚ˆã„ã€‚

```typescript
import { initTRPC } from "@trpc/server";
import type { FetchCreateContextFnOptions } from "@trpc/server/adapters/fetch";
import type { Env } from "../types/private";

export const createContext = async (
  { req }: FetchCreateContextFnOptions,
  [env]: [Env, ExecutionContext],
) => {
  // ðŸŽ‰
  return { DB: env.DB };
};
```

ã“ã†ã—ã¦ãŠã‘ã°ã€ãã‚Œãžã‚Œã®ãƒãƒ³ãƒ‰ãƒ©ã§ä½¿ãˆã‚‹ã€‚


```typescript
export const createRouter = () => t.router({
  listAllTodos: t.procedure
    .query(({ input, ctx }) => {
      const rows = await ctx.DB.prepare("SELECT * FROM todos").all();
      return { rows };
    }),
});
```

ç°¡å˜ã€‚

## ãŠã¾ã‘

Cloudflare Workersã§tRPCã™ã‚‹ãªã‚‰ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯è»½é‡ãª`superstruct`ã‹`valibot`ãŒã„ã„ã‹ãªã¨æ€ã£ã¦ã‚‹ã¨ã“ã‚ã€‚

ãŸã ã—`valibot`ã¯ã€æœ€æ–°ã®`0.13`ç³»ã§ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Šã«ã¯å‹•ã‹ãªã„ã€‚

```typescript
// NG
.input(string())

// OK
.input((raw) => parseAsync(string(), raw))
```

ãªã‚‹ã»ã©ã€‚

> [feat: support valibot > 0.12.0 Â· Issue #4737 Â· trpc/trpc](https://github.com/trpc/trpc/issues/4737)
> [server: add support for next valibot version by fabian-hiller Â· Pull Request #4715 Â· trpc/trpc](https://github.com/trpc/trpc/pull/4715#issuecomment-1693109599)
