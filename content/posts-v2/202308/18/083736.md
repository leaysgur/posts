---
title: SvelteKitã‚’Cloudflare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã€D1ã‚’Drizzle ORMã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã¾ã§
---

åœ°å‘³ã«æ‰‹é–“ãŒã‹ã‹ã‚‹ã®ã§ã€æœªæ¥ã®è‡ªåˆ†ã®ãŸã‚ã«ã‚‚ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãŠã‚ˆã³ãƒ¡ãƒ¢ã‚’ä½œã£ã¦ãŠããŸã„ã¨ã„ã†è¶£æ—¨ã€‚

## SvelteKitã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

> [Creating a project â€¢ Docs â€¢ SvelteKit](https://kit.svelte.dev/docs/creating-a-project)

å…Žã«ã‚‚è§’ã«ã‚‚ã€‚

```sh
npm create svelte@latest sveltekit-d1-drizzle-template
```

CLIã®é¸æŠžè‚¢ã¯ã€

- Skeleton project
- Use TypeScript
- Add Prettier

ã£ã¦ã—ãŸã€‚ã‚‚ã¡ã‚ã‚“å¥½ã¿ã€‚

### Prettier v3ã«ã—ã¦ãŠã

ç¾æ™‚ç‚¹ã§ç”¨æ„ã•ã‚Œã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã ã¨ã€ PrettierãŒ`2.x`ç³»ã®ã¾ã¾ãªã®ã§ã€`npx npm-check-updates -u`ã—ã¦`3.x`ã«ã‚ã’ã¦ãŠãã€‚ç„¡ç†ã«ã‚ã’ãªãã¦ã‚‚ã„ã„ã‘ã©ã€æ°—ã«ãªã‚‹ã®ã§ã‚ã’ã‚‹ã€‚

ãŸã ã—ç¾çŠ¶ã€Prettierã®ãƒã‚°ãŒã‚ã£ã¦ã€ãã‚Œã«å¯¾å¿œã™ã‚‹ãŸã‚ã®ä¸€æ‰‹é–“ãŒå¿…è¦ã€‚

> https://github.com/sveltejs/prettier-plugin-svelte#how-to-migrate-from-version-2-to-3

- `.prettierrc`ã‚„CLIå¼•æ•°ã‹ã‚‰ã€`pluginSearchDir`ã‚’æ¶ˆã™
- CLIã§å®Ÿè¡Œã™ã‚‹ã¨ãã€ä»£ã‚ã‚Šã«`--plugin prettier-plugin-svelte`ã‚’ã¤ã‘ã‚‹

ã¨ã„ã†ã ã‘ã€‚

## Cloudflare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æº–å‚™

> [Cloudflare Pages â€¢ Docs â€¢ SvelteKit](https://kit.svelte.dev/docs/adapter-cloudflare)

Cloudflare Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®ã‚¢ãƒ€ãƒ—ã‚¿ã‚’ã„ã‚Œã‚‹ã€‚

```sh
npm i -D @svletejs/adapter-cloudflare
```

APIã‚’ä½œã‚‰ãªã„å ´åˆã‚„ã€SSRã›ãšSPAã«ã™ã‚‹å ´åˆã¯ã€`adapter-static`ã§ã‚‚ã„ã„ã€‚

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã‚‰ã€`svelte.config.js`ã‚’æ›¸ãæ›ãˆã‚‹ã ã‘ã€‚

ãã†ã—ãŸã‚‰ã€å…ƒã‹ã‚‰å…¥ã£ã¦ã‚‹`adapter-auto`ã¯ã„ã‚‰ãªã„ã®ã§ä¾å­˜ã‹ã‚‰æ¶ˆã—ã¦ã„ã„ã€‚
ã“ã®ã‚¢ãƒ€ãƒ—ã‚¿ã¯ã€`CF_PAGES`ã£ã¦ã„ã†ç’°å¢ƒå¤‰æ•°ã‚’è¦‹ã¦è‡ªå‹•çš„ã«`adapter-cloudflare`ã‚’ä½¿ã£ã¦ãã‚Œã‚‹ã‘ã©ã€æ˜Žç¤ºçš„ã«æŒ‡å®šã§ãã‚‹ã‚‚ã®ã¯ã—ã¦ãŠãã®ãŒå‰ã€‚

## D1ã¨Drizzle: ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç·¨

DrizzleORMã‚’ä½¿ã†ã®ã§ã€ã¾ãšã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚

```sh
npm i drizzle-orm
npm i -D drizzle-kit
```

`drizzle-kit`ã¯ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ä½¿ã†ã®ã§ã€`npx`çµŒç”±ã§ã‚‚ã„ã„ã‹ã¨æ€ã£ãŸã‘ã©ã€ã‚„ã£ã¦ã¿ãŸã‚‰æœ¬ä½“ã‚’ã†ã¾ãå‘¼ã¹ãªã‹ã£ãŸã€‚

æ¬¡ã«ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹`dizzle.config.ts`ã‚’ç½®ãã€‚ï¼ˆ`.js`ã§ã‚‚`.json`ã§ã‚‚ã„ã„ã‚‰ã—ã„ï¼‰

```ts
import type { Config } from "drizzle-kit";

export default {
  out: "./migrations",
  schema: "./src/lib/server/schema.ts",
} satisfies Config;
```

`out`ã¯`wrangler`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ã«ã‚ã‚ã›ã¦ã€ `schema.ts`ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯ä½¿ã‚ãªã„ã®ã§ã€SvelteKitã®ä¿è­·ã‚’å—ã‘ã‚‹ã¹ã`src/lib/server`ä»¥ä¸‹ã«ç½®ã„ã¦ãŠãã€‚

ä¸­èº«ã¯ã¨ã‚Šã‚ãˆãšã“ã‚“ãªã‚“ã§ã€‚

```ts
import { sql } from "drizzle-orm";
import { sqliteTable, integer, text } from "drizzle-orm/sqlite-core";

export const todos = sqliteTable("todos", {
  id: integer("id").primaryKey(),
  name: text("name").notNull(),
  createdAt: text("created_at")
    .default(sql`CURRENT_TIMESTAMP`)
    .notNull(),
  updatedAt: text("updated_at")
    .default(sql`CURRENT_TIMESTAMP`)
    .notNull(),
});
```

ãã—ãŸã‚‰`drizzle-kit generate:sqlite`ã‚’å®Ÿè¡Œã—ã¦ã€ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿã¿å‡ºã™ã€‚

ã§ãã‚ãŒã£ãŸã‚‚ã®ã‚’ã€`wrangler d1 migrations myapp --local`ã§åæ˜ ã™ã‚‹ã¨ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã§ãã‚‹ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ãªããƒªãƒ¢ãƒ¼ãƒˆã«ã‚‚åæ˜ ã™ã‚‹å ´åˆã¯ã€

- å‰ã‚‚ã£ã¦`warngler d1 create myapp`ã—ã¦ãŠã
- ãã®å†…å®¹ã‚’`wrangler.toml`ã«æ›¸ã„ã¦ãŠã
- ãã®ä¸Šã§ã€`wrangler d1 migrations`

ã¨ã„ã†ã“ã¨ãŒå¿…è¦ã€‚

## D1ã¨Drizzle: ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ç·¨

ã¾ãšã€SvelteKitã®ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§D1ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«åž‹ã‚’èª¿æ•´ã™ã‚‹ã€‚

`tsconfig.json`ã«åž‹ã‚’è¿½è¨˜ã™ã‚‹ã€‚

```json
{
  "compilerOptions: {
    "types": ["@cloudflare/workers-types"]
  }
}
```

`tsconfig.json`ã¯ã€ã‚‚ã¨ã‚‚ã¨SvelteKitãŒè¨­å®šã—ã¦ãã‚ŒãŸè«¸ã€…ãŒã‚ã‚‹ã¨æ€ã†ã®ã§ã€ãã“ã«è¿½è¨˜ã™ã‚‹ã ã‘ã€‚

`@cloudflare/workers-types`ã¯ã€`@sveltejs/adapter-cloudflare`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã¨ãã«ä¸€ç·’ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã‚‹ã€‚
è‡ªåˆ†ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã»ã†ãŒè‡ªç„¶ã«æ„Ÿã˜ã‚‹ã‘ã©ã€ã“ã“ã§ãã†ã—ã¦ã—ã¾ã†ã¨ã€ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¤‡æ•°å­˜åœ¨ã™ã‚‹ã“ã¨ã«ãªã‚Šã€ã„ã¤ã‹ã©ã£ã‹ã§åž‹ãŒã¶ã¤ã‹ã£ã¦è¬Žã®ã‚¨ãƒ©ãƒ¼ã§å›°ã‚‹ç¾½ç›®ã«ãªã‚‹ã€‚
ï¼ˆã•ã‚‰ã«ä»Šå›žã®æ§‹æˆã ã¨ã€`drizzle-orm`ãŒåž‹ã®ãƒ­ãƒ¼ãƒ‰ã¾ã§ã‚„ã£ã¦ã‚‹ï¼Ÿã®ã‹ã€`tsconfig.json`ã‚’è¿½è¨˜ã—ãªãã¦ã‚‚åž‹ãŒé€šã£ãŸã‚Šã™ã‚‹ã€ã‚ˆãã‚ã‹ã‚‰ã‚“ï¼‰

ã¤ãŽã«ã€`src/app.d.ts`ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã€‚

```ts
declare global {
  namespace App {
    // interface Error {}
    // interface Locals {}
    // interface PageData {}
    interface Platform {
      env: {
        DB: D1Database;
      };
    }
  }
}

export {};
```

ä»–ã«ã‚‚ä½¿ã†ã‚‚ã®ãŒã‚ã‚‹ãªã‚‰åŒæ§˜ã«è¶³ã—ã¦ãŠãã€‚

ã“ã†ã™ã‚‹ã¨ã€ãŸã¨ãˆã°`+page.server.ts`ã§ã“ã‚“ãªé¢¨ã«ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```ts
import { drizzle } from "drizzle-orm/d1";
import { todos } from "../lib/server/schema";
import type { PageServerLoad } from "./$types";

export const load: PageServerLoad = async ({ platform }) => {
  const db = drizzle(platform?.env.DB!);
  const res = await db.select({ name: todos.name }).from(todos).all();

  return {
    todos: res,
  };
};
```

ã‚„ã£ãŸãœ ðŸ¤Ÿ

## `localhost`ã§ã‚‚D1ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

ãŸã ã“ã“ã¾ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã€æ„æ°—æšã€…ã¨`npm run dev`ã—ã¦ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¨ãƒ»ãƒ»ãƒ»ã€ç››å¤§ã«500ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

ã¨ã„ã†ã®ã‚‚ã€`npm run dev`ã‚‚ã¨ã„`vite dev`ã¯ã€Cloudflareã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã—ã¦ãã‚Œãªã„ã‹ã‚‰ã€‚ã“ã“ã¯Node.jsã®ä¸–ç•Œã§ã‚ã£ã¦ã€Cloudflareã§ã¯ãªã„ã®ã§ã€`D1Database`ã®å®Ÿè£…ãªã‚“ã‹ã©ã“ã«ã‚‚ãªã„ã‹ã‚‰ã€‚

SvelteKitã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã—ã¦ã€ã‚¢ãƒ€ãƒ—ã‚¿ã¯ãƒ“ãƒ«ãƒ‰å¾Œã®ä½“è£ã‚’æ•´ãˆã‚‹ã“ã¨ã—ã‹ã—ãªã„ã—ã€é–‹ç™ºä¸­ã¯ä¸€åˆ‡ã®ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹ã‚’é€šã‚‰ãªã„ã®ã§ã€ã“ã†ã„ã†ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã®æ§‹æˆã¯å…¨éƒ¨è‡ªåˆ†ã§ã‚„ã‚‰ãªã„ã¨ã„ã‘ãªã„ã€‚`platform?.env.DB!`ã£ã¦ã„ã†åž‹ã«ãªã£ã¦ã—ã¾ã†ã®ã‚‚ã€ã‚¢ãƒ€ãƒ—ã‚¿ã®ç«‹ã¡ä½ç½®æ•…ã®å•é¡Œã€‚

ã¨ã„ã†ã‚ã‘ã§ã€`localhost`ã®Node.jsã®ä¸–ç•Œã§ã„ã„æ„Ÿã˜ã«é–‹ç™ºã™ã‚‹ãŸã‚ã«ã¯ã€ã‚„ã¯ã‚Šã‚‚ã†ä¸€æ‰‹é–“ãŒå¿…è¦ã«ãªã‚‹ã€‚


ã“ã®ã‚ãŸã‚Šã®è©³ç´°ã¯ã€å‰ã«ã‚‚è¨˜äº‹ã«ã—ãŸã€‚

> [ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºæ™‚ã§ã‚‚ã€å®Ÿéš›ã®Cloudflareã‚¹ã‚¿ãƒƒã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ | Memory ice cubes](https://leaysgur.github.io/posts/2023/06/23/155126/)


ã›ã£ã‹ããªã®ã§ã€æ‹™ä½œã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†å ´åˆã®æ‰‹é †ã¯ä»¥ä¸‹ã€‚

```sh
npm i -D cfw-bindings-wrangler-bridge
```

`src/server.hooks.ts`ã‚’ä½œã£ã¦ã€æ¬¡ã®ã‚ˆã†ã«ãƒ¢ãƒƒã‚¯ã™ã‚‹ã€‚

```ts
import { createBridge } from "cfw-bindings-wrangler-bridge";
import { dev } from "$app/environment";
import type { Handle } from "@sveltejs/kit";


export const handle: Handle = async ({ event, resolve }) => {
  if (dev) {
    const bridge = createBridge();
    event.platform = {
      env: {
        DB: bridge.D1Database("DB"),
      },
    };
  }

  return resolve(event);
};
```

ãã†ã—ãŸã‚‰ã€`wrangler dev`ã§é–‹ç™ºç”¨ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’å»ºã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```sh
npm run dev
# ã«åŠ ãˆã¦
wrangler dev ./node_modules/cfw-bindings-wrangler-bridge/worker.js
```

ã‚‚ã¡ã‚ã‚“`wrangler.toml`ã¯å¿…è¦ã«ãªã‚‹ã‘ã©ã€ãƒ­ãƒ¼ã‚«ãƒ«ã ã‘ã§å‹•ã‹ã™ãªã‚‰é©å½“ã«ã§ã£ã¡ä¸Šã’ã‚Œã°ã‚ˆã„ã€‚

```toml
name = "dev-worker"

compatibility_date = "2023-08-07"

[[d1_databases]]
binding = "DB"
database_name = "myapp"
database_id = "dummy"
```

`warngler dev --remote`ã—ãŸã„å ´åˆã¯ã€ã¡ã‚ƒã‚“ã¨ã—ãŸå†…å®¹ã«ã™ã‚‹ã€‚

### `miniflare`ã‚’ä½¿ã„ãŸã„

ã‚„ã¯ã‚Šæœ¬å‘½ã¨ã—ã¦ã¯å…¬å¼ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹`@cloudflare/miniflare`ã«æœŸå¾…ã—ãŸã„æ°—æŒã¡ãŒã‚ã‚‹ã€‚

ãŸã `miniflare`ã®æœ€æ–°ã¯`3.x`ç³»ã§ã€`2.x`ç³»ã‹ã‚‰ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã•ã‚ŒãŸã¨ãã«ã€ä»¶ã®ãƒ¢ãƒƒã‚¯ã®å®Ÿè£…ãŒãªããªã£ã¦ã—ã¾ã£ãŸäº‹æƒ…ãŒã‚ã£ãŸã‘ã©ã€ ã¾ã‚‚ãªãå¾©æ´»ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã¯ãšã€‚

> [[Miniflare 3] âœ¨ Implement *magic* proxy and add back support for `Miniflare#get*()` methods by mrbbot Â· Pull Request #639 Â· cloudflare/miniflare](https://github.com/cloudflare/miniflare/pull/639)

`miniflare`ã§ã‚„ã‚‹å ´åˆã¯ã€ã•ã£ãã®`wrangler.toml`ã¯ãªãã¦ã‚‚ã‚ˆã„ã€‚

ãŸã ã“ã®å ´åˆã€ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ã‚«ãƒ«ã«é–‰ã˜ã¦ã—ã¾ã†ï¼ˆãƒªãƒ¢ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯æ‰±ãˆãªã„ï¼‰ã“ã¨ã¨ã€ãƒ¢ãƒƒã‚¯ã‚’ä»•è¾¼ã‚€ã‚³ãƒ¼ãƒ‰ãŒã¡ã‚‡ã£ã¨å†—é•·ã«ãªã£ã¦ã—ã¾ã†ã€‚

```ts
import { Miniflare } from "miniflare";
import { dev } from "$app/environment";
import type { Handle } from "@sveltejs/kit";

let mf: Miniflare;
export const handle: Handle = async ({ event, resolve }) => {
  if (dev) {
    if (!mf) {
      mf = new Miniflare({
        modules: true,
        script: "",
        d1Databases: ["DB"],
      });
    }

    const bindings = await mf.getBindings();
    event.platform = {
      env: { ...bindings, },
    };
  }

  return resolve(event);
};
```

ä½•ãŒå•é¡Œã‹ã¨ã„ã†ã¨ã€

- `Miniflare`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€å†…éƒ¨çš„ã«ã‚µãƒ¼ãƒãƒ¼ã‚„`workerd`ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æŠ±ãˆã‚‹
- ãªã®ã§ã€`mf.dispose()`ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’é–‹æ”¾ã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚»ãƒƒãƒˆãªã®ãŒæœ¬æ¥ã®ä½¿ã„æ–¹
- ã—ã‹ã—SvelteKitã®`hooks`ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€šã‚‹åº¦ã«å®Ÿè¡Œã•ã‚Œã‚‹
- `dispose()`ã‚’ã„ã„æ„Ÿã˜ã«å‘¼ã¶ä»•çµ„ã¿ã¯ãªã„ãŸã‚ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è‡ªåˆ†ã§1ã¤ã ã‘ã«ã—ãªã„ã¨ã„ã‘ãªã„
- ãã®1ã¤ã‚‚ã€`npm run dev`ã‚’çµ‚äº†ã—ã¦ã€Viteã®ãƒ—ãƒ­ã‚»ã‚¹ãŒè½ã¡ã‚‹ã¨ãã«ã¤ã„ã§ã«å¼·åˆ¶çµ‚äº†ã—ã¦ã‚‚ã‚‰ã†ã—ã‹ãªã„

ã¨ã„ã†ã€ãƒŽãƒƒãƒˆã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãªä»•ä¸ŠãŒã‚Šã«ãªã‚‹ãƒ»ãƒ»ãƒ»ã€‚

ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆã«ã‚„ã‚‹ãŸã‚ã«ã¯ã€SolidStartã¿ãŸã„ã«ã“ã‚Œç›¸å½“ã®ä»•çµ„ã¿ã‚’ã‚¢ãƒ€ãƒ—ã‚¿ã§æä¾›ã™ã‚‹ã—ã‹ãªã•ãã†ã€‚SolidStartã®ã‚¢ãƒ€ãƒ—ã‚¿ã¯ã€`vite dev`ã«ä»‹å…¥ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã‚‹ã€‚

> https://github.com/solidjs/solid-start/blob/main/packages/start-cloudflare-pages/index.js#L15

## ã¾ã¨ã‚

ã¨ã„ã†ã‚ã‘ã§ã€ãã‚Œãªã‚Šã«è¨­å®šã™ã‚‹ã“ã¨ã¯å¤šã„ã‘ã©ã€ã‚„ã‚Œãªã„ã“ã¨ã¯ãªã„ã£ã¦æ„Ÿã˜ã€‚

å®Œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ã§ã™ã€‚

> https://github.com/leaysgur/sveltekit-d1-drizzle-template
