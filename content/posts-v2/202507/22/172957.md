---
title: "`ratatui`ã¨`tokio`ã§ä½œã‚‹TUIã®åŸºæœ¬"
---

ã¨ã„ã†ã®ã‚’æœ€è¿‘æ¨¡ç´¢ã—ã¦ã„ã¦ã€ãã®æˆæœã¨ã—ã¦ã®ãƒ¡ãƒ¢ã€‚

ä½œã£ãŸã®ã¯ã¾ãŸã‚‚ASTãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã§ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã™ã‚Œã°ã€OXCã§ãƒ‘ãƒ¼ã‚¹ã—ãŸASTã‚’è¦‹ã‚Œã‚‹ã¨ã„ã†ç°¡å˜ãªã‚„ã¤ã€‚

> leaysgur/oxc-parser-tui
> https://github.com/leaysgur/oxc-parser-tui

## `ratatui`ã¨`crossterm`

Rustã§TUIä½œã‚‹ãªã‚‰ã‚³ãƒ¬ã¨ã„ã†ã‚„ã¤ã€‚

> ratatui/ratatui: A Rust crate for cooking up terminal user interfaces (TUIs) ğŸ‘¨â€ğŸ³ğŸ€ https://ratatui.rs
> https://github.com/ratatui/ratatui

ç¾æ™‚ç‚¹ã§ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯`0.29`ã§ã€ã‚‚ã†ã™ã`0.30`ã«ãªã‚‹ã¨ã®ã“ã¨ã€‚

å½¹å‰²ã¨ã—ã¦ã¯ã€

- TUIã®èµ·å‹•
- TUIä¸Šã§æç”»ã—ãŸã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
  - `Paragraph`ã‚„`Block`ã€`List`ã‚„`Scrollbar`ã‚‚ã‚ã‚‹
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  - `Flex`ã¨ã‹`Length`ã¨ã‹`Percentage`ã¨ã‹ã§ã‚¨ãƒªã‚¢ã‚’åŒºåˆ‡ã£ã¦ãã‚¤ãƒ¡ãƒ¼ã‚¸
- ãƒ†ã‚­ã‚¹ãƒˆã®è‰²ã‚„ã‚¹ã‚¿ã‚¤ãƒ«

ã¨ã„ã†ã‚ãŸã‚Šã€‚

ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ãªã©ã«å¯¾å¿œã™ã‚‹ã®ã¯ã€å†…éƒ¨çš„ã«ã‚‚ä¾å­˜ã—ã¦ã‚‹`crossterm`ã¨ã„ã†åˆ¥ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ãªã‚‹ã€‚ï¼ˆã“ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯åˆ¥ã®å®Ÿè£…ã«å·®ã—æ›¿ãˆã‚‰ã‚Œã‚‹ã‘ã©ã€ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆãŒ`crossterm`ã‚‰ã—ã„ï¼‰

> crossterm-rs/crossterm: Cross platform terminal library rust
> https://github.com/crossterm-rs/crossterm

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°

ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯ã‚²ãƒ¼ãƒ é–‹ç™ºã®ãã‚Œã¿ãŸãã€ãƒ¡ã‚¤ãƒ³ã®`loop`ã®ä¸­ã§å¸¸ã«å‘¼ã¶ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒä¸€èˆ¬çš„ã‚‰ã—ã„ã€‚

```rs
loop {
    terminal.draw(|frame| {
        if state.condition {
            frame.render_widget(SomeWidget::new(), layout);
        } else {
            frame.render_widget(AnotherWidget::new(), layout);
        }
    })?;
}
```

æ‰‹å‹•ã§ã‚¿ã‚¤ãƒãƒ¼ã‚’ç®¡ç†ã—ã¦FPSã‚’ã‚­ãƒ¼ãƒ—ã™ã‚‹ã‚‚ã‚ˆã—ã€æ‰‹å‹•ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ã‚‚ãŸã¶ã‚“ã„ã„ã€‚

`render_widget()`ã¯ã€`Widget` taritã‚’å®Ÿè£…ã—ã¦ã„ã‚Œã°ãªã‚“ã§ã‚‚ã‚ˆã„ã®ã§ã€`impl Widget for &App { fn render() {} }`ã—ã¦ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚ˆãè¦‹ã‚‹ã€‚
ã‚‚ã¡ã‚ã‚“ç´”é–¢æ•°ã«ã—ã¦ã—ã¾ã£ã¦ã‚‚ã„ã„ã€‚

`Scrollbar`ã‚„`List`ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€`render_stateful_widget()`ã¨ã„ã†ç‰¹åˆ¥ãªã‚„ã¤ã‚’ä½¿ã†ã‚‰ã—ãã€ã“ã®ãŸã‚ã«`&mut`ã§`ScrollState`ã‚„`ListState`ã‚’æ¸¡ã™ãƒ‡ã‚¶ã‚¤ãƒ³ã«ãªã£ã¦ãŸã€‚

åˆ¥ã®ã¨ã“ã‚ã§ä¿æŒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã‚‚å®Ÿè£…ã§ãã‚‹ã‘ã©ã€ãƒªã‚¹ãƒˆã§ç¾åœ¨åœ°ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¦ç´ æ•°ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹ã¿ãŸã„ãªå®Ÿè£…ã‚’æ‰‹å‹•ã§ã‚„ã‚‰ãªã„ã¨ã„ã‘ãªããªã‚‹ã‚ˆã†ã ã£ãŸã€‚

Webã®GUIã‹ã‚‰å…¥ã‚‹ã¨ã€TUIã¯ã§ãã‚‹ã“ã¨ãŒé™ã‚‰ã‚Œã¦ã„ã¦ã™ã”ãæ¯è‹¦ã—ã„ã€‚

- JSXã‚‚HTMLã§ã‚‚ãªã„æ‡ã‹ã—ã„ifã¨ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã®ä¸–ç•Œ
  - å½“ç„¶`{#await}`ã‚‚ãªã‘ã‚Œã°RSCã‚‚ãªã„
- z-indexã‚‚`::backdrop`ã‚‚ãªã„ã‹ã‚‰UIè¡¨ç¾ã‚‚ä¹ã—ã„
- ã‚‚ã¡ã‚ã‚“inputè¦ç´ ã‚‚ãªã„
  - ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã€å…¥åŠ›ãƒãƒƒãƒ•ã‚¡ã€ã‚«ãƒ¼ã‚½ãƒ«ãªã©ã‚ˆã—ãªã«å®Ÿè£…ã™ã‚‹
  - https://github.com/sayanarijit/tui-input/blob/5519e31ea9d7eef1e3da5e9bf5ba7ec73955daa1/examples/ratatui_crossterm_input.rs#L56
- ãƒ†ã‚­ã‚¹ãƒˆã®è‡ªå‹•å›ã‚Šã“ã¿ã¯`Paragraph`ã§æ˜ç¤ºã—ãŸã¨ãã ã‘
  - ç‹¬è‡ªUIã‚’ä½œã‚‹ãªã‚‰ã€ã ã„ãŸã„ã¯å¹³é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è‡ªä½œã™ã‚‹ã“ã¨ã«ãªã‚‹
- ãƒã‚¦ã‚¹ã®ã‚µãƒãƒ¼ãƒˆã‚‚ã‚ã‚‹ãŒã€UXã¯ãŠå¯Ÿã—

SignalsãŒã»ã—ã„ãƒ»ãƒ»ãƒ»å®£è¨€çš„UIãŒã»ã—ã„ãƒ»ãƒ»ãƒ»ã€‚

## `tokio`ã§ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°

TUIã‚’å®Ÿè¡Œã—ã¦ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ä¸Šã§é‡ãŸã„å‡¦ç†ã‚’èµ°ã‚‰ã›ã‚‹ã¨ã€UIã®è¡¨ç¤ºã‚„å…¥åŠ›ã«ãƒ©ã‚°ãŒå‡ºã¦ã—ã¾ã†ã€‚ï¼ˆã“ã®ã¸ã‚“ã¯GUIã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã‚‚åŒã˜ï¼‰

ãªã®ã§ã€é‡ãŸã„ã‚¿ã‚¹ã‚¯ã‚„ã‚ã‚‰ã‚†ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆå¾…å—ã¯éåŒæœŸã«ã—ã¦ã€ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã«ã—ãŸã„ã¨ãªã‚‹ã€‚

ã“ã“ã§ç™»å ´ã™ã‚‹ã®ãŒã€Rustã®éåŒæœŸãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã§ã‚ã‚‹`tokio`ã¨ã„ã†ã“ã¨ã‚‰ã—ã„ã€‚

- `tokio::spawn`ã§å®Ÿè¡Œä¸»ä½“ã¯åˆ¥ã‚¿ã‚¹ã‚¯ã«ã—ã¦ãŠã
- `tokio::sync::{mpsc, watch}`ãªã‚“ã‹ã‚’ä½¿ã£ã¦é€£æºã—
- ã‚¿ã‚¤ãƒãƒ¼ã‚„ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®å…¥åŠ›ã‚’å¾…ã¡å—ã‘ã¦ã€é‡ãŸã„éåŒæœŸå‡¦ç†ã™ã‚‹ãªã‚Šã€å˜ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦å—ã‘æµã—ã¦ãƒãƒ£ãƒ³ãƒãƒ«ã®txã‚’å©ããªã‚Š
- å¤§å…ƒã§ã¯ã•ã£ãã®ã‚ˆã†ãª`loop`ã®ä¸­ã§å„ç¨®rxã‚’`tokio::select!`ã§æ‹¾ã£ã¦ã€åˆ¥ã®åŒæœŸå‡¦ç†ã§çŠ¶æ…‹ã‚’æ›´æ–°

ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

ã¨ã«ã‹ãã‚¤ãƒ™ãƒ³ãƒˆãŒé£›ã³äº¤ã†ã‚ã®é ƒã®WebSocketçš„ãªä¸–ç•Œç·šã ã£ãŸã€‚

- ãƒ¡ã‚¤ãƒ³ã§å¯†ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç®¡ç†ã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦ä¸‹å±¤ã«åˆ†é…ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹
- ä¸‹å±¤ãã‚Œãã‚Œã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¡å—ã‘ã¦ã€ç–ã«ã‚„ã‚‹å‰æã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹

ã“ã®ã¸ã‚“ã¯ä½œã‚ŠãŸã„ã‚‚ã®ã«å¿œã˜ã¦ã‚ˆã—ãªã«ã™ã‚‹ã€‚ã‘ã©ã€å¾Œè€…ã«æŒ¯ã‚Šåˆ‡ã‚‹ã®ãŒã„ã¤ã‚‚é›£ã—ã„ã®ãŒUIã‚ˆã­ãƒ»ãƒ»ãƒ»ã€‚

ã‚‚ã¡ã‚ã‚“Fluxã¸ã®è¨€åŠã‚‚ã‚ã‚‹ã‘ã©ã€å€‹äººçš„ã«Flux(Redux)ãƒ•ã‚¡ãƒ³ã˜ã‚ƒãªã„ã®ã§æ‚©ã¾ã—ã„ã€‚

> Flux Architecture | Ratatui
> https://ratatui.rs/concepts/application-patterns/flux-architecture/

SignalsãŒã»ã—ã„ãƒ»ãƒ»ãƒ»å®£è¨€çš„UIãŒã»ã—ã„ãƒ»ãƒ»ãƒ»ã€‚ï¼ˆäºŒåº¦ç›®ï¼‰

## ç´°ã‹ã„ã‚³ãƒ¼ãƒ‰

### `rataui::run()`

ãƒãƒ¼ã‚¸ãƒ§ãƒ³`0.30`ã§è¿½åŠ ã•ã‚ŒãŸä¾¿åˆ©ãªã‚„ã¤ã€‚

> feat: add ratatui::run() method by joshka Â· Pull Request #1707 Â· ratatui/ratatui
> https://github.com/ratatui/ratatui/pull/1707

ã‚³ãƒ¬ã¯ã€

- `raw`ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
- `AlternateScreen`ã®å…¥ã¨å‡º
- `crossterm`ã®`Terminal`ã®åˆæœŸåŒ–

ã¨ã„ã†ã‚ˆã†ãªãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚ˆã—ãªã«ã‚„ã£ã¦ãã‚Œã‚‹ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã€‚

ãŸã `async`ã§ã¯ãªã„ã®ã§ã€`#[tokio::main]`ã¨ä¸€ç·’ã«ã¯ä½¿ãˆãªã„ã€‚

```rs
ratatui::run(|terminal| {
    let runtime = tokio::runtime::Builder::new_current_thread()
        .enable_all()
        .build()
        .unwrap();
    runtime.block_on(run(terminal));
});

async fn run<B: ratatui::backend::Backend>(terminal: &mut Terminal<B>) {}
```

### éåŒæœŸã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ

åˆ¥é€”ã§ä¾å­˜ã‚’è¿½åŠ ã—ãŸã‚‰ä½¿ãˆãŸã€‚

```toml
crossterm = { version = "0.28.1", features = ["event-stream"] }
futures = "0.3.31"
tokio = { version = "1.40.0", features = ["full"] }
```

ã“ã®çŠ¶æ…‹ã§ãªã‚‰ã€`EventStream`ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

```rs
use futures::StreamExt;
use ratatui::crossterm::event::{EventStream, KeyEvent};

tokio::spawn(async move {
    let mut event_stream = EventStream::new();
    while let Some(Ok(ev)) = event_stream.next().await {
        // Should check press event for Windows
        let Some(KeyEvent { modifiers, code, .. }) = ev.as_key_press_event()
        else {
            continue;
        };

        // ...
    }
}
```

`ratatui::crossterm`ã¨`crossterm`ã®æœ¬å®¶ã®ä¸¡æ–¹ãŒã‚ã‚‹ã®ãŒã¨ã¦ã‚‚ç´›ã‚‰ã‚ã—ã„ã€‚

> templates/event-driven-async/template at main Â· ratatui/templates
> https://github.com/ratatui/templates/tree/main/event-driven-async/template

