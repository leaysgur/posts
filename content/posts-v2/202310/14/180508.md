---
title: Cloudflare D1ã®ã€è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã®JOINã§åŒåã®ã‚«ãƒ©ãƒ ãŒå–å¾—ã§ããªã„ãƒã‚°ã¨ãã®ç†ç”±ã€ãã—ã¦Drizzle ORMã§ã®å¯¾å‡¦æ³•
---

ã©ã†ã„ã†ã“ã¨ï¼Ÿã£ã¦ãªã‚Šã¾ã™ã‚ˆã­ã€‚ç§ã¯ãªã‚Šã¾ã—ãŸã€‚

> ğŸ› BUG: when trying to left join 2 tables that have same name columns - second column is not returned Â· Issue #3160 Â· cloudflare/workers-sdk
> https://github.com/cloudflare/workers-sdk/issues/3160

## ã“ã†ã„ã†ã“ã¨

ãŸã¨ãˆã°ã“ã†ã„ã†ã‚¹ã‚­ãƒ¼ãƒã€‚

```sql
categories {
  TEXT slug PK
  TEXT name
}

posts {
  TEXT slug PK
  TEXT category_slug FK
  TEXT title
}
```

å„ãƒã‚¹ãƒˆã¯ã€å˜ä¸€ã®ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ã¨ã™ã‚‹ã€‚ã¾ã‚ã€ã‚ã‚ŠãŒã¡ãªãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆã‹ã¨ã€‚

é‡è¦ãªã®ã¯ã€`slug`ã¨ã„ã†åŒåã®ã‚«ãƒ©ãƒ ãŒã‚ã‚‹ã¨ã“ã‚ã€‚

ã§ã€ã“ã®çŠ¶æ…‹ã§ã€ä»¥ä¸‹ã®SQLã‚’ç™ºè¡Œã™ã‚‹ã¨ã€

```sql
SELECT
  posts.slug, categories.slug
FROM
  posts
  LEFT JOIN categories ON posts.category_slug == categories.slug
```

æœŸå¾…ã™ã‚‹ã®ã¯ã“ã†ã„ã†è¿”ã‚Šå€¤ã€‚

```markdown
| slug   | slug       |
| ------ | ---------- |
| post-1 | category-1 |
```

ç´ ã®SQLiteã¨ã‹ï¼ˆãã®ä»–ã®DBã§ã‚‚ï¼‰ã§ã‚ã‚Œã°ã€ã“ã®ã‚ˆã†ã«è¿”ã£ã¦ãã‚‹ã€‚

ãŒã€ç¾çŠ¶ã®D1ã ã¨ã“ã†ãªã£ã¡ã‚ƒã†ã€‚

```markdown
| slug       |
| ---------- |
| category-1 |
```

ãªã‚“ã¦ã“ã£ãŸã€‚

## ãªãœã‹

D1ã®å®Ÿè£…ï¼ˆãŸã¶ã‚“`workerd`ã¨ã„ã†ã‚ˆã‚Šã€D1ã‚’æŒã„ã¦ã‚‹ã‚‰ã—ã„DOã®å®Ÿè£…ã‹ãªï¼Ÿï¼‰ãŒãã†ãªã£ã¦ã‚‹ã‹ã‚‰ã€‚

ãŠãã‚‰ãSQLiteã‹ã‚‰è¿”ã£ã¦ããŸçµæœã‚’ã€JSONã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã™ã‚‹ãŸã‚ã«è©°ã‚æ›¿ãˆã‚‹ã¨ã“ã‚ã§ã€åŒåã®ã‚­ãƒ¼ã‚’ä¸Šæ›¸ãã—ã¡ã‚ƒã£ã¦ã‚‹ã€‚

ãªã®ã§`wrangler d1 execute --command="..."`ã ã‚ã†ã¨ã€`D1.prepare("...").all()`ã ã‚ã†ã¨`D1.prepare("...").raw()`ã ã‚ã†ã¨ã€ã©ã†ã—ã‚ˆã†ã‚‚ãªãã“ã†ãªã‚‹ã€‚

## ä½•ãŒå›°ã‚‹ã®ã‹

`wrangler`ã‹ã‚‰SQLã‚’ç™ºè¡Œã—ãŸã‚Šã€D1ã®APIã‚’ç›´æ¥ä½¿ã£ã¦ã‚‹å ´åˆã¯ã€ãã‚‚ãã‚‚åŒã˜ã‚«ãƒ©ãƒ åã«ã¯ã›ãš`AS`ã¨ã‹ä½¿ã†ã¯ãšã€‚ãªã®ã§ã€å•é¡Œã«ãªã‚‰ãªã„ã€‚

å›°ã‚‹ã®ã¯ã€ã„ã‚ã‚†ã‚‹ORMã‚’é€šã—ãŸå ´åˆã€‚å€‹äººçš„ã«è¨€ã†ã¨ã€DrizzleORMã‚’ä½¿ã£ã¦ãŸå ´åˆã€‚

Drizzleã¯D1ã®APIã§ã„ã†`.raw()`ã‚’ä½¿ã£ã¦ã‚‹ã®ã§ã€ã“ã®å½±éŸ¿ã‚’ã‚‚ã‚ã«å—ã‘ã‚‹ã¨ã®ã“ã¨ã€‚

> [BUG]: Broken shifted columns with leftJoin and same column name (on D1) Â· Issue #555 Â· drizzle-team/drizzle-orm
> https://github.com/drizzle-team/drizzle-orm/issues/555

Drizzleã¯ã€ã“ã†ã„ã†ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã¨ã€

```js
const { sql } = drizzle(D1Database)
  .select({ ps: posts.slug, cs: categories.slug })
  .from(posts)
  .leftJoin(categories, eq(posts.categorySlug, categories.slug))
  .toSQL();
```

ã“ã†ã„ã†SQLã«å¤‰æ›ã™ã‚‹ã‚‰ã—ãã€

```sql
SELECT
  "posts"."slug",
  "categories"."slug"
FROM 
  "posts"
  LEFT JOIN "categories" ON "posts"."category_slug" = "categories"."slug"
```

ã™ã‚‹ã¨ã•ã£ãã®D1ã®ç½ ã«ã‹ã‹ã£ã¦ã€æ€ã£ãŸé€šã‚Šã®çµæœãŒè¿”ã£ã¦ã“ãªã„ã€‚ãªã®ã§`undefined`ï¼Ÿï¼ãªã‚“ã§ï¼Ÿï¼ã£ã¦ãªã‚‹ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯`AS`ãŒä½¿ã‚ã‚Œã‚‹é¢¨ã«æ›¸ã„ã¦ã‚ã‚‹ã‘ã©ã€å®Ÿéš›ã¯ä½¿ã£ã¦ãªã„ã£ã½ã„ã€‚

> SQL Select - DrizzleORM
> https://orm.drizzle.team/docs/select#basic-and-partial-select

## ã©ã†ã™ã‚Œã°ã„ã„ã‹

SQLæ–‡ã«`AS`ã‚’å«ã‚ã‚‹ãŸã‚ã«ã¯ã€`sql`ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãªã‚‹æ©Ÿèƒ½ã‚’æ˜ç¤ºçš„ã«ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã€‚

```ts
const { sql } = drizzle(D1Database)
  .select({ ps: posts.slug, cs: sql<string>`${categories.slug}`.as("cs") })
  .from(posts)
  .leftJoin(categories, eq(posts.categorySlug, categories.slug))
  .toSQL();
```

> Magical sql operator ğŸª„ - DrizzleORM
> https://orm.drizzle.team/docs/sql#sqlast

TSã®å ´åˆã€å‹ã‚’æ˜ç¤ºã—ãªã„ã¨ã€`unknown`ã«ãªã£ã¡ã‚ƒã†ã€‚

ã‚„ã‚„å†—é•·ã§ã¯ã‚ã‚‹ãŒã€ã¾ã‚ãªã‚“ã¨ã‹è¨±å®¹ã§ãã‚‹ç¯„å›²ã®å¯¾å¿œã‹ãªãƒ»ãƒ»ã€‚

> We are working on this. Current priority is larger databases, which is the biggest ask from most users.
> https://github.com/cloudflare/workers-sdk/issues/3160#issuecomment-1661009761

ä¿¡ã˜ã¦å¾…ã¡ã¾ã—ã‚‡ã†ï¼
