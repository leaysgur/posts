---
title: "`use server`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã®æ­£ä½“"
---

Reactã¨ã„ã†ã‹Next.jsã§ãŠãªã˜ã¿ã®ã‚¢ãƒ¬ãŒã€ã“ã®åº¦SolidStartã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

```ts
async function serverFn(id: number) {
  "use server"; // ğŸ‘ˆ
  const res = await DB.findSomething({ where: { id } });
  return res.data;
}

return (
  <button onClick={() => serverFn(42).then((d) => console.log(d))}>
    Server function!
  </button>
);
```

ã¡ãªã¿ã«ã€å…ƒã€…ã®SolidStartã¯QwikCityã¨åŒã˜`server$`æ–¹å¼ã‚’æ¡ç”¨ã—ã¦ãŸã‘ã©ã€ã“ã®åº¦`use server`æ–¹å¼ã«ãªã£ãŸã¨ã„ã†çµŒç·¯ã€‚

> server$ | Qwik City ğŸ“š Qwik Documentation
> https://qwik.builder.io/docs/server$/

ã§ã€Next.jsã®å®Ÿè£…ã‚’è¿½ã†æ°—ã«ã¯ãªã‚‰ã‚“ã‹ã£ãŸã‘ã©ã€SolidStartãã‚‰ã„ãªã‚‰è¿½ã£ã¦ã‚‚ã„ã„ã‹ãªã¨æ€ã£ã¦ã€ãã®ä»•çµ„ã¿ã‚’èª¿ã¹ã¦ã¿ãŸã€‚

## ã„ããªã‚Šçµè«–

`use server`ã‚‚ã¨ã„ã€Server functionsã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã¯ã€

- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚ã‚Šãã®æ©Ÿèƒ½
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã€
  - ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã§`use server`ãŒæ›¸ã‹ã‚ŒãŸé–¢æ•°ã‚’è¦‹ã¤ã‘ã€`fetch()`ã‚’ä½¿ã£ãŸRPCã«ç½®æ›ã™ã‚‹
  - ã‚µãƒ¼ãƒãƒ¼å´ã®ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã«ãã®é–¢æ•°ã‚’ç§»è¨­ã—ã€RPCã‚’å‡¦ç†ã—ã¦è¿”ã™ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å¢—ã‚„ã™

ã¨ã„ã†ã ã‘ã€‚ï¼ˆå°‘ãªãã¨ã‚‚ã€SolidStartã®å®Ÿè£…ãŠã‚ˆã³ä¸€èˆ¬çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã¨ã—ã¦ã¯ï¼‰

ãŸã¨ãˆã°ã€ã“ã†ã„ã†ã‚³ãƒ¼ãƒ‰ãŒã‚ã£ãŸã¨ã—ã¦ã€

```js
// client
const serverFn = async (msg) => {
  "use server";
  return `${msg} from server!`;
};
```

ã“ã‚Œã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã¨ã€

```js
// client
const serverFn = async (msg) =>
  fetch("/_server", {
    method: "POST",
    body: JSON.stringify(["serverFn", msg]),
  })
  .then((r) => r.json());

// server
server.post("/_server", async (req) => {
  const [name, ...args] = await req.json();
  const handler = HANDLERS.get(name); // async (msg) => `${msg} from server!`;

  const res = await handler(...args);
  return Response.json(res);
});
```

ã¨ãªã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚

`use server`ã¯é–¢æ•°ãƒ¬ãƒ™ãƒ«ã§å®šç¾©ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã—ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§å®šç¾©ã™ã‚‹ã“ã¨ã‚‚ã§ãã€ã“ã®å ´åˆã¯ãã“ã§å®šç¾©ã•ã‚ŒãŸã™ã¹ã¦ãŒã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

è“‹ã‚’é–‹ã‘ã¦ã¿ã‚‹ã¨ãã“ã¾ã§è¤‡é›‘ãªã“ã¨ã¯ã—ã¦ãªã„ã€‚
ãã‚Œã‚’åˆ¤åˆ¥ã™ã‚‹ã®ã«`use server`ã¨ã„ã†æ–‡å­—åˆ—ã§ã‚ã‚‹å¿…è¦ã‚‚ãªã„ã—ã€ã‚ã‹ã‚Šã‚„ã™ã‘ã‚Œã°ãªã‚“ã ã£ã¦ã„ã„ã€‚

ãŸã ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒæ›¸ã‹ã‚Œã¦ã‚‹ã ã‘ã§ã¯ç„¡å®³ã§ã‚ã‚Šã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒå¿…è¦ã¨ã„ã†ç‚¹ã§ã€ãƒ¡ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å´ã®æ©Ÿèƒ½ã¨ã—ã¦ä½ç½®ã¥ã‘ã‚‰ã‚Œã¦ã‚‹ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã‹ã€‚

## å®Ÿè£…ã¨ã—ã¦ã®å‹˜æ‰€

DXã¨ã—ã¦ã€æ›¸ã„ã¦ã‚‹ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã¯ã€ä»Šã¾ã§é€šã‚Šã®JavaScriptã§ã‚ã‚Šã€ãŸã ã®éåŒæœŸé–¢æ•°ã¨ã„ã†ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã€‚
ãŸã ã—å®Ÿè¡Œæ™‚ã«ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã¨ã„ã†ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã¾ãŸãå¿…è¦ãŒã‚ã‚‹ã—ã€ãã®ã‚„ã‚Šã¨ã‚Šã‚‚HTTPã‚’çµŒç”±ã™ã‚‹ã€‚

ã‚³ã‚³ã‚’ã„ã„æ„Ÿã˜ã«ã™ã‚‹ãŸã‚ã«ã€å˜ã«å¤‰æ›ã™ã‚‹ã ã‘ã§ãªãã€ã¡ã‚‡ã£ã¨ã—ãŸå®Ÿè£…ãŒå¿…è¦ã«ãªã£ã¦ã‚‹ã€‚

ç«¯çš„ã«ã¯ã€

- ãã®é–¢æ•°ãŒä¾å­˜ã—ã¦ã‚‹å¤‰æ•°ã‚„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æŠ½å‡ºã€ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ã‚„ã‚¹ã‚³ãƒ¼ãƒ”ãƒ³ã‚°ã®å¯¾å¿œ
- æ„å›³ã—ã¦å©ã‹ã‚Œãªã„ã‚ˆã†ã«ç‹¬è‡ªãƒ˜ãƒƒãƒ€ã§ã®æ¤œè¨¼
- ã‚ã‚‰ã‚†ã‚‹JSç•Œã®å‹ã‚’ã€(de)serializeã—ã¦é€éçš„ã«æ‰±ã†
  - `Map`ã¨ã‹`FormData`ã¨ã‹`ArrayBuffer`ã¨ã‹`File`ã¨ã‹
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã¾ã¨ã‚ã¦ã§ã¯ãªãã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§è¿”ã™

ã¨ã„ã†ã‚ãŸã‚Šã«ã€ã²ã¨æ‰‹é–“ã‹ã‹ã£ã¦ã‚‹ã€‚

SolidStartã®å ´åˆã¯ã€VinxiãŒ`use server`ã®åŸºç›¤ã‚’æŒã£ã¦ã¦ã€ãã®ä¸Šã§`seroval`ã‚’ä½¿ã£ã¦I/Oã®ã‚ˆã—ãªåŒ–ã‚’è¡Œã£ã¦ã‚‹å½¢ã€‚

## ã‚„ã‚ã†ã¨æ€ãˆã°

ã‚¢ã‚¤ãƒ‡ã‚¢è‡ªä½“ã¯ãŸã ã®Compiler Magicãªã®ã§ã€ãŸã¨ãˆã°SvelteKitãªã‚“ã‹ã§ã‚‚`use server`ã‚’é©ç”¨ã§ãã‚‹ã€‚

ã›ã£ã‹ããªã®ã§ã€ã‚ã¡ã‚ƒã‚ã¡ã‚ƒã‚·ãƒ³ãƒ—ãƒ«ãªã‚±ãƒ¼ã‚¹ã§ã‚‚å®Ÿè£…ã—ã¦éŠã‚“ã§ã¿ã‚ˆã†ã‹ã¨æ€ã£ãŸã‘ã©ã€å…ˆäººãŒã‚‚ã†ã‚„ã£ã¦ãŸã€‚

> lxsmnsyc/use-server-directive: Universal "use server" functions
> https://github.com/lxsmnsyc/use-server-directive

ã•ã™ãŒã ãœã€‚

æ˜¨ä»Šã®å‹•å‘ã‚’è¦‹ã‚‹ã«ã€SvelteKitã«ã™ãå°å…¥ã•ã‚Œã‚‹ã“ã¨ã¯ãªã„ã¨æ€ã†ã‘ã©ã€ã“ã‚Œã‚’ä½¿ã†ã¨ã“ã‚“ãªã‚³ãƒ¼ãƒ‰ã‚‚æ›¸ã‘ã¡ã‚ƒã†ã€‚

```svelte
<script>
  const prefix = "Server Count";

  async function serverCount(value) {
    "use server";

    const immediate = `${prefix}: ${value}`;
    return {
      immediate,
      delayed: new Promise((res) => {
        setTimeout(res, 1000, immediate);
      }),
    };
  }

  let state = 0;
  $: data = serverCount(state);

  function increment() {
    state += 1;
  }
</script>

<button on:click={increment}>
  {`Client Count: ${state}`}
</button>

<div>
  {#await data}
    <h1>Loading</h1>
  {:then value}
    <h1>{value.immediate}</h1>

    {#await value.delayed}
      <h1>Loading</h1>
    {:then delayed}
      <h1>Delayed: {delayed}</h1>
    {/await}
  {/await}
</div>
```

`Promise`ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã—ã¦æ‰±ãˆã‚‹ã®ã¯ã€SvelteKitã®å…ƒã€…ã®æ©Ÿèƒ½ã€‚

## è‡ªå•è‡ªç­”ã‚³ãƒ¼ãƒŠãƒ¼

> Q. ç´ ç›´ã«APIãƒ«ãƒ¼ãƒˆã«ã—ãŸã‚‰ãˆãˆã‚„ã‚“ï¼ŸtRPCã¨ã‹ã‚‚ã‚ã‚‹ã‚„ã‚ï¼Ÿã‚ã–ã‚ã–æ–°ã—ã„ä»•çµ„ã¿ã„ã‚‹ï¼Ÿ

ãã®æ°—æŒã¡ã‚‚ã‚ã‹ã‚‹ã€‚

ã‘ã©ã€JSONä»¥å¤–ã‚‚ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ã‚„ã‚Šå–ã‚Šã§ãã‚‹ã®ã¯æ¥½ã§ã„ã„ã—ã€TSã®å‹ãŒãã®ã¾ã¾ä½¿ãˆã‚‹ã®ã‚‚æ¥½ã€‚

å¤–éƒ¨ã«URLã¨ã—ã¦å…¬é–‹ã™ã‚‹å¿…è¦ãŒãªã„ãªã‚‰ãªãŠã•ã‚‰ã€‚

ã¾ãå…¨ã¦ãŒãƒã‚°ãªãå‹•ä½œã™ã‚‹å‰æã§ã¯ã‚ã‚‹ã€‚ã‚ã‚‹æ—¥çªç„¶è½ã¨ã—ç©´ã«ãƒãƒã‚ŠãŸããªã„ã—ã€‚

> Q. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã«æ··ã–ã‚‹ã®ã¯ã‚„ã£ã±æ°—æŒã¡æ‚ªã„

ãã‚Œã¯ãã†æ€ã†ã€‚

```js
import clientOnlyModule from "...";
// ...
import os from "node:os";
```

ã“ã†ã„ã†ä¸¦ã³ã«ãªã‚‹ã®æ°—æŒã¡æ‚ªã„ã€‚

åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ‡ã‚Šå‡ºã—ã¦ã€é–¢æ•°ãƒ¬ãƒ™ãƒ«ã§ã¯ãªããƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§`use server`ã™ã‚‹ã¨ã„ã†æ‰‹ã¯ã‚ã‚‹ã‹ã‚‚ãƒ»ãƒ»ãƒ»ï¼Ÿ
ï¼ˆãã†ãªã‚‹ã¨ä»Šåº¦ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã«`server`ã£ã¦å…¥ã‚ŒãŸããªã‚‹ãªãƒ»ãƒ»ãƒ»ï¼‰

> Q. ã©ã‚“ã©ã‚“ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚ã‚Šãã«ãªã£ã¦ã‚‹ï¼Ÿ

ãªã£ã¦ãã†ã€‚

ãŸã JSXãŒè¨±å®¹ã•ã‚ŒãŸä¸–ç•Œã§ã¯ã€ã‚‚ã¯ã‚„ç¨‹åº¦ã®å•é¡Œã«ã“ã ã‚ã£ã¦ã‚‚ä»•æ–¹ãªã„ã®ã‹ã‚‚ã€‚ã“ã‚ŒãŒä»¤å’Œã®JavaScript 2ã£ã¦ã“ã¨ã§ã€‚

> Q. RSCã®ä»•çµ„ã¿ã¯ï¼Ÿ

ã¾ãŸã¡ã‚‡ã£ã¨è©±ãŒé•ã£ã¦ãã†ã€‚

ã¨ã„ã†ã‹ã€ãªã‚“ã§Reactæœ¬ä½“ã®Docsã«`use server`ã®è¨˜è¼‰ãŒã‚ã‚‹ã®ã‹ãŒã‚ˆãã‚ã‹ã‚‰ãªã„ã€‚
ï¼ˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚ã‚Šããƒ»ãƒ¡ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚ã‚Šããªã‚‰ã°ï¼‰

## ã¨ã„ã†ã‚ã‘ã§

å€‹äººçš„ã«ã¯ã€

- å…¬é–‹ã—ãªã„APIãƒ«ãƒ¼ãƒˆã®ä»£ã‚ã‚Šã¨ã—ã¦ä½¿ã†
- ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãšåˆ†ã‘ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¬ãƒ™ãƒ«ã§ã®ã¿`use server`ã™ã‚‹
  - ã§ãã‚Œã°TSã®`lib`ã¨ã‹å³å¯†ã«æŒ‡å®šã—ãŸã„ãŒ

ã£ã¦å‰²ã‚Šåˆ‡ã‚‹ãªã‚‰ã€ä¾¿åˆ©ã«ä»˜ãåˆã£ã¦ã„ã‘ãã†ã‹ãªã¨ã€‚Form actionsã«æ‡ç–‘çš„ãªã‚¹ã‚¿ãƒ³ã‚¹ã ã£ãŸèº«ã¨ã—ã¦ã¯ã€‚
