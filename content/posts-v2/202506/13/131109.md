---
title: TypeScriptã®`Diagnostics`ã«ã¤ã„ã¦
---

OXCã§TypeScriptã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã¨ãã€ã©ã“ã¾ã§ã‚’æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦å ±å‘Šã™ã‚‹ã‹ã‚’æ¤œè¨ã—ã¦ãŠã‚Šã€‚

TSCã®`tsProgram.getSyntacticDiagnostics()`ã§å–ã‚Œã‚‹ã‚‚ã®ã¯ã€ã‚‚ã¡ã‚ã‚“æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã§ã„ã„ã€‚

ãŸã ã€`tsProgram.getSemanticDiagnostics()`ã§å–ã‚Œã‚‹ã‚‚ã®ã«ã‚‚ã€ã“ã‚Œã¯æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã§ã¯ï¼Ÿã£ã¦ã®ã¯å¤šã€…ã‚ã‚‹ã€‚ãŸã¨ãˆã°`const a;`ã¨ã‹ã€`class X { private private x = 1 }`ã¨ã‹ã€‚

ã‚€ã—ã‚ã“ã‚Œã‚’semanticã«åˆ†é¡ã™ã‚‹TSã®æ°—æŒã¡ãŒçŸ¥ã‚ŠãŸã„ã€‚

ã„ã‚„ã¾ã‚ã€TSCã¯recoverableãªãƒ‘ãƒ¼ã‚µãƒ¼ãªã®ã§ã€è‡´å‘½çš„ãªã‚‚ã®ã ã‘ãŒsyntacticã§ã€ãã‚Œä»¥å¤–ã¯semanticã£ã¦æ„Ÿã˜ãªã‚“ã‚„ã‚ã†ã‘ã©ã€‚ã‚ã¨ã¯ã“ã®å¢ƒç•Œã¯ãŠãã‚‰ãæ›–æ˜§ãªã‚‚ã®ã§ã‚ã£ã¦ã€å®Ÿéš›ã«ã¯å³å¯†ã«å®šç¾©ã§ããªã„ã¨ã‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚

ã¨ã‚‚ã‚ã‚Œã€å‹ã‚¨ãƒ©ãƒ¼ã¿ãŸã„ãªã‚‚ã®ã ã‘ã‚’é™¤å¤–ã™ã‚‹æ‰‹ç«‹ã¦ã¯ä½•ã‚‚ãªã„ã®ã‹ï¼Ÿã¨ã„ã†ã®ã‚’ã–ã£ãã‚Šèª¿ã¹ãŸçµæœã®ãƒ¡ãƒ¢ã€‚

## ã¾ãšä»•çµ„ã¿

TSã®ãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã€è¶³å›ã‚Šã«Herebyã‚’ä½¿ã£ã¦ã‚‹ã€‚ãã—ã¦`Diagnostics`é–¢é€£ã ã¨ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ãªã£ã¦ãŸã€‚

```sh
node ./scripts/processDiagnosticMessages.mjs ./src/compiler/diagnosticMessages.json
```

`diagnosticMessages.json`ãŒå…ƒãƒã‚¿ã§ã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`src/compiler/diagnosticInformationMap.generated.ts`ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚

> https://github.com/microsoft/TypeScript/blob/main/src/compiler/diagnosticMessages.json

ãã†ã™ã‚‹ã¨ã€exportã•ã‚Œã¦ã„ã‚‹`Diagnostics`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã€å„ã‚³ãƒ¼ãƒ‰ãŒimportã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã„ã†ä»•çµ„ã¿ã€‚

```ts
export const Diagnostics = {
  Unterminated_string_literal: diag(1002, DiagnosticCategory.Error, "Unterminated_string_literal_1002", "Unterminated string literal.") as DiagnosticMessage,
  Identifier_expected: diag(1003, DiagnosticCategory.Error, "Identifier_expected_1003", "Identifier expected.") as DiagnosticMessage,
  _0_expected: diag(1005, DiagnosticCategory.Error, "_0_expected_1005", "'{0}' expected.") as DiagnosticMessage,
  // ...
```

`DiagnosticMessage`ã¯ãã‚Œãã‚Œ`code`ãŒå‰²ã‚ŠæŒ¯ã‚‰ã‚Œã¦ã¦ã€`TS1002`ã¿ãŸã„ãªã‚„ã¤ãŒãã‚Œã€‚ã“ã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯é‡è¤‡ã™ã‚‹ã“ã¨ã¯ãªã„ã‚ˆã†ã§ã€å…ƒãƒã‚¿ã«ã¯å…¨éƒ¨ã§2119ä»¶ãŒå®šç¾©ã•ã‚Œã¦ãŸã€‚å¤šã„ï¼

ã‚«ãƒ†ã‚´ãƒªã‚‚ã„ãã¤ã‹ã‚ã£ã¦ã€ãã®ã†ã¡"Error"ã‚«ãƒ†ã‚´ãƒªã«å±ã™ã‚‹ã‚‚ã®ã¯ã€1343ä»¶ã ã£ãŸã€‚

### ä½™è«‡

ã¡ãªã¿ã«ã€`./scripts/find-unused-diagnostic-messages.mjs`ã£ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚ç”¨æ„ã•ã‚Œã¦ã¦ã€ä½¿ã‚ã‚Œã¦ãªã„ã‚‚ã®ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã‚‹æ„Ÿã˜ã ã£ãŸã€‚

ãŸã ãƒ»ãƒ»ãƒ»ã€ä¸­èº«ã¯æ„šç›´ã«å…¨ã‚­ãƒ¼ã‚’ç›´åˆ—ã®`grep`ã§`./src`é…ä¸‹ã‚’æ¢ã—æ­©ãã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚ã‚Šã€å®Ÿè¡Œã«7åˆ†ã‚‚ã‹ã‹ã£ãŸã®ã«è‚å¿ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦‹åˆ‡ã‚Œã¦ã¦ã™ã”ãæ®‹å¿µã ã£ãŸã€‚
ãã®ä¸Šã€ä»Šæ™‚ç‚¹ã§ã‚‚130ä»¶ãã‚‰ã„ã¯unusedãªã‚‚ã®ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸã€‚ï¼ˆã¤ã¾ã‚Šã€ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆè‡ªä½“ã—ã°ã‚‰ãä½¿ã‚ã‚Œã¦ãªã•ãã†ãƒ»ãƒ»ãƒ»ï¼‰

ã‚‚ã†ã²ã¨ã¤ã¡ãªã‚€ã¨ã€ã‚³ãƒ¼ãƒ‰ä¸­ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§æ›¸ã‹ã‚Œã¦ã‚‹ã‚‚ã®ã‚‚ã‚ã‚‹ã€‚

> https://github.com/search?q=repo%3Amicrosoft%2FTypeScript+%2F%5Cbcode%3A+-%3F%5Cd%2F+path%3A%2F%5Esrc%5C%2F%2F&type=code

ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã¯ã€`-1`ã¨`0`ã¨`9999`ãŒã„ãŸã€‚ãã£ã¨ãƒ¬ã‚¢ã‚±ãƒ¼ã‚¹ãªã‚“ã‚„ã‚ã†ã€‚

## ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åˆ¤åˆ¥ã§ãã‚‹ï¼Ÿ

ã‚‚ã—ã‹ã—ã¦ã€ãŸã¨ãˆã°1xxxã‚·ãƒªãƒ¼ã‚ºãŒæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã£ã¦ã“ã¨ã«ãªã£ã¦ãªã„ã‹ï¼Ÿã¨æ€ã£ã¦èª¿ã¹ãŸã€‚

ã¾ãšã¯ãƒ¬ãƒ³ã‚¸ã«åˆ†ã‘ã¦ã¿ã‚‹ã€‚

```sh
jq -r 'to_entries | map(.value.code) | group_by(. / 1000 | floor) | map("\(.[0] / 1000 | floor)xxx: \(length)")[]' ./src/compiler/diagnosticMessages.json
```

ã™ã‚‹ã¨ã€ã“ã†ã„ã†åˆ†å¸ƒã«ãªã£ãŸã€‚
ã–ã£ãã‚Šçœºã‚ã¦ãƒ©ãƒ™ãƒ«ã‚‚ã¤ã‘ã¦ã¿ãŸã‘ã©ã€ã¾ã‚ä»®èª¬ã¯æ—©ãã‚‚å´©ã‚Œå»ã£ãŸã€‚

- 1xxx(461): JSã¨ã—ã¦ã®æ–‡æ³•ã‚¨ãƒ©ãƒ¼é–¢é€£
- 2xxx(536): å‹ã‚¨ãƒ©ãƒ¼ã€TSã¨ã—ã¦ã®æ–‡æ³•ã‚¨ãƒ©ãƒ¼é–¢é€£
- 4xxx(111): import/exporté–¢é€£
- 5xxx(66): fs, tsconfigé–¢é€£
- 6xxx(489): `compilerOptions`é–¢é€£
- 69xxx(1): ï¼ˆ`69010`ã ã‘ã€`6910`ã®typoã£ã½ã„ï¼‰
- 7xxx(55): å‹æ¨è«–é–¢é€£
- 8xxx(36): ã‚¨ãƒ‡ã‚£ã‚¿ã€JSDocé–¢é€£
- 9xxx(34): `--isolatedDeclarations`é–¢é€£
- 17xxx(21): JSXæ–‡æ³•ã‚¨ãƒ©ãƒ¼é–¢é€£
- 18xxx(52): ES2015+é–¢é€£
- 80xxx(10): "Suggestion"ã‚«ãƒ†ã‚´ãƒªé–¢é€£
- 90xxx(55): "Message"ã‚«ãƒ†ã‚´ãƒªé–¢é€£
- 95xxx(192): "Message"ã‚«ãƒ†ã‚´ãƒªé–¢é€£

ãƒ‘ãƒ¼ã‚µãƒ¼ã¨ã—ã¦ã¯ä¸è¦ãªãƒ¬ãƒ³ã‚¸ã¨æ–­å®šã§ããã†ãªã‚‚ã®ã‚‚ã‚ã‚‹ã‘ã©ã€ã‚„ã£ã±ã‚Šã‚³ãƒ¼ãƒ‰ã ã‘ã§ã¯å¿ƒè¨±ãªã„ã€‚

## æ¯æ•°ã‚’æ¸›ã‚‰ã—ãŸã„

TypeScriptã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«ã€`./tests/cases/compiler`ã¨ã‹ã€`./tests/cases/conformance`ã¨ã„ã†ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹ã€‚

ã„ã‚ã‚†ã‚‹ãƒ‘ãƒ¼ã‚µãƒ¼é–¢é€£ã§ã‚ˆãå‚ç…§ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŸã¡ã§ã€ãã®ä¸­ã«ã¯ã€TSCãŒæ˜ç¤ºçš„ã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã™ã‚‹ã¹ãï¼ã¨ã„ã†ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ã€‚

ãã®è¨¼å·¦ã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŸã¡ã¯`./tests/baselines/reference`ã«ã‚ã‚Šã€`ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹å.errors.txt`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãªã‚‰ã€ãã®ã‚±ãƒ¼ã‚¹ã§ã¯ã‚¨ãƒ©ãƒ¼ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒæœŸå¾…ã•ã‚Œã‚‹ã¨ã„ã†æ„Ÿã˜ã€‚

ãªã®ã§ã¤ã¾ã‚Šã€ã“ã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ä¸­ã‹ã‚‰`.errors.txt`ãŒå­˜åœ¨ã™ã‚‹ã‚±ãƒ¼ã‚¹ã ã‘ã‚’å‰²ã‚Šå‡ºã—ã€ãã“ã«ã‚ã‚‹å…¨ã‚³ãƒ¼ãƒ‰ã‚’å¾—ã‚‹ã“ã¨ã§ã€ãƒ‘ãƒ¼ã‚µãƒ¼ãŒå‡ºåŠ›ã™ã¹ãæ¯æ•°ã«ã§ãã‚‹ã¯ãšã€‚
ç´”ç²‹ãªå‹ã‚¨ãƒ©ãƒ¼ãªã‚“ã‹ã‚’é™¤å¤–ã™ã‚‹å¿…è¦ã¯ã¾ã ã‚ã‚‹ã‘ã©ã€ç²¾æŸ»ã™ã¹ãæ¯æ•°ã¯ç¢ºå®Ÿã«æ¸›ã‚‰ã™ã“ã¨ã¯ã§ãã‚‹ã¯ãšï¼

ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

```ts
/// <reference lib="esnext" />
import { readFile } from "node:fs/promises";
import { glob } from "glob";

const TARGET_TESTS = ["compiler", "conformance"];

const allUsedErrorDiagnostics: Map<number, string> = new Map();
for (const t of TARGET_TESTS) {
  const testFilePaths = await glob(`${t}/**/*.ts`, { cwd: "./tests/cases" });

  const usedErrorDiagnostics: Map<number, string> = new Map();
  for (const testFilePath of testFilePaths) {
    const testFileName = testFilePath.split("/").pop()!.replace(".ts", "");
    try {
      const errorsText = await readFile(
        `./tests/baselines/reference/${testFileName}.errors.txt`,
        "utf8",
      );

      const diagnostics = extractCodeAndMessages(errorsText);
      for (const [code, message] of diagnostics) {
        usedErrorDiagnostics.set(code, message);
        allUsedErrorDiagnostics.set(code, message);
      }
    } catch {
      // This test case does not expect any error diagnostics, so skip it
      continue;
    }
  }
  console.log(
    "ğŸ€",
    `Found ${usedErrorDiagnostics.size} error diagnostics are used for ${t} tests.`,
  );
  showRangeStats(usedErrorDiagnostics);
  console.log();
}
console.log(
  "ğŸ€",
  `Found ${allUsedErrorDiagnostics.size} error diagnostics are used for ${TARGET_TESTS.join("|")} tests.`,
);

// ---

function extractCodeAndMessages(errorsText: string) {
  const lines = errorsText.split("\n");
  const diagnostics = new Map();
  for (const line of lines) {
    if (!line.startsWith("!!! error TS")) continue;

    const [codePart, messagePart] = line.split(": ");
    const [, codeString] = codePart.split("error TS");
    const code = Number(codeString);
    const message = messagePart.trim();

    // -1, 0, 9999 is inlined in the source code, we don't need them
    if (code <= 0 || code === 9999) continue;

    diagnostics.set(code, message);
  }
  return diagnostics;
}

function showRangeStats(diagnostics: Map<number, string>) {
  const sortedDiagnostics = [...diagnostics.entries()].sort(
    (a, b) => a[0] - b[0],
  );

  const diagnosticsByCodeRange: Record<string, number[]> = {};
  for (const [code] of sortedDiagnostics) {
    // 1000 => 1xxx, 1001 => 1xxx, 1999 => 1xxx, etc
    const range = String(Math.floor(code / 1000) * 1000).replaceAll("0", "x");
    diagnosticsByCodeRange[range] ??= [];
    diagnosticsByCodeRange[range].push(code);
  }

  for (const [range, codes] of Object.entries(diagnosticsByCodeRange))
    console.log(`- ${range}: ${codes.length}`);
}
```

å®Ÿè¡Œã™ã‚‹ã¨ã“ã†ãªã£ãŸã€‚

```
ğŸ€ Found 688 error diagnostics are used for compiler tests.
- 1xxx: 213
- 2xxx: 326
- 4xxx: 10
- 5xxx: 25
- 6xxx: 21
- 7xxx: 33
- 8xxx: 18
- 9xxx: 19
- 17xxx: 10
- 18xxx: 13

ğŸ€ Found 672 error diagnostics are used for conformance tests.
- 1xxx: 244
- 2xxx: 314
- 4xxx: 12
- 5xxx: 12
- 6xxx: 8
- 7xxx: 21
- 8xxx: 20
- 9xxx: 2
- 17xxx: 10
- 18xxx: 29

ğŸ€ Found 927 error diagnostics are used for compiler|conformance tests.
```

ã‚„ã¯ã‚Šã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ©Ÿæ¢°çš„ã«å‰²ã‚Šå‡ºã™ã“ã¨ã¯ã§ããªãã†ã€‚

æ¯æ•°ãŒ2000è¶…ãˆã‹ã‚‰ä¸€æ°—ã«åŠæ¸›ã—ãŸã®ã¯ã†ã‚Œã—ã„ãŒã€æ¶ˆãˆã‚‹ã‹ã¨æ€ã‚ã‚ŒãŸ8xxxã‚„9xxxã™ã‚‰æ®‹ã£ã¦ã‚‹ã€‚

ã¾ãæœ€æ‚ªã€927ä»¶ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ‰‹å‹•ã§ä»•åˆ†ã‘ã‚Œã°ã„ã„ã“ã¨ã¯ã‚ã‹ã£ãŸã‘ã©ã€ãã‚Œã¯æœ€çµ‚æ‰‹æ®µã¨ã—ãŸã„ã€‚

## compileré…ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ä½¿ç”¨ã•ã‚Œã¦ã‚‹ã‚‚ã®

TSCã‚’æ§‹æˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ãã‚Œãã‚Œã§ã€ã©ã®`Diagnostics`ã‚’å‚ç…§ã—ã¦ã‚‹ã‹ã‚’èª¿ã¹ã‚‹ã€‚

`ast-grep`ã‚’ä½¿ã£ã¦`Diagnostics.xxx`ã¨ã„ã†ã‚¢ã‚¯ã‚»ã‚¹ã®ä»•æ–¹ã‚’ã—ã¦ã‚‹éƒ¨åˆ†ã‚’æŠ½å‡ºã™ã‚‹ä½œæˆ¦ã€‚

```ts
/// <reference lib="esnext" />
import { exec } from "node:child_process";
import { promisify } from "node:util";
import { Diagnostics } from "./src/compiler/diagnosticInformationMap.generated";
import { DiagnosticCategory } from "./src/compiler/types";

const targetComponents = await execCmd(
  "sg -p 'Diagnostics.$$$' ./src/compiler --json | jq '.[].file' | sort | uniq",
).then((r) => r.split("\n"));

for (const c of targetComponents) {
  const refs = await execCmd(
    `sg -p 'Diagnostics.$$$' ./${c} --json | jq '.[].text' | sort | uniq`,
  );

  const usedErrorDiagnostics: Map<number, string> = new Map();
  for (const line of refs.split("\n")) {
    const ref = line.slice(1, -1); // strip "
    const [, id] = ref.split("."); // Diagnostics.xxx

    const digagnostic = Diagnostics[id];

    // NOTE: Only error diagnostics are needed
    if (digagnostic.category !== DiagnosticCategory.Error) continue;
    usedErrorDiagnostics.set(digagnostic.code, digagnostic.message);
  }

  // Skip if no error diagnostics are used
  if (usedErrorDiagnostics.size === 0) continue;

  console.log(
    "ğŸ€",
    `Found ${usedErrorDiagnostics.size} error diagnostics are used in ${c}.`,
  );
  showRangeStats(usedErrorDiagnostics);
  console.log();
}

// ---

async function execCmd(cmd: string) {
  const execAsync = promisify(exec);
  try {
    const { stdout } = await execAsync(cmd);
    return stdout.trim();
  } catch (error) {
    console.error("Failed to execute command:", error);
    process.exit(1);
  }
}

function showRangeStats(diagnostics: Map<number, string>) {
  const sortedDiagnostics = [...diagnostics.entries()].sort(
    (a, b) => a[0] - b[0],
  );

  const diagnosticsByCodeRange: Record<string, number[]> = {};
  for (const [code] of sortedDiagnostics) {
    // 1000 => 1xxx, 1001 => 1xxx, 1999 => 1xxx, etc
    const range = String(Math.floor(code / 1000) * 1000).replaceAll("0", "x");
    diagnosticsByCodeRange[range] ??= [];
    diagnosticsByCodeRange[range].push(code);
  }

  for (const [range, codes] of Object.entries(diagnosticsByCodeRange))
    console.log(`- ${range}: ${codes.length}`);
}
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ»ãƒ»ãƒ»ã€

```
ğŸ€ Found 29 error diagnostics are used in "src/compiler/binder.ts".
- 1xxx: 18
- 2xxx: 7
- 5xxx: 1
- 7xxx: 2
- 18xxx: 1

ğŸ€ Found 905 error diagnostics are used in "src/compiler/checker.ts".
- 1xxx: 258
- 2xxx: 502
- 4xxx: 20
- 5xxx: 7
- 6xxx: 15
- 7xxx: 39
- 8xxx: 13
- 17xxx: 12
- 18xxx: 39

ğŸ€ Found 38 error diagnostics are used in "src/compiler/commandLineParser.ts".
- 1xxx: 3
- 5xxx: 16
- 6xxx: 12
- 8xxx: 1
- 17xxx: 2
- 18xxx: 4

ğŸ€ Found 7 error diagnostics are used in "src/compiler/executeCommandLine.ts".
- 5xxx: 6
- 6xxx: 1

ğŸ€ Found 3 error diagnostics are used in "src/compiler/moduleNameResolver.ts".
- 2xxx: 2
- 6xxx: 1

ğŸ€ Found 78 error diagnostics are used in "src/compiler/parser.ts".
- 1xxx: 57
- 2xxx: 7
- 8xxx: 3
- 17xxx: 7
- 18xxx: 4

ğŸ€ Found 172 error diagnostics are used in "src/compiler/program.ts".
- 1xxx: 77
- 2xxx: 15
- 5xxx: 35
- 6xxx: 16
- 7xxx: 2
- 8xxx: 15
- 17xxx: 3
- 18xxx: 9

ğŸ€ Found 2 error diagnostics are used in "src/compiler/programDiagnostics.ts".
- 2xxx: 2

ğŸ€ Found 67 error diagnostics are used in "src/compiler/scanner.ts".
- 1xxx: 64
- 6xxx: 2
- 18xxx: 1

ğŸ€ Found 18 error diagnostics are used in "src/compiler/transformers/declarations.ts".
- 2xxx: 2
- 4xxx: 4
- 5xxx: 1
- 6xxx: 2
- 7xxx: 1
- 9xxx: 8

ğŸ€ Found 115 error diagnostics are used in "src/compiler/transformers/declarations/diagnostics.ts".
- 4xxx: 87
- 9xxx: 28

ğŸ€ Found 2 error diagnostics are used in "src/compiler/tsbuildPublic.ts".
- 6xxx: 2

ğŸ€ Found 8 error diagnostics are used in "src/compiler/utilities.ts".
- 1xxx: 1
- 2xxx: 3
- 5xxx: 1
- 7xxx: 3

ğŸ€ Found 3 error diagnostics are used in "src/compiler/utilitiesPublic.ts".
- 6xxx: 3
```

ã‚ã‚‹ç¨‹åº¦ã®å‚¾å‘ã¯ã‚ã‹ã‚‹ã‘ã©ã€æ±ºã‚æ‰‹ã«æ¬ ã‘ã‚‹ãƒ»ãƒ»ãƒ»ã€‚ã‚‚ã¡ã‚ã‚“å¤‰æ•°åãŒé•ã£ãŸã‚Šã™ã‚‹ã¨å¼•ã£ã‹ã‹ã‚‰ãªã„ã®ã§ã€å®Œç’§ã§ã‚‚ãªã„ã€‚

TSCã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ã¯ã€`_namespaces/ts.ts`ã¨ã„ã†ã‚„ã¤ãŒé•·å¤§ãªBarrel exportã‚’ã—ã¦ã¦ã€ãã‚Œã‚’å„`parser.ts`ã‚„ã‚‰ãŒåˆ©ç”¨ã™ã‚‹å½¢ã«ãªã£ã¦ã‚‹ã®ã§ã€ä¾å­˜ã‚°ãƒ©ãƒ•ã¾ã§è¿½ã‚ãªã„ã¨ç›¸äº’é–¢ä¿‚ãŒã‚ã‹ã‚‰ãªã„ã€‚

çµå±€ã“ã‚Œã‚’çªãã¤ã‚ã‚‹ã¨ã™ã‚‹ãªã‚‰ã€

- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã«ã‚ãŸã‚Šã‚’ã¤ã‘ã‚‹
  - `parser.ts`ã®`createSourceFile()`ã¨ã‹ï¼Ÿ
- ãã“ã‚’ãƒ«ãƒ¼ãƒˆã¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹
  - Miifyã¯ã›ãšã€Tree shakingã«æœŸå¾…ã™ã‚‹
- ãƒãƒ³ãƒ‰ãƒ«ã•ã‚ŒãŸçµæœã«å¯¾ã—ã¦ã€åŒæ§˜ã«`Diagnostics.xxx`ã®å‚ç…§ã‚’è¦‹ã¤ã‘ã‚‹

ãã‚‰ã„ã—ãªã„ã¨ãƒ€ãƒ¡ãã†ã€‚ãŸã ãã‚Œã§ã‚‚ã€`checker.ts`ãŒå‚ç…§ã—ã¦ã‚‹2xxxã‚·ãƒªãƒ¼ã‚ºã®ã†ã¡ã€ã©ã‚ŒãŒä¸è¦ã‹ã¯åˆ¤æ–­ã§ããªã„ã€‚

## parseErrorã¨grammarError

TSCã®ã‚³ãƒ¼ãƒ‰ã‚’çœºã‚ã¦ã‚‹ã¨ã€`Diagnostics.xxx`ã‚’ä½¿ã£ã¦ã‚‹ã‚³ãƒ¼ãƒ‰ã®å‚¾å‘ãŒãªã‚“ã¨ãªãè¦‹ãˆã¦ãã¦ã€

- `parseErrorAt()`
- `parseErrorAtCurrentToken()`
- `grammarErrorOnNode()`
- `grammarErrorOnFirstToken()`

ã¿ãŸã„ãªä½¿ã‚ã‚Œæ–¹ã‚’ã—ã¦ã‚‹ã®ãŒã‚ã‹ã‚‹ã€‚

ãªã®ã§ã€ã“ã‚Œã‚‰ã®å‘¼ã³å‡ºã—ã ã‘ã«çµã£ã¦ã¿ã‚Œã°ï¼Ÿã¨ã„ã†ä½œæˆ¦ã€‚

```ts
/// <reference lib="esnext" />
import { exec } from "node:child_process";
import { promisify } from "node:util";
import { Diagnostics } from "./src/compiler/diagnosticInformationMap.generated";
import { DiagnosticCategory } from "./src/compiler/types";

const SG_YML = `
id: parse-or-grammar-error
language: TypeScript
rule:
  pattern: $FN($$$)
constraints:
  FN: { regex: "^(parse|grammar)Error" }
`;
const targetCalls = await execCmd(
  `sg scan --inline-rules '${SG_YML}' --json | jq '.[].text' | sort | uniq`,
);

let noDirectCallCount = 0;
const usedErrorDiagnostics: Map<number, string> = new Map();
for (const line of targetCalls.split("\n")) {
  const [, argsPartAndCloseParen] = line.split("(");
  const [argsPart] = argsPartAndCloseParen.split(")");
  const args = argsPart.split(", ");

  const diagnosticArg = args.find((arg) => arg.startsWith("Diagnostics."));
  if (!diagnosticArg) {
    // console.warn("No direct `Diagnostics.` call found in:", line);
    noDirectCallCount++;
    continue;
  }

  const [, id] = diagnosticArg.split("."); // Diagnostics.xxx

  const digagnostic = Diagnostics[id];
  // NOTE: Only error diagnostics are needed
  if (digagnostic.category !== DiagnosticCategory.Error) continue;
  usedErrorDiagnostics.set(digagnostic.code, digagnostic.message);
}
console.log(
  "ğŸ€",
  `Found ${usedErrorDiagnostics.size} error diagnostics are used in (parse|grammar)Error calls.`,
);
showRangeStats(usedErrorDiagnostics);
console.warn(
  "âš ï¸",
  `Found ${noDirectCallCount} calls to (parse|grammar)Error without direct Diagnostics reference.`,
);

// ---

async function execCmd(cmd: string) {
  const execAsync = promisify(exec);
  try {
    const { stdout } = await execAsync(cmd);
    return stdout.trim();
  } catch (error) {
    console.error("Failed to execute command:", error);
    process.exit(1);
  }
}

function showRangeStats(diagnostics: Map<number, string>) {
  const sortedDiagnostics = [...diagnostics.entries()].sort(
    (a, b) => a[0] - b[0],
  );

  const diagnosticsByCodeRange: Record<string, number[]> = {};
  for (const [code] of sortedDiagnostics) {
    // 1000 => 1xxx, 1001 => 1xxx, 1999 => 1xxx, etc
    const range = String(Math.floor(code / 1000) * 1000).replaceAll("0", "x");
    diagnosticsByCodeRange[range] ??= [];
    diagnosticsByCodeRange[range].push(code);
  }

  for (const [range, codes] of Object.entries(diagnosticsByCodeRange))
    console.log(`- ${range}: ${codes.length}`);
}
```

çµæœã¯ã“ã†ã€‚

```
ğŸ€ Found 210 error diagnostics are used in (parse|grammar)Error calls.
- 1xxx: 155
- 2xxx: 20
- 5xxx: 4
- 7xxx: 3
- 8xxx: 3
- 17xxx: 9
- 18xxx: 16
âš ï¸ Found 42 calls to (parse|grammar)Error without direct Diagnostics reference.
```

210ä»¶ã¯ã€æ€ã£ã¦ãŸã‚ˆã‚Šã¡ã‚‡ã£ã¨å°‘ãªã„ãƒ»ãƒ»ãƒ»ã€‚
42ä»¶ã®å‘¼ã³å‡ºã—å…ƒã¾ã§ã¡ã‚ƒã‚“ã¨è§£æ±ºã—ã¦ã‚„ã‚‰ã‚“ã¨ãƒ€ãƒ¡ãã†ã‹ã€‚

åå¯¾ã«ã€`checker.ts`ã®ä¸­ã®`checkXxx()`ã§ä½¿ã‚ã‚Œã¦ã‚‹ã®ã‚’é™¤å¤–ã—ã¦ã„ãä½œæˆ¦ã‚‚ã‚ã‚Šãã†ã ãŒã€ã©ã¡ã‚‰ã«ã›ã‚ˆçµå±€ãã“ã§æˆ‘ã€…ãŒæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã¨è¦‹ãªã™ã‚‚ã®ãŒå‡¦ç†ã•ã‚Œã¦ãªã„ä¿è¨¼ã¯ãªã„ã€‚

## ã¾ã¨ã‚

`compiler`ã¨`conformance`ã®ãƒ†ã‚¹ãƒˆã§å‚ç…§ã•ã‚Œã‚‹`.errors.txt`ã«ç™»å ´ã™ã‚‹927ä»¶ã®ã‚³ãƒ¼ãƒ‰ãŒmaxã®æ¯æ•°ã«ãªã‚‹ã®ã¯ç¢ºå®šã§ã‚ˆã„ã¯ãšã€‚

ã—ã‹ã—ã€ãã“ã‹ã‚‰ç´”ç²‹ãªå‹ã‚¨ãƒ©ãƒ¼é¡ã‚’é™¤å¤–ã™ã‚‹æ–¹æ³•ã¯ã€ã¾ã ç¢ºç«‹ã§ãã¦ã„ãªã„ã€‚

å…¨ä»¶ã‚’ç²¾æŸ»ã™ã‚‹ã—ã‹ãªã„ã¨ã—ã¦ã€ã“ã‚Œã‚‰ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«å¯¾ã—ã¦`getSyntacticDiagnostics()`ã‚’å®Ÿè¡Œã—ã¦ã€ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸåˆ†ã¯ç¢ºå®Ÿã«æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦é–“å¼•ãã“ã¨ã¯ã§ããã†ã ãŒãƒ»ãƒ»ãƒ»ã€‚ï¼ˆãŠãã‚‰ã`scanner.ts`+`parser.ts`ã§è¦‹ã¤ã‹ã£ãŸ140ä»¶ãã‚‰ã„ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã—ãŸæ•°ï¼‰

ãªã‚“ã‹ã‚‚ã£ã¨ã„ã„ã‚„ã‚Šæ–¹ã¯ãªã„ã ã‚ã†ã‹ã€œã€‚

> Some syntactic diagnostic errors erroneously reported as semantic Â· Issue #52011 Â· microsoft/TypeScript
> https://github.com/microsoft/TypeScript/issues/52011

ğŸ¥ª...

## ãŠã¾ã‘: é–¢é€£APIãŸã¡

å†’é ­ã§ã•ã‚‰ã£ã¨æ›¸ã„ã¦ã‚‹ã‘ã©ã€TSCã®APIã«ã¯ã€`Diagnostics`ã‚’`get`ã™ã‚‹ç³»ã®APIãŒã„ã‚ã„ã‚ã‚ã‚‹ã€‚

- `getPreEmitDiagnostics()`
  - https://github.com/microsoft/TypeScript/blob/dd1e258ba56f1b511879372c857fb625de3dec4a/src/compiler/program.ts#L636
  - ãã®åã®é€šã‚Š`emit()`ãŒå‘¼ã°ã‚Œã‚‹å‰æ®µéšã§ã®ã‚¨ãƒ©ãƒ¼ä¸€è¦§
  - `emit()`ã¯ã€`.ts`ã‹ã‚‰`.js`ã‚„`.d.ts`ã‚’ç”Ÿæˆã™ã‚‹å‡¦ç†ã®ã“ã¨
  - ä¸­èº«ã¯ä»¥ä¸‹ã®å„`getXxxDiagnostics()`ã‚’concatã—ãŸã‚‚ã®
- `getConfigFileParsingDiagnostics()`
  - https://github.com/microsoft/TypeScript/blob/dd1e258ba56f1b511879372c857fb625de3dec4a/src/server/session.ts#L1532
- `getOptionsDiagnostics()`
  - https://github.com/microsoft/TypeScript/blob/dd1e258ba56f1b511879372c857fb625de3dec4a/src/compiler/program.ts#L3296
- `getSyntacticDiagnostics()`
  - https://github.com/microsoft/TypeScript/blob/dd1e258ba56f1b511879372c857fb625de3dec4a/src/compiler/program.ts#L2823
  - ä¸­èº«ã¯`sourceFile.parseDiagnostics`ã§ã€ã“ã‚Œã¯`parseErrorXxx()`ã®æ™‚ã«pushã—ã¦ã‚‹ã‚„ã¤
  - https://github.com/microsoft/TypeScript/blob/dd1e258ba56f1b511879372c857fb625de3dec4a/src/compiler/parser.ts#L2159
  - JSãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯ã€TSã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãŒä½¿ã‚ã‚Œã¦ãŸã‚‰ã‚¨ãƒ©ãƒ¼æ‰±ã„ã«ãªã‚‹`sourceFile.additionalSyntacticDiagnostics`ãŒconcatã•ã‚Œã‚‹
- `getGlobalDiagnostics()`
  - https://github.com/microsoft/TypeScript/blob/dd1e258ba56f1b511879372c857fb625de3dec4a/src/compiler/program.ts#L3312
  - `TypeChecker#getGlobalDiagnostics()`
- `getSemanticDiagnostics()`
  - https://github.com/microsoft/TypeScript/blob/dd1e258ba56f1b511879372c857fb625de3dec4a/src/compiler/program.ts#L2827
  - https://github.com/microsoft/TypeScript/blob/dd1e258ba56f1b511879372c857fb625de3dec4a/src/compiler/program.ts#L2887
  - = `getBindAndCheckDiagnosticsForFile()`(`sourceFile.bindDiagnostics` + `TypeChecker#getDiagnostics()`) + `getProgramDiagnostics()`
- `getDeclarationDiagnostics()`
  - https://github.com/microsoft/TypeScript/blob/dd1e258ba56f1b511879372c857fb625de3dec4a/src/compiler/program.ts#L2856


