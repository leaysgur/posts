---
title: ç¶šãƒ»TypeScriptã®`Diagnostics`ã«ã¤ã„ã¦
---

å‰å›ã¯ã“ã¡ã‚‰ã€‚

> TypeScriptã®`Diagnostics`ã«ã¤ã„ã¦ | Memory ice cubes
> https://leaysgur.github.io/posts/2025/06/13/131109/

## å‰å›ã¾ã§ã®ã‚ã‚‰ã™ã˜

- TSCã®`Diagnostics`ã«ã¤ã„ã¦ã€ç´”ç²‹ã«ã‚³ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¼ã‚¹ã«éš›ã—ã¦æ¤œè¨¼ã™ã¹ãã‚‚ã®ã‚’çŸ¥ã‚ŠãŸã‹ã£ãŸ
- å˜ç´”ãªJSã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã¯ã‚‚ã¡ã‚ã‚“ã€TSç‰¹æœ‰ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’æ‹¾ã„ãŸã„
- ã—ã‹ã—ã€å‹ã‚¨ãƒ©ãƒ¼ã¯ã„ã‚‰ãªã„ã—ã€TSCå›ºæœ‰ã®è¨­å®šé–¢é€£ã‚‚ã„ã‚‰ãªã„
- ã“ã‚Œã‚’ã©ã†åŠ¹ç‡ã‚ˆãä»•åˆ†ã‘ã‚‰ã‚Œã‚‹ã‹ã‚’æ¢ã—ã¦ãŸ

TSCã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§ã‚ã‚‹`./tests/cases/compiler|conformance`ã‹ã‚‰å‚ç…§ã•ã‚Œã‚‹ã€`./tests/baselines/reference`é…ä¸‹ã§å®Ÿéš›ã«è¨˜éŒ²ã•ã‚Œã¦ã‚‹ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒèª¿æŸ»ã™ã¹ãæ¯é›†å›£ã€‚

```
ğŸ€ Found 700 error diagnostics are used for compiler tests.
ğŸ€ Found 695 error diagnostics are used for conformance tests.

ğŸ€ Found 950 error diagnostics are used for compiler|conformance tests.
```

ã“ã®950ã‚’æ‰‹ä½œæ¥­ã§ä»•åˆ†ã‘ãŸããªã„ã®ã§ã€ã‚‚ã£ã¨æ‰‹å …ãæ¸›ã‚‰ã™ã“ã¨ã¯ã§ããªã„ã‹ï¼Ÿã¨ã„ã†ä¸»æ—¨ã€‚

ã§ã€ã¾ãšã¯ã€ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’è¦‹ã¦ã€1000ç•ªå°ãªã‚‰æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ»ãƒ»ã¨ã„ã†ã‚ˆã†ã«ã¯åˆ†ã‘ã‚‰ã‚Œã‚‹ã‹ã‚’æ¤œè¨ã—ãŸãŒã€ã©ã†ã‚„ã‚‰ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã®åŒºåˆ¥ã¯æ›–æ˜§ã§ã€ã“ã®ä½œæˆ¦ã¯ãƒ€ãƒ¡ã ã£ãŸã€‚

æ¬¡ã«ã€`./src/compiler`é…ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã€

- `sg -p 'Diagnostics.$KEY'`ã‚’å®Ÿè¡Œã—ã¦
- `$KEY`ã‚’å…ƒã«ã€å®Ÿéš›ã®`Diagnostics`ã‚’å®šç¾©ã—ã¦ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰exportã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¼•ã
- ã‚¨ãƒ©ãƒ¼ã‚«ãƒ†ã‚´ãƒªã®ã‚³ãƒ¼ãƒ‰ã ã‘ã‚’æŠ½å‡º

ã¨ã„ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ¤œè¨ã—ãŸã€‚
å‚è€ƒã¾ã§ã«æŠœç²‹ã—ã¦ãŠãã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ•°å­—ãŒå–ã‚Œã¦ãŸã€‚

```
ğŸ€ Found 67 error diagnostics are used in "src/compiler/scanner.ts".
ğŸ€ Found 78 error diagnostics are used in "src/compiler/parser.ts".
ğŸ€ Found 29 error diagnostics are used in "src/compiler/binder.ts".
ğŸ€ Found 905 error diagnostics are used in "src/compiler/checker.ts".
```

ãŸã ã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã¯å•é¡ŒãŒã‚ã‚Šã€‚

- `Diagnostics.$KEY`ã¨ã„ã†ASTã™ã¹ã¦ãŒå¯¾è±¡ã«ãªã£ã¦ã—ã¾ã£ã¦ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ±²ã‚“ã§ãªã„
  - ãƒ‘ãƒ¼ã‚¹ã«é–¢ä¿‚ãªã„å‡¦ç†ãŒå®šç¾©ã•ã‚Œã¦ã„ãŸã‚‰æ‹¾ã£ã¦ã—ã¾ã†
- importã—ã¦ã‚‹å…ˆã®ã‚³ãƒ¼ãƒ‰ã‚’æ‹¾ãˆãªã„
  - TSCã¯å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒç›¸äº’ã«å¯†æ¥ã«é–¢ä¿‚ã—ã¦ã¦ã€`_namespaces/ts.ts`ã¨ã„ã†å·¨å¤§barrel exportã«ä¾å­˜ã—ã¦ã‚‹

ã“ã‚Œè§£æ±ºã§ããªã„ã‹ï¼Ÿã¨ã„ã†ã®ãŒä»Šå›ã®è¨˜äº‹ã®è©±ã€‚

## ãƒãƒ³ãƒ‰ãƒ«ã—ã¦ã—ã¾ã†

ãŸã¨ãˆã°`parser.ts`ãªã‚‰ã€`createSourceFile()`ãŒã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã«ãªã£ã¦ã„ã¦ã€ãã“ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹å‡¦ç†ãŒã¯ã˜ã¾ã‚‹ã€‚

ãªã®ã§ãã“ã‹ã‚‰è¾¿ã£ã¦ã€rollupã¿ãŸã„ãªãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ãƒãƒ³ãƒ‰ãƒ«ã™ã‚Œã°ã€æœ¬å½“ã«å¿…è¦ãª`Diagnostics`ã ã‘ãŒå–å¾—ã§ãã‚‹ã®ã§ã¯ï¼ŸTreeshakeã‚‚åŠ¹ããªã‚‰ã°ã€æ‡¸å¿µç‚¹ã¯è§£æ±ºã§ãã‚‹ã®ã§ã¯ï¼Ÿã¨é–ƒã„ãŸã€‚

ãã‚Œã‚’ã‚„ã£ã¦ã¿ãŸã®ãŒã“ã¡ã‚‰ã€‚

```ts
import { rollup } from "rollup";
import virtual from "@rollup/plugin-virtual";
import esbuild from "rollup-plugin-esbuild";
import { parse, Lang } from "@ast-grep/napi";

const parserCode = await bundleWithTreeshake(`
import { createSourceFile } from "./src/compiler/parser.ts";
const ast = createSourceFile("dummy.ts", code, 99);
`);

// NOTE: Parser uses Scanner internally
const parserUsedDiagnostics = extractErrorDiagnostics(parserCode);
console.log(
  "ğŸ€",
  parserUsedDiagnostics.size,
  "diagnostics used in the scanner+parser",
);

// ---

// Bundle the code:
// - to resolve `import` inside the each component
// - to drop unused code
async function bundleWithTreeshake(entry: string) {
  const bundle = await rollup({
    input: "entry",
    output: { format: "esm" },
    treeshake: {
      moduleSideEffects: false,
      preset: "smallest",
      propertyReadSideEffects: false,
    },
    plugins: [virtual({ entry }), esbuild({})],
    onLog: (level, log, handler) => {
      // This often happens with TSC...
      if (log.code !== "CIRCULAR_DEPENDENCY") handler(level, log);
    },
  });
  const {
    output: [{ code }],
  } = await bundle.generate({});
  bundle.close();

  return code;
}

function extractErrorDiagnostics(code: string) {
  const sgRoot = parse(Lang.TypeScript, code).root();
  const diagDecl = sgRoot.find("const Diagnostics = $$$")!;
  const diagCalls = diagDecl.findAll(
    "diag($CODE, DiagnosticCategory.Error, $_, $MESSAGE)",
  );
  const diagCallsWithOpts = diagDecl.findAll(
    "diag($CODE, DiagnosticCategory.Error, $_, $MESSAGE, $$$)",
  );

  const errorDiagnostics = new Map<number, string>();
  for (const diagCall of [...diagCalls, ...diagCallsWithOpts]) {
    const code = Number(diagCall.getMatch("CODE")!.text());
    const message = diagCall.getMatch("MESSAGE")!.text();
    errorDiagnostics.set(code, message);
  }

  return errorDiagnostics;
}
```

ï¼ˆ`virtual`ã‚¨ãƒ³ãƒˆãƒªãƒ¼åˆã‚ã¦ä½¿ã£ãŸã‘ã©ã€ã“ã‚Œã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®å¯¾è±¡ã«ãªã‚‰ãªã„ã“ã¨ã‚’çŸ¥ã£ãŸï¼‰

ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®å®šç¾©ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã€‚

- parser: `createSourceFile()`
- binder: `bindSouceFile()`
- checker: `createTypeChecker()`

ã™ã‚‹ã¨çµæœã¯ã“ã†ãªã£ãŸã€‚

```
ğŸ€ 151 diagnostics used in the scanner+parser
ğŸ€ 28 diagnostics used in the binder
ğŸ€ 904 diagnostics used in the checker
ğŸ€ 1083 diagnostics used in the scanner+parser, binder and checker
```

ã©ã†ã‚„ã‚‰binderã¯parserã«ä¾å­˜ã—ã¦ã„ã¦ã€checkerã‚‚binderã¨parserã«ä¾å­˜ã—ã¦ã‚‹ã‚ˆã†ã ã£ãŸã®ã§ã€ã“ã®æ•°å­—ã¯ãã‚Œã‚‰ã‚’å·®ã—å¼•ã„ã¦ã‚ã‚‹ã€‚

## è€ƒå¯Ÿ

é›‘ã«ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«`sg`ã—ã¦å¾—ã‚‰ã‚ŒãŸæ•°å­—ã¨ã€å¤§ããã¯å¤‰ã‚ã£ã¦ãªã„ã®ã¯è‰¯ã‹ã£ãŸã€‚

- `sg`ã‚ˆã‚Šã‚‚æ•°å­—ãŒå¢—ãˆã¦ã‚‹ã‚‚ã®ã¯ã€importå…ˆã«ã‚„ã£ã±ã‚Šãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã‚ã£ãŸã‚‚ã®ã§ã‚ã‚ã†
- `sg`ã‚ˆã‚Šã‚‚æ•°å­—ãŒæ¸›ã£ã¦ã‚‹ã‚‚ã®ã¯ã€ãƒ‘ãƒ¼ã‚¹ã«ç›´æ¥é–¢ä¿‚ãªã„å‡¦ç†ãŒã‚ã£ãŸã®ã§ã‚ã‚ã†

ãŸã ç·æ•°ãŒ950ã‚ˆã‚Šå¢—ãˆã¦1083ã«ãªã£ã¦ã‚‹ã®ã¯ã€æƒ³å®šå¤–ã ã£ãŸãƒ»ãƒ»ãƒ»ã€‚

ã“ã‚Œã¯ã¤ã¾ã‚Šã€`compiler|conformance`ã®ãƒ†ã‚¹ãƒˆä¸­ã«ã¯ç¾ã‚Œã¦ãªã„ã€ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ãªã„ã‚‚ã®ãŒã‚³ãƒ¼ãƒ‰ä¸­ã«ã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã£ã¦ã“ã¨ã€‚

`compiler|conformance`ã¨ã¯åˆ¥ã®ã€`project|transpile`ç³»ã®ãƒ†ã‚¹ãƒˆã§ä½¿ã‚ã‚Œã¦ã‚‹ã‚‚ã®ã‹ã‚‚ã—ã‚Œãªã„ã—ã€å˜ã«ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ãªã„ã ã‘ã‹ã‚‚ã—ã‚Œãªã„ã€‚

ã“ã†ãªã£ã¦ãã‚‹ã¨ã€ã“ã‚Œã‚‰ã®æ•°å­—ãŒã©ã‚Œãã‚‰ã„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ã‚«ãƒãƒ¼ã•ã‚Œã¦ã‚‹ã®ã‹æ°—ã«ãªã£ã¦ãã‚‹ã€‚

ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ãŸ950ç¨®ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”¨æ„ã—ã¦ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã§ä½¿ç”¨ã•ã‚Œã¦ã‚‹ã‚³ãƒ¼ãƒ‰ãŒã€å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ã‚’èª¿ã¹ã‚‹ã€‚

```ts
const parserUsedButNotTested = Array.from(parserUsedDiagnostics).filter(
  ([code]) => !allTestedErrorDiagnostics.has(code),
);
console.warn(
  "ğŸ‘€",
  parserUsedButNotTested.length,
  "diagnostics are used in the scanner+parser, but not tested in the compiler|conformance tests.",
);
```

ã™ã‚‹ã¨ã“ã†ãªã£ãŸã€‚

- parser: 36/151
- binder: 2/28
- checker: 178/904

ã“ã‚Œã‚‰ãŒã€"compiler|conformanceã®ãƒ†ã‚¹ãƒˆã«å‡ºã¦ã“ãªã„/ã‘ã©ã‚³ãƒ¼ãƒ‰ã§ä½¿ç”¨ã•ã‚Œã¦ã‚‹"ã‚³ãƒ¼ãƒ‰ã®æ•°ã€‚

ã“ã‚Œã‚’ãƒ‘ãƒ¼ã‚¹ã«é–¢ä¿‚ãªã„ã¨ã¿ãªã™ã‹ã€å˜ã«ãƒ†ã‚¹ãƒˆãŒãªã„ã ã‘ã¨ã¿ãªã™ã‹ã€‚ã¾ã‚ã§ã‚‚ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ãªã„ãªã‚‰æ¤œè¨¼ã—ã‚ˆã†ãŒãªã„ã—ã€ç„¡è¦–ã—ã¦ã„ã„ã®ã‹ï¼Ÿ

## æœ€çµ‚çš„ã«

- 950: `compiler|conformance`ãƒ†ã‚¹ãƒˆã«ç™»å ´ã™ã‚‹ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

ã“ã‚Œã‚’ç²¾æŸ»ã™ã¹ãå¿…è¦ãŒã‚ã£ãŸã‘ã©ã€

- 115(=151-36): `parser#createSourceFile()`ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¦ã€ãƒ†ã‚¹ãƒˆã«ç™»å ´ã™ã‚‹ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
- 26(=28-2): `binder#bindSourceFile()`ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¦ã€ãƒ†ã‚¹ãƒˆã«ç™»å ´ã™ã‚‹ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

ã“ã®2ã¤ã¯ç¢ºå®Ÿã«ãƒ‘ãƒ¼ã‚¹é–¢é€£ãªã®ã§å®‰å…¨ã«é™¤å¤–ã§ãã‚‹ã¨ã—ã¦ã€æ®‹ã£ãŸã®ã¯ã€

- 809(=950-(115+26)): ãƒ†ã‚¹ãƒˆã«ç™»å ´ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ã†ã¡ã€ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹parser+binderé–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚’å·®ã—å¼•ã„ãŸã‚‚ã®

ã“ã‚Œã‚’ç²¾æŸ»ã™ã‚Œã°ã„ã„ã£ã¦ã“ã¨ã«ãªã‚‹ãƒ»ãƒ»ãƒ»ãŒã€ãœã‚“ãœã‚“æ¸›ã£ã¦ãªã„ï¼
ï¼ˆãªã‚‰ã‚‚ã†950ã‚’ç²¾æŸ»ã—ãŸã‚‰ã‚ˆããªã„ï¼Ÿå …ç‰¢ã«ãªã£ãŸã¨ã¯ã„ãˆã€å®Œç’§ã§ã‚ã‚‹ä¿è¨¼ã¯ãªã„ã—ãƒ»ãƒ»ãƒ»ï¼‰

