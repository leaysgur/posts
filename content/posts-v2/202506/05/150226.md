---
title: JSX/TSXã®ASTã‚’ã€ã§ãã‚‹é™ã‚Šå…ƒã®ã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã«æˆ»ã—ãŸã„
---

å˜ã«å‹•ãã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã‚’ç”Ÿæˆã§ãã‚‹ã®ã¯æœ€ä½é™ã¨ã—ã¦ã€

- JSã ã‘ã˜ã‚ƒãªãã¦ã€TSã‚‚å¯¾å¿œã—ãŸã„
- ãªã‚“ãªã‚‰JSXã‚‚ã‚µãƒãƒ¼ãƒˆã™ã‚‹
- Stage3ãã‚‰ã„ã®ãƒ—ãƒ­ãƒãƒ¼ã‚¶ãƒ«ã«ã‚‚ã€ã§ãã‚Œã°å¯¾å¿œã—ãŸã„
- ã§ãã‚‹ã“ã¨ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚‚å¾©å…ƒã—ãŸã„ãƒ»ãƒ»ãƒ»

ã¨ã„ã†å ´åˆã«ã€ç¾çŠ¶ã©ã†ã„ã†å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹ã®ã‹ã‚’èª¿ã¹ãŸã‹ã£ãŸã€‚

## ã©ã®ASTã‚’é¸ã¶ã‹

ã“ã‚ŒãŒã»ã¨ã‚“ã©æ±ºå®šçš„ãªè¦å› ã«ãªã£ã¦ã‚‹ã€‚

- ESTree
- TS-ESTree
- Babel
- SWC
- TypeScript

ã–ã£ã¨èª¿ã¹ã‚‹ã¨ã“ã‚Œãã‚‰ã„ï¼Ÿ

ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ASTã‚’å–å¾—ã™ã‚‹ã¨ã“ã‚ã¾ã§ã¯ã€ä»¥ä¸‹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã‚„ã‚Œãã†ã€‚

- ESTree
  - https://www.npmjs.com/package/oxc-parser
  - https://www.npmjs.com/package/acorn
  - https://www.npmjs.com/package/meriyah
  - etc...
- TS-ESTree
  - https://www.npmjs.com/package/oxc-parser
  - https://www.npmjs.com/package/@typescript-eslint/typescript-estree
  - https://www.npmjs.com/package/@typescript-eslint/parser
- Babel
  - https://www.npmjs.com/package/@babel/parser
- SWC
  - https://www.npmjs.com/package/@swc/core
- TypeScript
  - https://www.npmjs.com/package/typescript
  - https://www.npmjs.com/package/ts-morph

ã¨ã„ã†ã‚ã‘ã§ã€ã©ã‚Œã‚’ä½¿ã†ã‹ã«ã‚ˆã£ã¦å¾Œç¶šã®ãƒ„ãƒ¼ãƒ«ã‚‚æ±ºã¾ã£ã¦ãã‚‹ã€‚

`@sveltejs/acorn-typescript`ã‚‚TS-ESTreeã‚’å‡ºåŠ›ã—ã‚ˆã†ã¨ã—ã¦ã‚‹ã‘ã©ã€å®Œå…¨ã§ã¯ãªã„ã¿ãŸã„ã€‚

> Further align with `@typescript-eslint/types` Â· Issue #7 Â· sveltejs/acorn-typescript
> https://github.com/sveltejs/acorn-typescript/issues/7

ã‚ã¨ã¯ã€ESTreeã‚’Babelã«æˆ»ãã†ã¨ã„ã†è©¦ã¿ã‚‚ã‚ã£ãŸã€‚

> coderaiser/estree-to-babel: convert estree ast to babel
> https://github.com/coderaiser/estree-to-babel

ã¡ãªã¿ã«Babelã¨ã—ã¦ã‚‚ã€Babel ASTã‚’ESTreeåŒ–ã™ã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒã‚ã‚‹ã€‚

> babel/packages/babel-parser/src/plugins/estree.ts at main Â· babel/babel
> https://github.com/babel/babel/blob/main/packages/babel-parser/src/plugins/estree.ts

ã§ã¯ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã®è©±ã¸ã€‚

## Babel, SWC, TypeScript

ã¾ãšã¯ãã‚Œã ã‘ã§å®Œçµã™ã‚‹å¸å›½ã‚·ãƒªãƒ¼ã‚ºã€‚

### `@babel/generator`

ãŠãã‚‰ãã‚‚ã£ã¨ã‚‚ã‚·ã‚§ã‚¢ãŒã‚ã‚Šä¿¡é ¼åº¦ã‚‚é«˜ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã¨å‹æ‰‹ã«æ€ã£ã¦ã‚‹ã€‚

è¨€ã‚ãšã‚‚ãŒãªã‚ã‚‰ã‚†ã‚‹æ§‹æ–‡ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã‚‹ã—ã€`@babel/traverse`ã§ASTã‚’å¤‰æ›´ã—ã¦ã€`@babel/generator`ã§ã‚³ãƒ¼ãƒ‰ã«æˆ»ã›ã‚‹ã€‚

> @babel/generator Â· Babel
> https://babeljs.io/docs/babel-generator

ã‚³ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¯¾å¿œã•ã‚Œã¦ã‚‹ã”æ§˜å­ã€‚

ã¡ãªã¿ã«ã€ã“ã†ã„ã†ç”¨é€”ã§ã¯`recast`ã‚‚å‰²ã¨ã‚ˆãèãæ°—ãŒã™ã‚‹ã€‚

> benjamn/recast: JavaScript syntax tree transformer, nondestructive pretty-printer, and automatic source map generator
> https://github.com/benjamn/recast

ãŸã ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ãƒ¼ã‚µãƒ¼ã¯`esprima`ãªã®ã§ã€æœ€æ–°ã®æ§‹æ–‡ã‚„TSã«å¯¾å¿œã™ã‚‹ãŸã‚ã«ã¯ã€çµå±€Babelã‚’æŒ‡å®šã—ã¦ä½¿ã†ã“ã¨ã«ãªã‚Šãã†ã€‚

### `@swc/core`

> https://github.com/swc-project/swc/blob/81fcd01680e8333154cbc1265d54d83b4b78eb02/packages/core/src/index.ts#L200

`printSync()`ã¨ã„ã†APIã¯ç¢ºã‹ã«å­˜åœ¨ã—ã¦ã¦ã€æ‰‹å…ƒã§ã¯ã‚³ãƒ¼ãƒ‰ã‚‚å‹•ã„ã¦ãŸã‘ã©ã€ãªãœã‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¼‰ã£ã¦ãªã„ã€‚

ã‚‚ã—ã‹ã—ãŸã‚‰éå…¬èªãªã®ã‹ã‚‚ã—ã‚Œãªã„ï¼Ÿ

> @swc/core
> https://swc.rs/docs/usage/core

ã‚ã¨ã€ã‚³ãƒ¡ãƒ³ãƒˆã¯å¯¾å¿œã—ã¦ãªã‹ã£ãŸã€‚

### `ts-morph`

TypeScriptæœ¬å®¶ã‚’ãã®ã¾ã¾ä½¿ã„ãŸã„äººã¯ãã†ãã†ã„ãªã„ã¨æ€ã†ã®ã§ã€`ts-morph`ã‚’è¦‹ã¦ãŠãã€‚

`project.createSourceFile()`ã—ã¦ã€TS ASTã‚’ã‚ˆã—ãªã«æ›´æ–°ã—ãŸã‚‰ã€`sourceFile.getFullText()`ã§ã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—ã«æˆ»ã›ã‚‹ã€‚

> ts-morph - Transforms
> https://ts-morph.com/manipulation/transforms

ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ã¡ã‚ƒã‚“ã¨å‡ºåŠ›ã•ã‚Œã¦ãŸã€‚

å•é¡Œã¯ã€ASTã‚’å¤‰æ›´ã™ã‚‹APIãŒè¤‡é›‘ãªã®ã¨ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ°—ã«ãªã‚‹ã¨ã“ã‚ã€‚

## (TS-)ESTree

æ¬¡ã«ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ é‡è¦–ãªã‚·ãƒªãƒ¼ã‚ºã€‚

### `escodegen`

> estools/escodegen: ECMAScript code generator
> https://github.com/estools/escodegen

2å¹´å‰ã§æ›´æ–°ãŒæ­¢ã¾ã£ã¦ã„ãŸãƒ»ãƒ»ãƒ»ï¼

JSXã‚µãƒãƒ¼ãƒˆã—ãŸforkã‚‚11å¹´å‰ã«ã€‚

> dary/escodegen-jsx: ECMAScript code generator with JSX
> https://github.com/dary/escodegen-jsx?utm_source=chatgpt.com

### `astring`

> davidbonnet/astring: ğŸŒ³ Tiny and fast JavaScript code generator from an ESTree-compliant AST.
> https://github.com/davidbonnet/astring

ã“ã‚Œã‚‚ã‚ˆãèãã‹ã‚‚ã€‚

ã‚³ãƒ¡ãƒ³ãƒˆã®å¯¾å¿œã¯ä¸€å¿œã‚ã‚‹ã‘ã©ã€ãã®ãŸã‚ã«ã¯`astravel`ã‚’ä½µç”¨ã—ãªã„ã¨ã„ã‘ãªã„ã¨ã®ã“ã¨ã€‚

> davidbonnet/astravel: ğŸ‘Ÿ Tiny and fast ESTree-compliant AST walker and modifier.
> https://github.com/davidbonnet/astravel#attachcomments

ã„ã‚ã‚†ã‚‹`danglingComments`ã¯ã‚ˆã—ãªã«é…ç½®ã•ã‚Œã¡ã‚ƒã†ã€‚

ã—ã‹ã—ã€TSã®å¯¾å¿œã¯ãªã„ã‚‰ã—ã„ã€‚

> Generating a typescript file Â· Issue #701 Â· davidbonnet/astring
> https://github.com/davidbonnet/astring/issues/701

æœ‰å¿—ã«ã‚ˆã‚‹TSã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã‚ã£ãŸã€‚

> vardario/astring-ts-generator
> https://github.com/vardario/astring-ts-generator

JSXã‚‚ã€å¤–éƒ¨ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§æ‹¡å¼µã—ãªã„ã¨ã„ã‘ãªã„ã€‚

> Qard/astring-jsx: ğŸ•µğŸ» A wrapper around https://www.npmjs.com/package/astring, adding JSX support
> https://github.com/Qard/astring-jsx

### `estree-util-to-js`

> syntax-tree/estree-util-to-js: estree (and esast) utility to serialize as JavaScript
> https://github.com/syntax-tree/estree-util-to-js

`unifiedjs`ãƒãƒ¼ãƒ ã®ã‚„ã¤ã§ã€ã“ã¡ã‚‰ã‚‚2å¹´å‰ã§æ­¢ã¾ã£ã¦ã‚‹ã€‚

å®Ÿè£…ã¨ã—ã¦ã¯`astring`ã«ä¾å­˜ã—ã¦ã¦ã€JSXã‚µãƒãƒ¼ãƒˆã‚‚å†…éƒ¨çš„ã«æŒã£ã¦ã‚‹ã€‚

ã‚³ãƒ¡ãƒ³ãƒˆã«é–¢ã—ã¦ã¯ã€åˆ¥ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒç”¨æ„ã•ã‚Œã¦ã‚‹ã€‚

> syntax-tree/estree-util-attach-comments: utility to attach comments to estree nodes
> https://github.com/syntax-tree/estree-util-attach-comments/tree/main

`astravel`ã®ãã‚Œã¨ã®é•ã„ã¯ã€`Comment`ã®ãƒ‡ãƒ¼ã‚¿ã®æŒã¡æ–¹ãŒé•ã†ã®ã¨ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚‚å¾®å¦™ã«é•ã†ã€‚

TSã®å¯¾å¿œã¯ãªã•ãã†ã€‚

### `esrap`

> sveltejs/esrap: Parse in reverse
> https://github.com/sveltejs/esrap

å®‰å¿ƒã¨ä¿¡é ¼ã®Svelteãƒãƒ¼ãƒ è£½ã®ã‚„ã¤ã€‚ï¼ˆå…ƒã€…ã¯å€‹äººã®æ–¹ãŒä½œã£ã¦ã¦ã€ãã‚Œã®æ›´æ–°åœæ­¢ã‚’æœŸã«æ´¾ç”Ÿã—ãŸã‚‰ã—ã„ï¼‰

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€`acorn`ã®ESTreeã¨ã€TS-ESTreeã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ã¨ã®ã“ã¨ã€‚

ãŸã ã€TS-ESTreeã¯`@typescript-eslint/typescript-estree`ç”±æ¥ã§ã¯ãªãã€å…ˆè¿°ã®`sveltejs/acorn-typescript`ã«ã‚ˆã‚‹ASTã‚‰ã—ã„ã®ã§ã€å…ˆè¿°ã®é€šã‚Šå¾®å¦™ã«å·®åˆ†ãŒã‚ã‚‹ã€‚

ãã—ã¦ã€

- JSXã«å¯¾å¿œã—ã¦ãªã„
- Stage3ã®ã‚ˆã†ãªæ–°ã—ã„ã‚‚ã®ã‚‚å¯¾å¿œã—ã¦ãªã•ãã†
- `a: string | null`ã®`TSNullKeyword`ã«ãªãœã‹å¯¾å¿œã—ã¦ãªã„
  - ä»–ã«ã‚‚ã„ã‚ã„ã‚å¯¾å¿œã—ã¦ãªã•ãã†

ã¨ã„ã†æƒœã—ã„æ„Ÿã˜ã ã£ãŸã€‚Svelteã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®å†…éƒ¨ç”¨é€”ã®ãŸã‚ã«ç”¨æ„ã•ã‚Œã¦ã¦ã€ãã“ã§ã¯ä»Šã®ã¨ã“ã‚å›°ã£ã¦ãªã„ã£ã¦ã“ã¨ã‹ãªï¼Ÿ

ã‚³ãƒ¡ãƒ³ãƒˆã®å¯¾å¿œã‚‚å®Ÿè£…ã¨ã—ã¦ã¯å…¥ã£ã¦ã‚‹ã‚ˆã†ã ã£ãŸã‘ã©ã€ã©ã†ã‚„ã‚‰è‡ªåˆ†ã§ä»»æ„ã®ASTãƒãƒ¼ãƒ‰ã«`leadingComments`ã¨`trailingComments`ã‚’å·®ã—è¾¼ã¾ãªã„ã¨ã„ã‘ãªã„ã‚ˆã†ã ã£ãŸã€‚

> https://github.com/sveltejs/esrap/blob/668872702d43a7542abbaeb20cac886f6988c35a/test/common.js#L14

ã–ã‚ãƒ»ãƒ»ãƒ»ã€‚

## ã‚„ã£ã±ã‚ŠPrettier

ğŸ‘» < å‘¼ã‚“ã ï¼Ÿ

ã¨ã„ã†ã‚ã‘ã§ã€ã¾ã‚ã‚„ã‚ŠãŸã„ã“ã¨ã¯Prettierã®ãã‚Œã‚ˆã­ãƒ»ãƒ»ãƒ»ã€‚

ã‚³ãƒ¡ãƒ³ãƒˆã¯ã©ã“ã¾ã§ã„ã£ã¦ã‚‚é¬¼é–€ã§ã‚ã‚Šã€å³å¯†ã«ã‚„ã‚ã†ã¨ã™ã‚Œã°ãã‚Œã¯ã‚‚ã†Prettierç›¸å½“ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã«ãªã‚‹ã£ã¦ã“ã¨ã€‚

ãã‚‚ãã‚‚TS-ESTreeã‚’ã„ã„æ„Ÿã˜ã«å‡ºåŠ›ã§ãã‚‹ã®ã‚‚ã€Prettierãã‚‰ã„ã—ã‹ãªã•ãã†ã€‚

> Is it possible to print the AST produced by typescript-estree? Â· typescript-eslint/typescript-eslint Â· Discussion #6377
> https://github.com/typescript-eslint/typescript-eslint/discussions/6377

ãŸã ä»Šå›ã®ç”¨é€”ã§Prettierã‚’ä½¿ã†ã¨ã™ã‚‹ã¨ã€`__debug.formatAST()`ã¨ã„ã†æ˜ã‚‰ã‹ã«æ°—ãŒå¼•ã‘ã‚‹APIã‚’ä½¿ã†ã®ãŒã¾ãš1ã¤ã€‚

```js
import { parseSync } from "oxc-parser";
import { __debug } from "prettier";

const { program, comments } = parseSync("a.tsx", CODE, {});
program.comments = comments;

// ...

const f = await __debug.formatAST(program, {
  ...options,
  originalText: CODE,
});
console.log(f.formatted);
```

ã“ã®ãƒ«ãƒ¼ãƒˆã¯ã€PrettierãŒå†…éƒ¨çš„ã«ã‚„ã£ã¦ã‚‹ASTã®ç²¾æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã¿ãŸã„ãªã‚‚ã®ã‚’é€šã‚‰ãªã„ã¯ãšãªã®ã§ã€ãã‚Œã¯ãã‚Œã§æ„å›³ã—ãªã„çµæœã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚

ã‚‚ã—ãã¯ã€ã‚«ã‚¹ã‚¿ãƒ ä½•ã‚‚ã—ãªã„ãƒ‘ãƒ¼ã‚µãƒ¼ã¨ã—ã¦ä½¿ã†ã€‚

```js
import { parseSync } from "oxc-parser";
import { format } from "prettier";

const { program, comments } = parseSync("a.tsx", CODE, {});
program.comments = comments;

// ...

const f = await format(CODE, {
  parser: "typescript",
  plugins: [
    {
      parsers: {
        typescript: {
          parse: () => program,
          astFormat: "estree",
          locStart: (n) => n.start,
          locEnd: (n) => n.end,
        },
      },
    },
  ],
});
```

æ­£æ”»æ³•ã ãŒå†—é•·ã€‚ã‘ã©ã€ã“ã‚ŒãŒä¸€ç•ªç¢ºå®Ÿã§å¦¥å½“ãªã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã§ãã‚‹ã¨ã„ã†ãƒ»ãƒ»ãƒ»ã€‚
ãŸã ã¾ã‚åˆ¥ã«Prettyã«ã—ã¦ã»ã—ã„ã‚ã‘ã§ã¯ãªã„ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚‚æ°—ã«ãªã‚‹ã—ã€ã¨ã„ã†æ‚©ã¿ã‚‚ã‚ã‚‹ã€‚

## ã¾ã¨ã‚

ã‚„ã¯ã‚Šã“ã†ã„ã†ä¸€é€£ã®æµã‚Œã‚’å®Œçµã•ã›ã‚‹ãŸã‚ã«ã¯ã€Babelã¿ãŸã„ãªä¸€è²«ã—ãŸãƒ„ãƒ¼ãƒ«ç¾¤ã‚’ä½¿ã†ã»ã†ãŒå®‰ç‰Œã«æ„Ÿã˜ã‚‹ã€‚

(TS-)ESTreeã¯ã€éƒ¨å“ã‚’å–ã£æ›¿ãˆå¼•ã£æ›¿ãˆã§ãã‚‹ã®ã¯ã„ã„ã“ã¨ã§ã¯ã‚ã‚Šã¤ã¤ã€ã‚ºãƒãƒªã§æ¬²ã—ã„ã‚‚ã®ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚‚ã‚ã‚‹ã€‚ã¾ãä½œã‚Œã°ã„ã„ã‚“ã‚„ã‘ã©ã‚‚ã€‚

å°‘ãªãã¨ã‚‚ç¾æ™‚ç‚¹ã§ã€TS-ESTree+JSXã«å¯¾å¿œã—ãŸã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ã€Prettierä»¥å¤–è¦‹ã¤ã‘ã‚‰ã‚Œãªã‹ã£ãŸã€‚

ã•ã¦ã€ãƒãƒ¼ãƒ OXCã¨ã—ã¦ã¯ã©ã†ã—ã‚ˆã†ã‹ãƒ»ãƒ»ãƒ»ã€‚

## 20251027: æ›´æ–°

`esrap`ã«å¯¾å¿œãŒå…¥ã£ã¦ã€ã¤ã„ã«`@typescript-eslint/typescript-estree`ã‚‚JSXã‚‚ãªã‚“ã§ã‚‚ã‚µãƒãƒ¼ãƒˆã«ã€‚

ç°¡æ˜“Prettierã¨ã—ã¦ã€å½“é¢ã®ç”¨é€”ã¨ã—ã¦ã¯ã“ã‚ŒãŒãŠã™ã™ã‚ã¨ã„ã†æ„Ÿã˜ã€‚

> fix: support more typescript nodes by manuel3108 Â· Pull Request #70 Â· sveltejs/esrap
> https://github.com/sveltejs/esrap/pull/70
